<!-- Floating Chat Widget -->
<div class="chat-widget-container">
  <!-- Toggle Button -->
  <button 
    class="chat-toggle-button" 
    (click)="toggleChat()"
    *ngIf="!isOpen"
    nz-tooltip
    nzTooltipTitle="{{ 'agent.title' | translate }}"
    nzTooltipPlacement="left">
    <span aria-hidden="true">ğŸ¤–</span>
  </button>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="isOpen">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <h3>ğŸ¤– {{ 'agent.title' | translate }}</h3>
        <p class="user-greeting">{{ getCurrentUserName() }}</p>
      </div>
      <div class="header-actions">
        <button 
          class="minimize-btn" 
          (click)="minimizeChat()"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.minimize' | translate }}">
          <span aria-hidden="true">â€“</span>
        </button>
        <button 
          class="close-btn" 
          (click)="closeChat()"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.close' | translate }}">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body">
      <!-- Messages -->
      <div class="messages-container">
        <div 
          *ngFor="let message of messages" 
          class="message"
          [attr.data-message-id]="message.id"
          [attr.data-message-type]="message.type"
          [ngClass]="{'user-message': message.role === 'user', 'assistant-message': message.role === 'assistant'}">
          
          <!-- Text Messages -->
          <div *ngIf="message.type === 'text'" [innerHTML]="formatMessage(message.content)"></div>

          <!-- Actions (Quick Buttons) -->
          <ng-container *ngIf="message.type === 'actions'">
            <div class="action-buttons">
              <div class="action-title" [innerHTML]="formatMessage(message.content)"></div>
              <button 
                *ngFor="let btn of message.data?.buttons" 
                class="action-btn"
                (click)="onButtonClick(btn.action, btn.data)"
                [innerHTML]="btn.text">
              </button>
            </div>
          </ng-container>
          
          <!-- Confirmation Messages -->
          <div *ngIf="message.type === 'confirmation'" class="confirmation-message">
            <ng-container *ngIf="message.data?.component === 'review'; else legacyConfirmation">
              <app-data-entry-review-message
                [extractedData]="message.data?.extractedData"
                [fields]="message.data?.fields">
              </app-data-entry-review-message>
            </ng-container>
            <ng-template #legacyConfirmation>
              <div [innerHTML]="formatMessage(message.content)"></div>
            </ng-template>
            <div class="modern-action-buttons" *ngIf="message.data?.buttons">
              <button *ngFor="let button of message.data?.buttons"
                      class="modern-btn"
                      [ngClass]="button.className"
                      (click)="onButtonClick(button.action, button.data)">
                <span>{{ button.text }}</span>
              </button>
            </div>
          </div>
          
          <!-- Loading Messages -->
          <div *ngIf="message.type === 'loading'" class="loading-message">
            <i nz-icon nzType="loading" nzTheme="outline"></i>
            {{ message.content }}
          </div>
          
          <!-- Progress Messages -->
          <div *ngIf="message.type === 'progress'" class="progress-message">
            <nz-progress [nzPercent]="extractionProgress" [nzShowInfo]="false"></nz-progress>
            <p>{{ message.content }}</p>
          </div>
          
          <!-- Dropdown Messages -->
          <div *ngIf="message.type === 'dropdown'" class="dropdown-message">
            <p class="dropdown-label">{{ message.content }}</p>
            <nz-select 
              [nzPlaceHolder]="'Ø§Ø®ØªØ± ' + (message.data.fieldLabel || message.data.label || message.data.field)"
              (ngModelChange)="onDropdownSelection(message.data.field, $event)"
              style="width: 100%;">
              <nz-option 
                *ngFor="let option of message.data.options" 
                [nzValue]="option.value || option" 
                [nzLabel]="option.label || option">
              </nz-option>
            </nz-select>
          </div>
          
          <!-- Contact Form Messages -->
          <div *ngIf="message.type === 'contact-form'" class="contact-form-message">
            <p>{{ message.content }}</p>
            <button 
              nz-button 
              nzType="primary" 
              (click)="openContactForm()">
              <i nz-icon nzType="user-add" nzTheme="outline"></i>
              Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
            </button>
          </div>
        </div>
      </div>

      <!-- Accumulated Files Panel -->
      <div class="accumulated-files-panel" *ngIf="showAccumulatedFiles">
        <div class="panel-header">
          <h4>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© / Selected Files</h4>
          <button nz-button nzType="text" nzSize="small" (click)="clearAccumulatedFiles()">
            <i nz-icon nzType="delete" nzTheme="outline"></i>
          </button>
        </div>
        <div class="files-list">
          <div *ngFor="let file of accumulatedFiles; let i = index" class="accumulated-file-card">
            <div class="file-info">
              <span class="file-name">{{ file.name }}</span>
              <span class="file-size">{{ (file.size / 1024).toFixed(2) }}KB</span>
              <span class="detected-type">ğŸ” {{ detectDocumentType(file.name) }}</span>
            </div>
            <button nz-button nzType="text" nzSize="small" (click)="removeAccumulatedFile(i)" class="remove-btn">
              <i nz-icon nzType="close" nzTheme="outline"></i>
            </button>
          </div>
        </div>
        <div class="panel-footer">
          <button nz-button nzType="default" (click)="clearAccumulatedFiles()">
            Ø¥Ù„ØºØ§Ø¡ / Cancel
          </button>
          <button nz-button nzType="dashed" (click)="triggerFileUpload()">
            <i nz-icon nzType="plus"></i>
            Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰ / Add More Files
          </button>
          <button nz-button nzType="primary" (click)="proceedWithAccumulatedFiles()">
            Ù…ØªØ§Ø¨Ø¹Ø© / Continue ({{ accumulatedFiles.length }})
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Footer -->
    <div class="chat-footer">
      <!-- Inline fallback quick actions if message rendering fails -->
      <div class="inline-quick-actions" *ngIf="showInlineQuickActions">
        <button class="action-btn" (click)="onButtonClick('upload')">{{ 'agent.uploadDocument' | translate }}</button>
        <button class="action-btn" (click)="onButtonClick('manual')">{{ 'agent.manualEntry' | translate }}</button>
        <button class="action-btn" (click)="onButtonClick('help')">{{ 'agent.help' | translate }}</button>
      </div>
      
      <!-- Debug info for inline actions -->
      <div *ngIf="showInlineQuickActions" style="font-size: 10px; color: #666; margin-bottom: 5px;">
        Debug: Inline quick actions enabled ({{ showInlineQuickActions }})
      </div>
      <div class="input-container">
        
        <button 
          class="attach-btn" 
          (click)="onButtonClick('upload')"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.uploadDocument' | translate }}"
          nzTooltipPlacement="top">
          <span aria-hidden="true">ğŸ“</span>
          <span *ngIf="accumulatedFiles.length > 0" class="file-count">{{ accumulatedFiles.length }}</span>
        </button>
        
        <input 
          id="chat-message-input"
          name="chat-message-input"
          type="text" 
          [(ngModel)]="newMessage" 
          (keydown)="onEnterKey($event)"
          placeholder="{{ 'agent.inputPlaceholder' | translate }}"
          [disabled]="loading">
        
        <button 
          class="send-btn" 
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || loading"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.send' | translate }}"
          nzTooltipPlacement="top">
          <span aria-hidden="true">â¤</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Upload Modal Template -->
<ng-template #documentModalTemplate>
  <div class="document-modal-content">
    <!-- File Upload Section -->
    <div class="file-upload-section">
      <h4>ğŸ“ {{ 'agent.documentModal.uploadHeader' | translate }}</h4>
      <div class="upload-area" (click)="triggerFileUpload()" (dragover)="onDragOver($event)" (drop)="onFileDrop($event)">
        <div class="upload-content">
          <span class="upload-icon">ğŸ“</span>
          <p>{{ 'agent.documentModal.clickToUpload' | translate }}</p>
          <input 
            type="file" 
            #fileInput
            multiple 
            accept="image/*" 
            (change)="onModalFileSelected($event)"
            style="display: none">
        </div>
      </div>
      
      <!-- Selected Files Preview -->
      <div *ngIf="pendingFiles.length > 0" class="selected-files">
        <h5>{{ 'agent.documentModal.selectedFiles' | translate }} ({{ pendingFiles.length }})</h5>
        <div class="files-list">
          <div *ngFor="let file of pendingFiles; let i = index" class="file-item">
            <span class="file-name">{{ file.name }}</span>
            <span class="file-size">({{ (file.size / 1024).toFixed(1) }}KB)</span>
            <button type="button" class="remove-file-btn" (click)="removePendingFile(i)">Ã—</button>
          </div>
        </div>
      </div>
    </div>
    
    <form [formGroup]="documentMetadataForm" *ngIf="pendingFiles.length > 0">
      <div formArrayName="documents">
        <!-- Show message if no documents -->
        <div *ngIf="documentsFA.length === 0" style="text-align: center; padding: 20px; color: #666;">
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ / No documents to display</p>
          <p>pendingFiles: {{ pendingFiles.length }}</p>
        </div>
        
        <div 
          *ngFor="let docGroup of documentsFA.controls; let i = index" 
          [formGroupName]="i" 
          class="document-form">
          
          <nz-card [nzTitle]="'Ù…Ø³ØªÙ†Ø¯ ' + (i + 1)" nzSize="small">
            <div class="form-row">
              <div class="form-group">
                <label [for]="'fileName_' + i">{{ 'agent.documentModal.fileName' | translate }}:</label>
                <input 
                  [id]="'fileName_' + i"
                  [name]="'fileName_' + i"
                  formControlName="name" 
                  readonly
                  aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù / File Name">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label [for]="'country_' + i">{{ 'agent.documentModal.country' | translate }}:</label>
                <nz-select 
                  [id]="'country_' + i"
                  formControlName="country" 
                  (ngModelChange)="onCountryChange($event, i)"
                  aria-label="Ø§Ù„Ø¨Ù„Ø¯ / Country">
                  <nz-option 
                    *ngFor="let country of countriesList" 
                    [nzValue]="country" 
                    [nzLabel]="country">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="form-group">
                <label [for]="'documentType_' + i">{{ 'agent.documentModal.documentType' | translate }}:</label>
                <nz-select 
                  [id]="'documentType_' + i"
                  formControlName="type"
                  aria-label="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ / Document Type">
                  <nz-option 
                    *ngFor="let type of getDocumentTypesByCountry(docGroup.get('country')?.value || '')" 
                    [nzValue]="type" 
                    [nzLabel]="type">
                  </nz-option>
                </nz-select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label [for]="'description_' + i">{{ 'agent.documentModal.description' | translate }}:</label>
                <textarea 
                  [id]="'description_' + i"
                  [name]="'description_' + i"
                  formControlName="description" 
                  rows="2"
                  aria-label="Ø§Ù„ÙˆØµÙ / Description"></textarea>
              </div>
            </div>
          </nz-card>
        </div>
      </div>
    </form>
  
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="closeDocumentModal()">
      {{ 'agent.documentModal.cancel' | translate }}
    </button>
    <button nz-button nzType="primary" (click)="saveDocuments()" [disabled]="!isDocumentFormValid">
      {{ 'agent.documentModal.saveAndContinue' | translate }}
    </button>
  </div>
  </div>
</ng-template>


<!-- Contact Form Modal -->
<nz-modal 
  [(nzVisible)]="showContactForm" 
  nzTitle="Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ / Add Contact"
  (nzOnCancel)="closeContactForm()"
  [nzFooter]="null"
  nzWidth="600px">
  
  <div *nzModalContent>
    <form *ngIf="contactForm" [formGroup]="contactForm">
    <div class="contact-form-content">
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ø§Ø³Ù… / Name: *</label>
          <input formControlName="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ / Job Title: *</label>
          <input formControlName="jobTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Email: *</label>
          <input formControlName="email" type="email" placeholder="example@company.com">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø¬ÙˆØ§Ù„ / Mobile: *</label>
          <input formControlName="mobile" placeholder="+966501234567">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø±Ø¶ÙŠ / Landline:</label>
          <input formControlName="landline" placeholder="+966112345678">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙØ¶Ù„Ø© / Preferred Language:</label>
          <nz-select formControlName="preferredLanguage">
            <nz-option nzValue="Arabic" nzLabel="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"></nz-option>
            <nz-option nzValue="English" nzLabel="English"></nz-option>
          </nz-select>
        </div>
      </div>
    </div>
  
    <!-- âœ… Footer buttons -->
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="closeContactForm()">
      Ø¥Ù„ØºØ§Ø¡ / Cancel
    </button>
    <button nz-button nzType="primary" (click)="saveContactForm()" [disabled]="!contactForm.valid">
      Ø­ÙØ¸ / Save
    </button>
    </div>
  </form>
  </div>
</nz-modal>

<!-- Edit Form Modal -->
<nz-modal 
  [(nzVisible)]="showEditForm" 
  nzTitle="{{ 'agent.editForm.title' | translate }}"
  (nzOnCancel)="closeEditForm()"
  [nzFooter]="null"
  nzWidth="700px"
  [nzMaskClosable]="false"
  [nzClosable]="true">
  
  <!-- âœ… ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ *ngIf ØµØ­ -->
  <div *nzModalContent>
    <form *ngIf="editForm && currentExtractedFields.length > 0" [formGroup]="editForm">
      <div class="edit-form-content">
        
        <!-- âœ… Dynamic form fields based on extracted data -->
        <div class="form-section">
          <h4>{{ 'agent.editForm.sectionTitle' | translate }}</h4>
          <p class="section-description">
            {{ 'agent.editForm.description' | translate:{ count: currentExtractedFields.length } }}
          </p>
          
          <!-- Dynamic form fields -->
          <div class="dynamic-fields-grid">
            <div class="form-group" *ngFor="let field of currentExtractedFields; let i = index" 
                 [ngClass]="{'full-width': shouldBeFullWidth(field)}">
              
              <!-- Text inputs -->
              <ng-container *ngIf="isTextInput(field)">
                <label>{{getFieldLabel(field)}}:</label>
                <input [formControlName]="field" [placeholder]="getFieldPlaceholder(field)">
              </ng-container>
              
              <!-- Select inputs -->
              <ng-container *ngIf="isSelectInput(field)">
                <label>{{getFieldLabel(field)}}:</label>
                <nz-select [formControlName]="field">
                  <nz-option *ngFor="let option of getSelectOptions(field)" 
                            [nzValue]="option.value" [nzLabel]="option.label">
                  </nz-option>
                </nz-select>
              </ng-container>
            </div>
          </div>
        </div>
        
      </div>
    </form>
    
    <!-- âœ… Footer buttons -->
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeEditForm()">
        {{ 'agent.editForm.cancel' | translate }}
      </button>
      <button nz-button nzType="primary" (click)="saveEditForm()">
        {{ 'agent.editForm.saveChanges' | translate }}
      </button>
    </div>
  </div>
</nz-modal>

<!-- Missing Fields Form Modal -->
<nz-modal 
  [(nzVisible)]="showMissingFieldsForm" 
  nzTitle="{{ 'agent.missingForm.title' | translate }}"
  (nzOnCancel)="closeMissingFieldsForm()"
  [nzFooter]="null"
  nzWidth="700px"
  [nzMaskClosable]="false"
  [nzClosable]="true">
  
  <div *nzModalContent>
    <!-- âœ… Header with clear instructions -->
    <div class="missing-fields-header">
      <div class="instructions">
        <h3>ğŸ“ {{ 'agent.missingForm.headerTitle' | translate }}</h3>
        <p>{{ 'agent.missingForm.prefilledNote' | translate }}</p>
      </div>
      <div class="field-status">
        <div class="status-item completed">
          <span class="icon">âœ…</span>
          <span class="text">{{ 'agent.missingForm.completed' | translate }}</span>
        </div>
        <div class="status-item missing">
          <span class="icon">âŒ</span>
          <span class="text">{{ 'agent.missingForm.missing' | translate }}</span>
        </div>
      </div>
    </div>
    
    <form *ngIf="missingFieldsForm" [formGroup]="missingFieldsForm">
      <div class="edit-form-content">
        
        <!-- âœ… MISSING FIELDS ONLY - Priority Section -->
        <div class="form-section missing-fields-section" *ngIf="currentMissingFields.length > 0">
          <h4>ğŸ”´ {{ 'agent.missingForm.requiredSectionTitle' | translate }}</h4>
          <p class="section-description">{{ 'agent.missingForm.requiredInstructions' | translate }}</p>
          
          <!-- Missing Company Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['firstName', 'firstNameAR', 'tax', 'CustomerType', 'ownerName'])">
            <h5>{{ 'agent.missingForm.companyInfo' | translate }}</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('firstName')">
                <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) / Company Name (English): <span class="required">*</span></label>
                <input formControlName="firstName" placeholder="Company Name">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('firstNameAR')">
                <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¹Ø±Ø¨ÙŠ) / Company Name (Arabic): <span class="required">*</span></label>
                <input formControlName="firstNameAR" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('tax')">
                <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ / Tax Number: <span class="required">*</span></label>
                <input formControlName="tax" placeholder="Tax Number">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('CustomerType')">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ / Customer Type: <span class="required">*</span></label>
                <nz-select formControlName="CustomerType">
                  <nz-option nzValue="Corporate" nzLabel="Corporate"></nz-option>
                  <nz-option nzValue="SME" nzLabel="SME"></nz-option>
                  <nz-option nzValue="Individual" nzLabel="Individual"></nz-option>
                </nz-select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('ownerName')">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ / Owner Name:</label>
                <input formControlName="ownerName" placeholder="Owner Name">
              </div>
            </div>
          </div>

          <!-- Missing Address Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['buildingNumber', 'street', 'country', 'city'])">
            <h5>{{ 'agent.missingForm.addressInfo' | translate }}</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('buildingNumber')">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰ / Building Number:</label>
                <input formControlName="buildingNumber" placeholder="Building Number">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('street')">
                <label>Ø§Ù„Ø´Ø§Ø±Ø¹ / Street:</label>
                <input formControlName="street" placeholder="Street Address">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('country')">
                <label>Ø§Ù„Ø¯ÙˆÙ„Ø© / Country: <span class="required">*</span></label>
                <nz-select formControlName="country">
                  <nz-option nzValue="Egypt" nzLabel="Egypt"></nz-option>
                  <nz-option nzValue="Saudi Arabia" nzLabel="Saudi Arabia"></nz-option>
                  <nz-option nzValue="United Arab Emirates" nzLabel="United Arab Emirates"></nz-option>
                  <nz-option nzValue="Yemen" nzLabel="Yemen"></nz-option>
                </nz-select>
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('city')">
                <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / City:</label>
                <input formControlName="city" placeholder="City">
              </div>
            </div>
          </div>

          <!-- Missing Sales Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['salesOrganization', 'distributionChannel', 'division'])">
            <h5>{{ 'agent.missingForm.salesInfo' | translate }}</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('salesOrganization')">
                <label>Ù…Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª / Sales Organization: <span class="required">*</span></label>
                <nz-select formControlName="salesOrganization">
                  <nz-option nzValue="egypt_cairo_office" nzLabel="Egypt - Cairo Head Office"></nz-option>
                  <nz-option nzValue="egypt_alexandria_branch" nzLabel="Egypt - Alexandria Branch"></nz-option>
                  <nz-option nzValue="egypt_giza_branch" nzLabel="Egypt - Giza Branch"></nz-option>
                  <nz-option nzValue="ksa_riyadh_office" nzLabel="Saudi Arabia - Riyadh Office"></nz-option>
                  <nz-option nzValue="ksa_jeddah_branch" nzLabel="Saudi Arabia - Jeddah Branch"></nz-option>
                </nz-select>
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('distributionChannel')">
                <label>Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ / Distribution Channel: <span class="required">*</span></label>
                <nz-select formControlName="distributionChannel">
                  <nz-option nzValue="direct_sales" nzLabel="Direct Sales"></nz-option>
                  <nz-option nzValue="authorized_distributors" nzLabel="Authorized Distributors"></nz-option>
                  <nz-option nzValue="retail_chains" nzLabel="Retail Chains"></nz-option>
                </nz-select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('division')">
                <label>Ø§Ù„Ù‚Ø³Ù… / Division: <span class="required">*</span></label>
                <nz-select formControlName="division">
                  <nz-option nzValue="food_products" nzLabel="Food Products Division"></nz-option>
                  <nz-option nzValue="beverages" nzLabel="Beverages Division"></nz-option>
                  <nz-option nzValue="household_items" nzLabel="Household Items Division"></nz-option>
                </nz-select>
              </div>
            </div>
          </div>
        </div>

        <!-- âœ… COMPLETED FIELDS - Reference Section -->
        <div class="form-section completed-fields-section" *ngIf="getCompletedFields().length > 0">
          <h4>âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© / Completed Fields</h4>
          <p class="section-description">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ù„Ù„Ù…Ø±Ø¬Ø¹ ÙÙ‚Ø·) / The following data was extracted from documents (for reference only):</p>
          
          <div class="completed-fields-grid">
            <div class="completed-field" *ngFor="let field of getCompletedFields()">
              <div class="field-label">{{ getFieldLabel(field) }}</div>
              <div class="field-value">{{ getFieldValue(field) }}</div>
            </div>
          </div>
        </div>
      </div>
    </form>
    
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeMissingFieldsForm()">
        {{ 'agent.missingForm.cancel' | translate }}
      </button>
      <button nz-button nzType="primary" (click)="saveMissingFieldsForm()">
        {{ 'agent.missingForm.save' | translate }}
      </button>
    </div>
  </div>
</nz-modal>

<!-- Unified Review & Complete Modal -->
<nz-modal 
  [(nzVisible)]="showUnifiedModal" 
  nzTitle="ğŸ“ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª / Review & Complete Data"
  (nzOnCancel)="showUnifiedModal = false"
  [nzFooter]="null"
  nzWidth="1000px"
  [nzMaskClosable]="false"
  [nzClosable]="true"
  [nzBodyStyle]="{'padding': '0'}">
  
  <div *nzModalContent>
    <form *ngIf="unifiedModalForm" [formGroup]="unifiedModalForm">
      <div class="modal-section-header" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #f0f0f0;">
        <h3 style="margin:0;">ğŸ“ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª / Review & Complete Data</h3>
        <div class="header-actions">
          <button type="button" nz-button nzType="dashed" (click)="fillWithDemoData()">
            <i nz-icon nzType="experiment"></i>
            Demo Fill
          </button>
          <span class="demo-info">{{ getRemainingDemoCompanies() }} companies remaining</span>
        </div>
      </div>
      
      <!-- Section 1: Extracted Data -->
      <div class="modal-section extracted-section" *ngIf="unifiedModalData.extractedFields.length > 0">
        <div class="section-header">
          <h3>âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© / Extracted Data</h3>
          <button type="button" 
                  nz-button 
                  [nzType]="extractedDataReadOnly ? 'default' : 'primary'"
                  nzSize="small"
                  (click)="toggleExtractedDataEdit(extractedDataReadOnly)">
            <span nz-icon [nzType]="extractedDataReadOnly ? 'edit' : 'save'"></span>
            {{ extractedDataReadOnly ? 'ØªØ¹Ø¯ÙŠÙ„ / Edit' : 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª / Save Changes' }}
          </button>
        </div>
        
        <div class="form-grid">
          <!-- Company Information -->
          <div class="form-row" *ngIf="isFieldExtracted('firstName') || isFieldExtracted('firstNameAR')">
            <div class="form-group" *ngIf="isFieldExtracted('firstName')">
              <label>Company Name (English):</label>
              <input formControlName="firstName">
            </div>
            <div class="form-group" *ngIf="isFieldExtracted('firstNameAR')">
              <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¹Ø±Ø¨ÙŠ):</label>
              <input formControlName="firstNameAR">
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldExtracted('tax') || isFieldExtracted('CustomerType')">
            <div class="form-group" *ngIf="isFieldExtracted('tax')">
              <label>Tax Number:</label>
              <input formControlName="tax">
            </div>
            <div class="form-group" *ngIf="isFieldExtracted('CustomerType')">
              <label>Customer Type:</label>
              <nz-select formControlName="CustomerType">
                <nz-option *ngFor="let option of customerTypeOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldExtracted('ownerName')">
            <div class="form-group full-width">
              <label>Owner Name:</label>
              <input formControlName="ownerName">
            </div>
          </div>
          
          <!-- Address Information -->
          <div class="form-row" *ngIf="isFieldExtracted('buildingNumber') || isFieldExtracted('street')">
            <div class="form-group" *ngIf="isFieldExtracted('buildingNumber')">
              <label>Building Number:</label>
              <input formControlName="buildingNumber">
            </div>
            <div class="form-group" *ngIf="isFieldExtracted('street')">
              <label>Street:</label>
              <input formControlName="street">
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldExtracted('country') || isFieldExtracted('city')">
            <div class="form-group" *ngIf="isFieldExtracted('country')">
              <label>Country:</label>
              <nz-select formControlName="country">
                <nz-option *ngFor="let option of countryOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
            <div class="form-group" *ngIf="isFieldExtracted('city')">
              <label>City:</label>
              <nz-select formControlName="city">
                <nz-option *ngFor="let option of cityOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
          
          <!-- Sales Information -->
          <div class="form-row" *ngIf="isFieldExtracted('salesOrganization') || isFieldExtracted('distributionChannel')">
            <div class="form-group" *ngIf="isFieldExtracted('salesOrganization')">
              <label>Sales Organization:</label>
              <nz-select formControlName="salesOrganization">
                <nz-option *ngFor="let option of salesOrgOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
            <div class="form-group" *ngIf="isFieldExtracted('distributionChannel')">
              <label>Distribution Channel:</label>
              <nz-select formControlName="distributionChannel">
                <nz-option *ngFor="let option of distributionChannelOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldExtracted('division')">
            <div class="form-group">
              <label>Division:</label>
              <nz-select formControlName="division">
                <nz-option *ngFor="let option of divisionOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Section 2: Missing Data -->
      <div class="modal-section missing-section" *ngIf="unifiedModalData.missingFields.length > 0">
        <div class="section-header">
          <h3>âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© / Missing Data</h3>
          <span class="missing-count">{{ unifiedModalData.missingFields.length }} Ø­Ù‚ÙˆÙ„ / fields</span>
        </div>
        
        <div class="form-grid">
          <!-- Company Information -->
          <div class="form-row" *ngIf="isFieldMissing('firstName') || isFieldMissing('firstNameAR')">
            <div class="form-group" *ngIf="isFieldMissing('firstName')">
              <label class="required">Company Name (English):</label>
              <input formControlName="firstName" placeholder="Enter company name in English">
            </div>
            <div class="form-group" *ngIf="isFieldMissing('firstNameAR')">
              <label class="required">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¹Ø±Ø¨ÙŠ):</label>
              <input formControlName="firstNameAR" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldMissing('tax') || isFieldMissing('CustomerType')">
            <div class="form-group" *ngIf="isFieldMissing('tax')">
              <label class="required">Tax Number:</label>
              <input formControlName="tax" placeholder="Enter tax registration number">
            </div>
            <div class="form-group" *ngIf="isFieldMissing('CustomerType')">
              <label class="required">Customer Type:</label>
              <nz-select formControlName="CustomerType" nzPlaceHolder="Select customer type">
                <nz-option *ngFor="let option of customerTypeOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldMissing('ownerName')">
            <div class="form-group full-width">
              <label class="required">Owner Name:</label>
              <input formControlName="ownerName" placeholder="Enter company owner full name">
            </div>
          </div>
          
          <!-- Address Information -->
          <div class="form-row" *ngIf="isFieldMissing('buildingNumber') || isFieldMissing('street')">
            <div class="form-group" *ngIf="isFieldMissing('buildingNumber')">
              <label class="required">Building Number:</label>
              <input formControlName="buildingNumber" placeholder="Enter building number">
            </div>
            <div class="form-group" *ngIf="isFieldMissing('street')">
              <label class="required">Street:</label>
              <input formControlName="street" placeholder="Enter street name">
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldMissing('country') || isFieldMissing('city')">
            <div class="form-group" *ngIf="isFieldMissing('country')">
              <label class="required">Country:</label>
              <nz-select formControlName="country" nzPlaceHolder="Select country">
                <nz-option *ngFor="let option of countryOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
            <div class="form-group" *ngIf="isFieldMissing('city')">
              <label class="required">City:</label>
              <nz-select formControlName="city" nzPlaceHolder="Select city">
                <nz-option *ngFor="let option of cityOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
          
          <!-- Sales Information -->
          <div class="form-row" *ngIf="isFieldMissing('salesOrganization') || isFieldMissing('distributionChannel')">
            <div class="form-group" *ngIf="isFieldMissing('salesOrganization')">
              <label class="required">Sales Organization:</label>
              <nz-select formControlName="salesOrganization" nzPlaceHolder="Select sales organization">
                <nz-option *ngFor="let option of salesOrgOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
            <div class="form-group" *ngIf="isFieldMissing('distributionChannel')">
              <label class="required">Distribution Channel:</label>
              <nz-select formControlName="distributionChannel" nzPlaceHolder="Select distribution channel">
                <nz-option *ngFor="let option of distributionChannelOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
          
          <div class="form-row" *ngIf="isFieldMissing('division')">
            <div class="form-group">
              <label class="required">Division:</label>
              <nz-select formControlName="division" nzPlaceHolder="Select division">
                <nz-option *ngFor="let option of divisionOptions" 
                          [nzValue]="option.value" 
                          [nzLabel]="option.label">
                </nz-option>
              </nz-select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Section 3: Documents -->
      <div class="modal-section documents-section">
        <div class="section-header">
          <h3>ğŸ“„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© / Uploaded Documents</h3>
          <button type="button" 
                  nz-button 
                  nzType="default"
                  nzSize="small"
                  (click)="triggerDocumentReplacement()"
                  [disabled]="isReprocessingDocuments">
            <span nz-icon nzType="upload"></span>
            Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª / Replace Documents
          </button>
        </div>
        <input type="file" id="unifiedFileInput" multiple accept="image/*,.pdf" (change)="onUnifiedDocumentSelected($event)" style="display: none;">
        <div *ngIf="isReprocessingDocuments" class="reprocessing-indicator">
          <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
          <p>Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¨ØªÙ‚Ù†ÙŠØ© OCR...</p>
          <p>Reprocessing documents with OCR...</p>
        </div>
        <div class="documents-list" *ngIf="!isReprocessingDocuments">
          <div class="document-item" *ngFor="let doc of unifiedModalDocuments; let i = index">
            <div class="document-info">
              <span nz-icon nzType="file-pdf" *ngIf="doc.type?.includes('pdf')"></span>
              <span nz-icon nzType="file-image" *ngIf="doc.type?.includes('image')"></span>
              <span nz-icon nzType="file" *ngIf="!doc.type?.includes('pdf') && !doc.type?.includes('image')"></span>
              <span class="document-name">{{ doc.name }}</span>
              <span class="document-size">{{ (doc.size / 1024).toFixed(2) }} KB</span>
            </div>
            <button type="button" nz-button nzType="text" nzDanger nzSize="small" (click)="removeDocumentFromUnified(i)">
              <span nz-icon nzType="delete"></span>
            </button>
          </div>
          <div *ngIf="unifiedModalDocuments.length === 0" class="no-documents">
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø±ÙÙˆØ¹Ø© / No documents uploaded</p>
          </div>
        </div>
      </div>

      <!-- Section 4: Contacts -->
      <div class="modal-section contacts-section">
        <div class="section-header">
          <h3>ğŸ‘¥ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) / Contacts (Optional)</h3>
          <button type="button" 
                  nz-button 
                  nzType="primary" 
                  nzSize="small" 
                  (click)="addContactToUnifiedForm()">
            <span nz-icon nzType="plus"></span> Add Contact
          </button>
        </div>
        
        <div formArrayName="contacts" class="contacts-grid">
          <div *ngFor="let contact of unifiedContactsArray.controls; let i = index" 
               [formGroupName]="i" 
               class="contact-card">
            
            <div class="contact-header">
              <h4>Contact {{ i + 1 }}</h4>
              <button type="button" 
                      *ngIf="unifiedContactsArray.length > 1"
                      nz-button 
                      nzType="text" 
                      nzDanger 
                      nzSize="small"
                      (click)="removeContactFromUnifiedForm(i)">
                <span nz-icon nzType="delete"></span>
              </button>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="required">Name:</label>
                <input formControlName="name" placeholder="Full name">
              </div>
              <div class="form-group">
                <label class="required">Job Title:</label>
                <input formControlName="jobTitle" placeholder="Job position">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="required">Email:</label>
                <input formControlName="email" type="email" placeholder="email@company.com">
              </div>
              <div class="form-group">
                <label class="required">Mobile:</label>
                <input formControlName="mobile" placeholder="+201234567890">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Landline:</label>
                <input formControlName="landline" placeholder="Optional">
              </div>
              <div class="form-group">
                <label class="required">Language:</label>
                <nz-select formControlName="preferredLanguage">
                  <nz-option nzValue="Arabic" nzLabel="Arabic"></nz-option>
                  <nz-option nzValue="English" nzLabel="English"></nz-option>
                </nz-select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="contacts-hint" *ngIf="unifiedContactsArray.length === 0">
          <span nz-icon nzType="info-circle" nzTheme="outline" style="color: #1890ff;"></span>
          Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© / Contacts are optional
        </div>
      </div>
      
    </form>
    
    <!-- Modal Footer -->
    <div class="modal-footer unified-footer">
      <div class="footer-info">
        <span class="info-item extracted" *ngIf="unifiedModalData.extractedFields.length > 0">
          âœ… {{ unifiedModalData.extractedFields.length }} extracted
        </span>
        <span class="info-item missing" *ngIf="unifiedModalData.missingFields.length > 0">
          âš ï¸ {{ unifiedModalData.missingFields.length }} missing
        </span>
        <span class="info-item contacts">
          ğŸ‘¥ {{ unifiedContactsArray.length }} contacts
        </span>
</div>
      
      <div class="footer-actions">
        <button nz-button nzType="default" (click)="showUnifiedModal = false">
          Ø¥Ù„ØºØ§Ø¡ / Cancel
        </button>
        <button nz-button 
                nzType="primary" 
                (click)="saveUnifiedModal()"
                [disabled]="unifiedModalForm.invalid || unifiedContactsArray.length === 0">
          <span nz-icon nzType="save"></span>
          Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ / Save & Submit
        </button>
      </div>
    </div>

    
  </div>
</nz-modal>


<!-- Floating Chat Widget -->
<div class="chat-widget-container">
  <!-- Toggle Button -->
  <button 
    class="chat-toggle-button" 
    (click)="toggleChat()"
    *ngIf="!isOpen"
    nz-tooltip
    nzTooltipTitle="Data Entry AI Assistant"
    nzTooltipPlacement="left">
    <span aria-hidden="true">🤖</span>
  </button>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="isOpen">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <h3>🤖 Data Entry AI Assistant</h3>
        <p class="user-greeting">{{ getCurrentUserName() }}</p>
      </div>
      <div class="header-actions">
        <button 
          class="minimize-btn" 
          (click)="minimizeChat()"
          nz-tooltip
          nzTooltipTitle="Minimize">
          <span aria-hidden="true">–</span>
        </button>
        <button 
          class="close-btn" 
          (click)="closeChat()"
          nz-tooltip
          nzTooltipTitle="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body">
      <!-- Messages -->
      <div class="messages-container">
        <div 
          *ngFor="let message of messages" 
          class="message"
          [attr.data-message-id]="message.id"
          [attr.data-message-type]="message.type"
          [ngClass]="{'user-message': message.role === 'user', 'assistant-message': message.role === 'assistant'}">
          
          <!-- Text Messages -->
          <div *ngIf="message.type === 'text'" [innerHTML]="formatMessage(message.content)"></div>

          <!-- Actions (Quick Buttons) -->
          <ng-container *ngIf="message.type === 'actions'">
            <div class="action-buttons">
              <div class="action-title" [innerHTML]="formatMessage(message.content)"></div>
              <button 
                *ngFor="let btn of message.data?.buttons" 
                class="action-btn"
                (click)="onButtonClick(btn.action, btn.data)"
                [innerHTML]="btn.text">
              </button>
            </div>
          </ng-container>

          <!-- Confirmation Messages -->
          <div *ngIf="message.type === 'confirmation'" class="confirmation-message">
            <div [innerHTML]="formatMessage(message.content)"></div>
            <div *ngIf="message.data?.buttons" class="confirmation-buttons">
              <button 
                *ngFor="let btn of message.data.buttons" 
                class="confirmation-btn"
                (click)="onButtonClick(btn.action, btn.data)"
                [innerHTML]="btn.text">
              </button>
            </div>
          </div>
          
          <!-- Loading Messages -->
          <div *ngIf="message.type === 'loading'" class="loading-message">
            <i nz-icon nzType="loading" nzTheme="outline"></i>
            {{ message.content }}
          </div>
          
          <!-- Progress Messages -->
          <div *ngIf="message.type === 'progress'" class="progress-message">
            <nz-progress [nzPercent]="extractionProgress" [nzShowInfo]="false"></nz-progress>
            <p>{{ message.content }}</p>
          </div>
          
          <!-- Dropdown Messages -->
          <div *ngIf="message.type === 'dropdown'" class="dropdown-message">
            <p class="dropdown-label">{{ message.content }}</p>
            <nz-select 
              [nzPlaceHolder]="'اختر ' + (message.data.fieldLabel || message.data.label || message.data.field)"
              (ngModelChange)="onDropdownSelection(message.data.field, $event)"
              style="width: 100%;">
              <nz-option 
                *ngFor="let option of message.data.options" 
                [nzValue]="option.value || option" 
                [nzLabel]="option.label || option">
              </nz-option>
            </nz-select>
          </div>
          
          <!-- Contact Form Messages -->
          <div *ngIf="message.type === 'contact-form'" class="contact-form-message">
            <p>{{ message.content }}</p>
            <button 
              nz-button 
              nzType="primary" 
              (click)="openContactForm()">
              <i nz-icon nzType="user-add" nzTheme="outline"></i>
              إضافة جهة اتصال
            </button>
          </div>
        </div>
      </div>

      <!-- Accumulated Files Panel -->
      <div class="accumulated-files-panel" *ngIf="showAccumulatedFiles">
        <div class="panel-header">
          <h4>الملفات المحددة / Selected Files</h4>
          <button nz-button nzType="text" nzSize="small" (click)="clearAccumulatedFiles()">
            <i nz-icon nzType="delete" nzTheme="outline"></i>
          </button>
        </div>
        <div class="files-list">
          <div *ngFor="let file of accumulatedFiles; let i = index" class="accumulated-file-card">
            <div class="file-info">
              <span class="file-name">{{ file.name }}</span>
              <span class="file-size">{{ (file.size / 1024).toFixed(2) }}KB</span>
              <span class="detected-type">🔍 {{ detectDocumentType(file.name) }}</span>
            </div>
            <button nz-button nzType="text" nzSize="small" (click)="removeAccumulatedFile(i)" class="remove-btn">
              <i nz-icon nzType="close" nzTheme="outline"></i>
            </button>
          </div>
        </div>
        <div class="panel-footer">
          <button nz-button nzType="default" (click)="clearAccumulatedFiles()">
            إلغاء / Cancel
          </button>
          <button nz-button nzType="dashed" (click)="triggerFileUpload()">
            <i nz-icon nzType="plus"></i>
            إضافة ملفات أخرى / Add More Files
          </button>
          <button nz-button nzType="primary" (click)="proceedWithAccumulatedFiles()">
            متابعة / Continue ({{ accumulatedFiles.length }})
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Footer -->
    <div class="chat-footer">
      <!-- Inline fallback quick actions if message rendering fails -->
      <div class="inline-quick-actions" *ngIf="showInlineQuickActions">
        <button class="action-btn" (click)="onButtonClick('upload')">📄 رفع مستند / Upload Document</button>
        <button class="action-btn" (click)="onButtonClick('manual')">✍️ إدخال يدوي / Manual Entry</button>
        <button class="action-btn" (click)="onButtonClick('help')">❓ مساعدة / Help</button>
      </div>
      
      <!-- Debug info for inline actions -->
      <div *ngIf="showInlineQuickActions" style="font-size: 10px; color: #666; margin-bottom: 5px;">
        Debug: Inline quick actions enabled ({{ showInlineQuickActions }})
      </div>
      <div class="input-container">
        <input 
          type="file" 
          id="file-upload"
          multiple 
          accept="image/*" 
          (change)="onFileSelected($event)"
          style="display: none;">
        
        <button 
          class="attach-btn" 
          (click)="onButtonClick('upload')"
          nz-tooltip
          nzTooltipTitle="رفع مستندات / Upload Documents"
          nzTooltipPlacement="top">
          <span aria-hidden="true">📎</span>
          <span *ngIf="accumulatedFiles.length > 0" class="file-count">{{ accumulatedFiles.length }}</span>
        </button>
        
        <input 
          id="chat-message-input"
          name="chat-message-input"
          type="text" 
          [(ngModel)]="newMessage" 
          (keydown)="onEnterKey($event)"
          placeholder="اكتب رسالتك هنا... / Type your message here..."
          [disabled]="loading"
          aria-label="اكتب رسالتك هنا / Type your message here">
        
        <button 
          class="send-btn" 
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || loading"
          nz-tooltip
          nzTooltipTitle="إرسال / Send"
          nzTooltipPlacement="top">
          <span aria-hidden="true">➤</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Upload Modal Template -->
<ng-template #documentModalTemplate>
  <div class="document-modal-content">
    <!-- Debug info -->
    <div style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; font-size: 12px;">
      Debug: documentsFA.length = {{ documentsFA.length }}, pendingFiles.length = {{ pendingFiles.length }}
    </div>
    
    <form [formGroup]="documentMetadataForm">
      <div formArrayName="documents">
        <!-- Show message if no documents -->
        <div *ngIf="documentsFA.length === 0" style="text-align: center; padding: 20px; color: #666;">
          <p>لا توجد مستندات للعرض / No documents to display</p>
          <p>pendingFiles: {{ pendingFiles.length }}</p>
        </div>
        
        <div 
          *ngFor="let docGroup of documentsFA.controls; let i = index" 
          [formGroupName]="i" 
          class="document-form">
          
          <nz-card [nzTitle]="'مستند ' + (i + 1)" nzSize="small">
            <div class="form-row">
              <div class="form-group">
                <label [for]="'fileName_' + i">اسم الملف / File Name:</label>
                <input 
                  [id]="'fileName_' + i"
                  [name]="'fileName_' + i"
                  formControlName="name" 
                  readonly
                  aria-label="اسم الملف / File Name">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label [for]="'country_' + i">البلد / Country:</label>
                <nz-select 
                  [id]="'country_' + i"
                  formControlName="country" 
                  (ngModelChange)="onCountryChange($event, i)"
                  aria-label="البلد / Country">
                  <nz-option 
                    *ngFor="let country of countriesList" 
                    [nzValue]="country" 
                    [nzLabel]="country">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="form-group">
                <label [for]="'documentType_' + i">نوع المستند / Document Type:</label>
                <nz-select 
                  [id]="'documentType_' + i"
                  formControlName="type"
                  aria-label="نوع المستند / Document Type">
                  <nz-option 
                    *ngFor="let type of getDocumentTypesByCountry(docGroup.get('country')?.value || '')" 
                    [nzValue]="type" 
                    [nzLabel]="type">
                  </nz-option>
                </nz-select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label [for]="'description_' + i">الوصف / Description:</label>
                <textarea 
                  [id]="'description_' + i"
                  [name]="'description_' + i"
                  formControlName="description" 
                  rows="2"
                  aria-label="الوصف / Description"></textarea>
              </div>
            </div>
          </nz-card>
        </div>
      </div>
    </form>
    
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeDocumentModal()">
        إلغاء / Cancel
      </button>
      <button nz-button nzType="primary" (click)="saveDocuments()" [disabled]="!isDocumentFormValid">
        حفظ ومتابعة / Save & Continue
      </button>
    </div>
  </div>
</ng-template>

<!-- Hidden file input for programmatic uploads (used by quick actions) -->
<input 
  type="file" 
  id="file-upload"
  style="display: none"
  multiple
  accept="image/*"
  (change)="onFileSelected($event)">

<!-- Contact Form Modal -->
<nz-modal 
  [(nzVisible)]="showContactForm" 
  nzTitle="إضافة جهة اتصال / Add Contact"
  (nzOnCancel)="closeContactForm()"
  [nzFooter]="null"
  nzWidth="600px">
  
  <div *nzModalContent>
    <form *ngIf="contactForm" [formGroup]="contactForm">
      <div class="contact-form-content">
      <div class="form-row">
        <div class="form-group">
          <label>الاسم / Name: *</label>
          <input formControlName="name" placeholder="أدخل الاسم الكامل">
        </div>
        <div class="form-group">
          <label>المسمى الوظيفي / Job Title: *</label>
          <input formControlName="jobTitle" placeholder="أدخل المسمى الوظيفي">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>البريد الإلكتروني / Email: *</label>
          <input formControlName="email" type="email" placeholder="example@company.com">
        </div>
        <div class="form-group">
          <label>الجوال / Mobile: *</label>
          <input formControlName="mobile" placeholder="+966501234567">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>الهاتف الأرضي / Landline:</label>
          <input formControlName="landline" placeholder="+966112345678">
        </div>
        <div class="form-group">
          <label>اللغة المفضلة / Preferred Language:</label>
          <nz-select formControlName="preferredLanguage">
            <nz-option nzValue="Arabic" nzLabel="العربية"></nz-option>
            <nz-option nzValue="English" nzLabel="English"></nz-option>
          </nz-select>
        </div>
      </div>
    </div>
    
    <!-- ✅ Footer buttons -->
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeContactForm()">
        إلغاء / Cancel
      </button>
      <button nz-button nzType="primary" (click)="saveContactForm()" [disabled]="!contactForm.valid">
        حفظ / Save
      </button>
    </div>
  </form>
  </div>
</nz-modal>

<!-- Edit Form Modal -->
<nz-modal 
  [(nzVisible)]="showEditForm" 
  nzTitle="تعديل البيانات المستخرجة / Edit Extracted Data"
  (nzOnCancel)="closeEditForm()"
  [nzFooter]="null"
  nzWidth="700px"
  [nzMaskClosable]="false"
  [nzClosable]="true">
  
  <!-- ✅ تأكد من وجود *ngIf صح -->
  <div *nzModalContent>
    <form *ngIf="editForm && currentExtractedFields.length > 0" [formGroup]="editForm">
      <div class="edit-form-content">
        
        <!-- ✅ Dynamic form fields based on extracted data -->
        <div class="form-section">
          <h4>البيانات المستخرجة / Extracted Data</h4>
          <p class="section-description">
            تم استخراج {{currentExtractedFields.length}} حقل من المستند / {{currentExtractedFields.length}} fields extracted from document
          </p>
          
          <!-- Dynamic form fields -->
          <div class="dynamic-fields-grid">
            <div class="form-group" *ngFor="let field of currentExtractedFields; let i = index" 
                 [ngClass]="{'full-width': shouldBeFullWidth(field)}">
              
              <!-- Text inputs -->
              <ng-container *ngIf="isTextInput(field)">
                <label>{{getFieldLabel(field)}}:</label>
                <input [formControlName]="field" [placeholder]="getFieldPlaceholder(field)">
              </ng-container>
              
              <!-- Select inputs -->
              <ng-container *ngIf="isSelectInput(field)">
                <label>{{getFieldLabel(field)}}:</label>
                <nz-select [formControlName]="field">
                  <nz-option *ngFor="let option of getSelectOptions(field)" 
                            [nzValue]="option.value" [nzLabel]="option.label">
                  </nz-option>
                </nz-select>
              </ng-container>
            </div>
          </div>
        </div>
        
      </div>
    </form>
    
    <!-- ✅ Footer buttons -->
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeEditForm()">
        إلغاء / Cancel
      </button>
      <button nz-button nzType="primary" (click)="saveEditForm()">
        حفظ التعديلات / Save Changes
      </button>
    </div>
  </div>
</nz-modal>

<!-- Missing Fields Form Modal -->
<nz-modal 
  [(nzVisible)]="showMissingFieldsForm" 
  nzTitle="إكمال البيانات الناقصة / Complete Missing Data"
  (nzOnCancel)="closeMissingFieldsForm()"
  [nzFooter]="null"
  nzWidth="700px"
  [nzMaskClosable]="false"
  [nzClosable]="true">
  
  <div *nzModalContent>
    <!-- ✅ Header with clear instructions -->
    <div class="missing-fields-header">
      <div class="instructions">
        <h3>📝 إكمال البيانات الناقصة / Complete Missing Data</h3>
        <p>الحقول المملوءة مسبقاً هي للمرجع فقط. يرجى ملء الحقول الناقصة.</p>
        <p><em>Pre-filled fields are for reference only. Please fill the missing fields.</em></p>
      </div>
      <div class="field-status">
        <div class="status-item completed">
          <span class="icon">✅</span>
          <span class="text">مكتملة / Complete</span>
        </div>
        <div class="status-item missing">
          <span class="icon">❌</span>
          <span class="text">ناقصة / Missing</span>
        </div>
      </div>
    </div>
    
    <form *ngIf="missingFieldsForm" [formGroup]="missingFieldsForm">
      <div class="edit-form-content">
        
        <!-- ✅ MISSING FIELDS ONLY - Priority Section -->
        <div class="form-section missing-fields-section" *ngIf="currentMissingFields.length > 0">
          <h4>🔴 البيانات المطلوبة / Required Fields</h4>
          <p class="section-description">يرجى ملء الحقول التالية لإكمال الطلب / Please fill the following fields to complete the request:</p>
          
          <!-- Missing Company Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['firstName', 'firstNameAR', 'tax', 'CustomerType', 'ownerName'])">
            <h5>معلومات الشركة / Company Information</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('firstName')">
                <label>اسم الشركة (إنجليزي) / Company Name (English): <span class="required">*</span></label>
                <input formControlName="firstName" placeholder="Company Name">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('firstNameAR')">
                <label>اسم الشركة (عربي) / Company Name (Arabic): <span class="required">*</span></label>
                <input formControlName="firstNameAR" placeholder="اسم الشركة">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('tax')">
                <label>الرقم الضريبي / Tax Number: <span class="required">*</span></label>
                <input formControlName="tax" placeholder="Tax Number">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('CustomerType')">
                <label>نوع العميل / Customer Type: <span class="required">*</span></label>
                <nz-select formControlName="CustomerType">
                  <nz-option nzValue="Corporate" nzLabel="Corporate"></nz-option>
                  <nz-option nzValue="SME" nzLabel="SME"></nz-option>
                  <nz-option nzValue="Individual" nzLabel="Individual"></nz-option>
                </nz-select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('ownerName')">
                <label>اسم المالك / Owner Name:</label>
                <input formControlName="ownerName" placeholder="Owner Name">
              </div>
            </div>
          </div>

          <!-- Missing Address Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['buildingNumber', 'street', 'country', 'city'])">
            <h5>معلومات العنوان / Address Information</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('buildingNumber')">
                <label>رقم المبنى / Building Number:</label>
                <input formControlName="buildingNumber" placeholder="Building Number">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('street')">
                <label>الشارع / Street:</label>
                <input formControlName="street" placeholder="Street Address">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('country')">
                <label>الدولة / Country: <span class="required">*</span></label>
                <nz-select formControlName="country">
                  <nz-option nzValue="Egypt" nzLabel="Egypt"></nz-option>
                  <nz-option nzValue="Saudi Arabia" nzLabel="Saudi Arabia"></nz-option>
                  <nz-option nzValue="United Arab Emirates" nzLabel="United Arab Emirates"></nz-option>
                  <nz-option nzValue="Yemen" nzLabel="Yemen"></nz-option>
                </nz-select>
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('city')">
                <label>المدينة / City:</label>
                <input formControlName="city" placeholder="City">
              </div>
            </div>
          </div>

          <!-- Missing Sales Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['salesOrganization', 'distributionChannel', 'division'])">
            <h5>معلومات المبيعات / Sales Information</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('salesOrganization')">
                <label>منظمة المبيعات / Sales Organization: <span class="required">*</span></label>
                <nz-select formControlName="salesOrganization">
                  <nz-option nzValue="egypt_cairo_office" nzLabel="Egypt - Cairo Head Office"></nz-option>
                  <nz-option nzValue="egypt_alexandria_branch" nzLabel="Egypt - Alexandria Branch"></nz-option>
                  <nz-option nzValue="egypt_giza_branch" nzLabel="Egypt - Giza Branch"></nz-option>
                  <nz-option nzValue="ksa_riyadh_office" nzLabel="Saudi Arabia - Riyadh Office"></nz-option>
                  <nz-option nzValue="ksa_jeddah_branch" nzLabel="Saudi Arabia - Jeddah Branch"></nz-option>
                </nz-select>
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('distributionChannel')">
                <label>قناة التوزيع / Distribution Channel: <span class="required">*</span></label>
                <nz-select formControlName="distributionChannel">
                  <nz-option nzValue="direct_sales" nzLabel="Direct Sales"></nz-option>
                  <nz-option nzValue="authorized_distributors" nzLabel="Authorized Distributors"></nz-option>
                  <nz-option nzValue="retail_chains" nzLabel="Retail Chains"></nz-option>
                </nz-select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('division')">
                <label>القسم / Division: <span class="required">*</span></label>
                <nz-select formControlName="division">
                  <nz-option nzValue="food_products" nzLabel="Food Products Division"></nz-option>
                  <nz-option nzValue="beverages" nzLabel="Beverages Division"></nz-option>
                  <nz-option nzValue="household_items" nzLabel="Household Items Division"></nz-option>
                </nz-select>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ COMPLETED FIELDS - Reference Section -->
        <div class="form-section completed-fields-section" *ngIf="getCompletedFields().length > 0">
          <h4>✅ البيانات المكتملة / Completed Fields</h4>
          <p class="section-description">البيانات التالية تم استخراجها من المستندات (للمرجع فقط) / The following data was extracted from documents (for reference only):</p>
          
          <div class="completed-fields-grid">
            <div class="completed-field" *ngFor="let field of getCompletedFields()">
              <div class="field-label">{{ getFieldLabel(field) }}</div>
              <div class="field-value">{{ getFieldValue(field) }}</div>
            </div>
          </div>
        </div>
      </div>
    </form>
    
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeMissingFieldsForm()">
        إلغاء / Cancel
      </button>
      <button nz-button nzType="primary" (click)="saveMissingFieldsForm()">
        حفظ البيانات الناقصة / Save Missing Data
      </button>
    </div>
  </div>
</nz-modal>

<!-- Uploaded Documents Display -->
<div *ngIf="getUploadedDocuments().length > 0" class="uploaded-documents">
  <h4>المستندات المرفوعة / Uploaded Documents</h4>
  <div class="documents-grid">
    <div *ngFor="let doc of getUploadedDocuments(); let i = index" class="document-card">
      <div class="document-info">
        <h5>{{ doc.name }}</h5>
        <p>{{ doc.type }} - {{ (doc.size / 1024).toFixed(2) }}KB</p>
      </div>
      <button 
        nz-button 
        nzType="text" 
        nzDanger 
        (click)="removeDocument(i)">
        <i nz-icon nzType="delete" nzTheme="outline"></i>
      </button>
    </div>
  </div>
</div>

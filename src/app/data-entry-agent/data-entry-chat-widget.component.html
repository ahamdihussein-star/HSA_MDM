<!-- Floating Chat Widget -->
<div class="chat-widget-container">
  <!-- Toggle Button -->
  <button 
    class="chat-toggle-button" 
    (click)="toggleChat()"
    *ngIf="!isOpen"
    nz-tooltip
    nzTooltipTitle="Data Entry AI Assistant"
    nzTooltipPlacement="left">
    <i nz-icon nzType="robot" nzTheme="outline"></i>
  </button>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="isOpen">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <h3>ğŸ¤– Data Entry AI Assistant</h3>
        <p class="user-greeting">{{ getCurrentUserName() }}</p>
      </div>
      <div class="header-actions">
        <button 
          class="minimize-btn" 
          (click)="minimizeChat()"
          nz-tooltip
          nzTooltipTitle="Minimize">
          <i nz-icon nzType="minus" nzTheme="outline"></i>
        </button>
        <button 
          class="close-btn" 
          (click)="closeChat()"
          nz-tooltip
          nzTooltipTitle="Close">
          <i nz-icon nzType="close" nzTheme="outline"></i>
        </button>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body">
      <!-- Messages -->
      <div class="messages-container">
        <div 
          *ngFor="let message of messages" 
          class="message"
          [ngClass]="{'user-message': message.role === 'user', 'assistant-message': message.role === 'assistant'}">
          
          <!-- Text Messages -->
          <div *ngIf="message.type === 'text'" [innerHTML]="formatMessage(message.content)"></div>
          
          <!-- Loading Messages -->
          <div *ngIf="message.type === 'loading'" class="loading-message">
            <i nz-icon nzType="loading" nzTheme="outline"></i>
            {{ message.content }}
          </div>
          
          <!-- Progress Messages -->
          <div *ngIf="message.type === 'progress'" class="progress-message">
            <nz-progress [nzPercent]="extractionProgress" [nzShowInfo]="false"></nz-progress>
            <p>{{ message.content }}</p>
          </div>
          
          <!-- Dropdown Messages -->
          <div *ngIf="message.type === 'dropdown'" class="dropdown-message">
            <p class="dropdown-label">{{ message.content }}</p>
            <nz-select 
              [nzPlaceHolder]="'Ø§Ø®ØªØ± ' + message.data.label"
              (ngModelChange)="onDropdownSelection(message.data.field, $event)"
              style="width: 100%;">
              <nz-option 
                *ngFor="let option of message.data.options" 
                [nzValue]="option" 
                [nzLabel]="option">
              </nz-option>
            </nz-select>
          </div>
          
          <!-- Contact Form Messages -->
          <div *ngIf="message.type === 'contact-form'" class="contact-form-message">
            <p>{{ message.content }}</p>
            <button 
              nz-button 
              nzType="primary" 
              (click)="openContactForm()">
              <i nz-icon nzType="user-add" nzTheme="outline"></i>
              Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
            </button>
          </div>

          <!-- Action Buttons (if any) -->
          <div *ngIf="message.data?.buttons" class="action-buttons">
            <button 
              *ngFor="let btn of message.data.buttons" 
              class="action-btn"
              (click)="onButtonClick(btn.action, btn.data)"
              [innerHTML]="btn.text">
            </button>
          </div>
        </div>
      </div>

      <!-- Accumulated Files Panel -->
      <div class="accumulated-files-panel" *ngIf="showAccumulatedFiles">
        <div class="panel-header">
          <h4>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© / Selected Files</h4>
          <button nz-button nzType="text" nzSize="small" (click)="clearAccumulatedFiles()">
            <i nz-icon nzType="delete" nzTheme="outline"></i>
          </button>
        </div>
        <div class="files-list">
          <div *ngFor="let file of accumulatedFiles; let i = index" class="file-item">
            <span>{{ file.name }}</span>
            <button nz-button nzType="text" nzSize="small" (click)="removeAccumulatedFile(i)">
              <i nz-icon nzType="close" nzTheme="outline"></i>
            </button>
          </div>
        </div>
        <div class="panel-footer">
          <button nz-button nzType="default" (click)="clearAccumulatedFiles()">
            Ø¥Ù„ØºØ§Ø¡ / Cancel
          </button>
          <button nz-button nzType="primary" (click)="proceedWithAccumulatedFiles()">
            Ù…ØªØ§Ø¨Ø¹Ø© / Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Footer -->
    <div class="chat-footer">
      <div class="input-container">
        <input 
          type="file" 
          #fileInput 
          multiple 
          accept="image/*,.pdf" 
          (change)="onFileSelected($event)"
          style="display: none;">
        
        <button 
          class="attach-btn" 
          (click)="fileInput.click()"
          nz-tooltip
          nzTooltipTitle="Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯Ø§Øª / Upload Documents"
          nzTooltipPlacement="top">
          <i nz-icon nzType="paper-clip" nzTheme="outline"></i>
          <span *ngIf="accumulatedFiles.length > 0" class="file-count">{{ accumulatedFiles.length }}</span>
        </button>
        
        <input 
          type="text" 
          [(ngModel)]="newMessage" 
          (keydown)="onEnterKey($event)"
          placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§... / Type your message here..."
          [disabled]="loading">
        
        <button 
          class="send-btn" 
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || loading"
          nz-tooltip
          nzTooltipTitle="Ø¥Ø±Ø³Ø§Ù„ / Send"
          nzTooltipPlacement="top">
          <i nz-icon nzType="send" nzTheme="outline"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Upload Modal -->
<nz-modal 
  [(nzVisible)]="showDocumentModal" 
  nzTitle="Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª / Add Document Information"
  (nzOnCancel)="closeDocumentModal()"
  [nzFooter]="null"
  nzWidth="800px">
  
  <div class="document-modal-content">
    <form [formGroup]="documentMetadataForm">
      <div formArrayName="documents">
        <div 
          *ngFor="let docGroup of documentsFA.controls; let i = index" 
          [formGroupName]="i" 
          class="document-form">
          
          <nz-card [nzTitle]="'Ù…Ø³ØªÙ†Ø¯ ' + (i + 1)" nzSize="small">
            <div class="form-row">
              <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù / File Name:</label>
                <input formControlName="name" readonly>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Ø§Ù„Ø¨Ù„Ø¯ / Country:</label>
                <nz-select formControlName="country" (ngModelChange)="onCountryChange($event, i)">
                  <nz-option 
                    *ngFor="let country of countriesList" 
                    [nzValue]="country" 
                    [nzLabel]="country">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ / Document Type:</label>
                <nz-select formControlName="type">
                  <nz-option 
                    *ngFor="let type of getDocumentTypesByCountry(docGroup.get('country')?.value || '')" 
                    [nzValue]="type" 
                    [nzLabel]="type">
                  </nz-option>
                </nz-select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label>Ø§Ù„ÙˆØµÙ / Description:</label>
                <textarea formControlName="description" rows="2"></textarea>
              </div>
            </div>
          </nz-card>
        </div>
      </div>
    </form>
  </div>
  
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="closeDocumentModal()">
      Ø¥Ù„ØºØ§Ø¡ / Cancel
    </button>
    <button nz-button nzType="primary" (click)="saveDocuments()" [disabled]="!documentMetadataForm.valid">
      Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© / Save & Continue
    </button>
  </div>
</nz-modal>

<!-- Hidden file input for programmatic uploads (used by quick actions) -->
<input 
  type="file" 
  id="file-upload"
  style="display: none"
  multiple
  accept="image/*"
  (change)="onFileSelected($event)">

<!-- Contact Form Modal -->
<nz-modal 
  [(nzVisible)]="showContactForm" 
  nzTitle="Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ / Add Contact"
  (nzOnCancel)="closeContactForm()"
  [nzFooter]="null"
  nzWidth="600px">
  
  <form [formGroup]="contactForm">
    <div class="contact-form-content">
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ø§Ø³Ù… / Name: *</label>
          <input formControlName="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ / Job Title: *</label>
          <input formControlName="jobTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Email: *</label>
          <input formControlName="email" type="email" placeholder="example@company.com">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø¬ÙˆØ§Ù„ / Mobile: *</label>
          <input formControlName="mobile" placeholder="+966501234567">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø±Ø¶ÙŠ / Landline:</label>
          <input formControlName="landline" placeholder="+966112345678">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙØ¶Ù„Ø© / Preferred Language:</label>
          <nz-select formControlName="preferredLanguage">
            <nz-option nzValue="Arabic" nzLabel="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"></nz-option>
            <nz-option nzValue="English" nzLabel="English"></nz-option>
          </nz-select>
        </div>
      </div>
    </div>
  </form>
  
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="closeContactForm()">
      Ø¥Ù„ØºØ§Ø¡ / Cancel
    </button>
    <button nz-button nzType="primary" (click)="saveContactForm()" [disabled]="!contactForm.valid">
      Ø­ÙØ¸ / Save
    </button>
  </div>
</nz-modal>

<!-- Uploaded Documents Display -->
<div *ngIf="getUploadedDocuments().length > 0" class="uploaded-documents">
  <h4>Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© / Uploaded Documents</h4>
  <div class="documents-grid">
    <div *ngFor="let doc of getUploadedDocuments(); let i = index" class="document-card">
      <div class="document-info">
        <h5>{{ doc.name }}</h5>
        <p>{{ doc.type }} - {{ (doc.size / 1024).toFixed(2) }}KB</p>
      </div>
      <button 
        nz-button 
        nzType="text" 
        nzDanger 
        (click)="removeDocument(i)">
        <i nz-icon nzType="delete" nzTheme="outline"></i>
      </button>
    </div>
  </div>
</div>

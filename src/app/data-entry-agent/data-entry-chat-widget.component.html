<!-- Floating Chat Widget -->
<div class="chat-widget-container">
  <!-- Toggle Button -->
  <button 
    class="chat-toggle-button" 
    (click)="toggleChat()"
    *ngIf="isMinimized || !isOpen"
    nz-tooltip
    nzTooltipTitle="{{ 'agent.title' | translate }}"
    nzTooltipPlacement="left">
    <img src="assets/img/agent-icon.png" alt="AI Agent" class="agent-icon">
  </button>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="isOpen && !isMinimized">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <h3>
          <img src="assets/img/agent-icon.png" alt="AI Agent" class="header-agent-icon">
          {{ 'agent.title' | translate }}
        </h3>
        <p class="user-greeting">{{ getCurrentUserName() }}</p>
      </div>
      <div class="header-actions">
        <button 
          class="minimize-btn" 
          (click)="minimizeChat()"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.minimize' | translate }}">
          <span aria-hidden="true">–</span>
        </button>
        <button 
          class="close-btn" 
          (click)="closeChat()"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.close' | translate }}">
          <span aria-hidden="true">×</span>
        </button>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body">
      <!-- Messages -->
      <div class="messages-container">
        <div 
          *ngFor="let message of messages" 
          class="message"
          [attr.data-message-id]="message.id"
          [attr.data-message-type]="message.type"
          [ngClass]="{'user-message': message.role === 'user', 'assistant-message': message.role === 'assistant'}">
          
          <!-- Text Messages -->
          <div *ngIf="message.type === 'text'" [innerHTML]="formatMessage(message.content)"></div>

          <!-- Actions (Quick Buttons) -->
          <ng-container *ngIf="message.type === 'actions'">
            <div class="action-buttons">
              <div class="action-title" [innerHTML]="formatMessage(message.content)"></div>
              <button 
                *ngFor="let btn of message.data?.buttons" 
                class="action-btn"
                (click)="onButtonClick(btn.action, btn.data)"
                [innerHTML]="btn.text">
              </button>
            </div>
          </ng-container>
          
          <!-- Confirmation Messages -->
          <div *ngIf="message.type === 'confirmation'" class="confirmation-wrapper">
            <div class="confirmation-message">
              <ng-container *ngIf="message.data?.component === 'review'; else legacyConfirmation">
                <div class="message-content">
                  <app-data-entry-review-message
                    [extractedData]="message.data?.extractedData"
                    [fields]="message.data?.fields">
                  </app-data-entry-review-message>
                </div>
              </ng-container>
              <ng-template #legacyConfirmation>
                <div [innerHTML]="formatMessage(message.content)"></div>
              </ng-template>
            </div>
            <!-- Button OUTSIDE the message bubble - floating below -->
            <div class="floating-action-buttons" *ngIf="message.data?.buttons">
              <button *ngFor="let button of message.data?.buttons"
                      class="floating-action-btn"
                      [ngClass]="button.className"
                      (click)="onButtonClick(button.action, button.data)">
                <span>{{ button.text }}</span>
              </button>
            </div>
          </div>
          
          <!-- Loading Messages -->
          <div *ngIf="message.type === 'loading'" class="loading-message">
            <i nz-icon nzType="loading" nzTheme="outline"></i>
            {{ message.content }}
          </div>
          
          <!-- Progress Messages -->
          <div *ngIf="message.type === 'progress'" class="progress-message">
            <nz-progress [nzPercent]="extractionProgress" [nzShowInfo]="false"></nz-progress>
            <p>{{ message.content }}</p>
          </div>
          
          <!-- Dropdown Messages -->
          <div *ngIf="message.type === 'dropdown'" class="dropdown-message">
            <p class="dropdown-label">{{ message.content }}</p>
            <nz-select 
              [nzPlaceHolder]="'اختر ' + (message.data.fieldLabel || message.data.label || message.data.field)"
              (ngModelChange)="onDropdownSelection(message.data.field, $event)"
              style="width: 100%;">
              <nz-option 
                *ngFor="let option of message.data.options" 
                [nzValue]="option.value || option" 
                [nzLabel]="option.label || option">
              </nz-option>
            </nz-select>
          </div>
          
          <!-- Contact Form Messages -->
          <div *ngIf="message.type === 'contact-form'" class="contact-form-message">
            <p>{{ message.content }}</p>
            <button 
              nz-button 
              nzType="primary" 
              (click)="openContactForm()">
              <i nz-icon nzType="user-add" nzTheme="outline"></i>
              {{ 'agent.buttons.addContact' | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Accumulated Files Panel -->
      <div class="accumulated-files-panel" *ngIf="showAccumulatedFiles">
        <div class="panel-header">
          <h4>{{ 'agent.fileSelection.selectedFiles' | translate }}</h4>
          <button nz-button nzType="text" nzSize="small" (click)="clearAccumulatedFiles()">
            <i nz-icon nzType="delete" nzTheme="outline"></i>
          </button>
        </div>
        <div class="files-list">
          <div *ngFor="let file of accumulatedFiles; let i = index" class="accumulated-file-card">
            <div class="file-info">
              <span class="file-name">{{ file.name }}</span>
              <span class="file-size">{{ (file.size / 1024).toFixed(2) }}KB</span>
              <span class="detected-type">🔍 {{ detectDocumentType(file.name) }}</span>
            </div>
            <button nz-button nzType="text" nzSize="small" (click)="removeAccumulatedFile(i)" class="remove-btn">
              <i nz-icon nzType="close" nzTheme="outline"></i>
            </button>
          </div>
        </div>
        <div class="panel-footer">
          <button nz-button nzType="default" (click)="clearAccumulatedFiles()">
            {{ 'Cancel' | translate }}
          </button>
          <button nz-button nzType="dashed" (click)="triggerFileUpload()">
            <i nz-icon nzType="plus"></i>
            {{ 'agent.buttons.addMoreFiles' | translate }}
          </button>
          <button nz-button nzType="primary" (click)="proceedWithAccumulatedFiles()">
            {{ 'agent.buttons.continue' | translate }} ({{ accumulatedFiles.length }})
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Footer -->
    <div class="chat-footer">
      <!-- Inline fallback quick actions if message rendering fails -->
      <div class="inline-quick-actions" *ngIf="showInlineQuickActions">
        <button class="action-btn" (click)="onButtonClick('upload')">{{ 'agent.uploadDocument' | translate }}</button>
        <button class="action-btn" (click)="onButtonClick('manual')">{{ 'agent.manualEntry' | translate }}</button>
        <button class="action-btn" (click)="onButtonClick('help')">{{ 'agent.help' | translate }}</button>
      </div>
      
      <!-- Debug info for inline actions -->
      <div *ngIf="showInlineQuickActions" style="font-size: 10px; color: #666; margin-bottom: 5px;">
        Debug: Inline quick actions enabled ({{ showInlineQuickActions }})
      </div>
      <div class="input-container">
        
        <button 
          class="attach-btn" 
          (click)="onButtonClick('upload')"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.uploadDocument' | translate }}"
          nzTooltipPlacement="top">
          <span aria-hidden="true">📎</span>
          <span *ngIf="accumulatedFiles.length > 0" class="file-count">{{ accumulatedFiles.length }}</span>
        </button>
        
        <input 
          id="chat-message-input"
          name="chat-message-input"
          type="text" 
          [(ngModel)]="newMessage" 
          (keydown)="onEnterKey($event)"
          placeholder="{{ 'agent.inputPlaceholder' | translate }}"
          [disabled]="loading">
        
        <button 
          class="send-btn" 
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || loading"
          nz-tooltip
          nzTooltipTitle="{{ 'agent.send' | translate }}"
          nzTooltipPlacement="top">
          <span aria-hidden="true">➤</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Upload Modal Template -->
<ng-template #documentModalTemplate>
  <div class="document-modal-content">
    <!-- File Upload Section -->
    <div class="file-upload-section">
      <h4>📎 {{ 'agent.documentModal.uploadHeader' | translate }}</h4>
      <div class="upload-area" (click)="triggerFileUpload()" (dragover)="onDragOver($event)" (drop)="onFileDrop($event)">
        <div class="upload-content">
          <span class="upload-icon">📁</span>
          <p>{{ 'agent.documentModal.clickToUpload' | translate }}</p>
          <input 
            type="file" 
            #fileInput
            multiple 
            accept="image/*" 
            (change)="onModalFileSelected($event)"
            style="display: none">
        </div>
      </div>
      
      <!-- Selected Files Preview -->
      <div *ngIf="pendingFiles.length > 0" class="selected-files">
        <h5>{{ 'agent.documentModal.selectedFiles' | translate }} ({{ pendingFiles.length }})</h5>
        <div class="files-list">
          <div *ngFor="let file of pendingFiles; let i = index" class="file-item">
            <span class="file-name">{{ file.name }}</span>
            <span class="file-size">({{ (file.size / 1024).toFixed(1) }}KB)</span>
            <button type="button" class="remove-file-btn" (click)="removePendingFile(i)">×</button>
          </div>
        </div>
      </div>
    </div>
    
    <form [formGroup]="documentMetadataForm" *ngIf="pendingFiles.length > 0">
      <div formArrayName="documents">
        <!-- Show message if no documents -->
        <div *ngIf="documentsFA.length === 0" style="text-align: center; padding: 20px; color: #666;">
          <p>{{ 'agent.messages.noDocuments' | translate }}</p>
          <p>pendingFiles: {{ pendingFiles.length }}</p>
        </div>
        
        <div 
          *ngFor="let docGroup of documentsFA.controls; let i = index" 
          [formGroupName]="i" 
          class="document-form">
          
          <nz-card [nzTitle]="('agent.labels.document' | translate) + ' ' + (i + 1)" nzSize="small">
            <div class="form-row">
              <div class="form-group">
                <label [for]="'fileName_' + i">{{ 'agent.documentModal.fileName' | translate }}:</label>
                <input 
                  [id]="'fileName_' + i"
                  [name]="'fileName_' + i"
                  formControlName="name" 
                  readonly
                  [attr.aria-label]="'agent.documentModal.fileName' | translate">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label [for]="'country_' + i">{{ 'agent.documentModal.country' | translate }}:</label>
                <nz-select 
                  [id]="'country_' + i"
                  formControlName="country" 
                  (ngModelChange)="onCountryChange($event, i)"
                  [attr.aria-label]="'agent.documentModal.country' | translate">
                  <nz-option 
                    *ngFor="let country of countriesList" 
                    [nzValue]="country" 
                    [nzLabel]="country">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="form-group">
                <label [for]="'documentType_' + i">{{ 'agent.documentModal.documentType' | translate }}:</label>
                <nz-select 
                  [id]="'documentType_' + i"
                  formControlName="type"
                  [attr.aria-label]="'agent.documentModal.documentType' | translate">
                  <nz-option 
                    *ngFor="let type of getDocumentTypesByCountry(docGroup.get('country')?.value || '')" 
                    [nzValue]="type" 
                    [nzLabel]="type">
                  </nz-option>
                </nz-select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label [for]="'description_' + i">{{ 'agent.documentModal.description' | translate }}:</label>
                <textarea 
                  [id]="'description_' + i"
                  [name]="'description_' + i"
                  formControlName="description" 
                  rows="2"
                  [attr.aria-label]="'agent.documentModal.description' | translate"></textarea>
              </div>
            </div>
          </nz-card>
        </div>
      </div>
    </form>
  
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="closeDocumentModal()">
      {{ 'agent.documentModal.cancel' | translate }}
    </button>
    <button nz-button nzType="primary" (click)="saveDocuments()" [disabled]="!isDocumentFormValid">
      {{ 'agent.documentModal.saveAndContinue' | translate }}
    </button>
  </div>
  </div>
</ng-template>


<!-- Contact Form Modal -->
<nz-modal 
  [(nzVisible)]="showContactForm" 
  [nzTitle]="contactModalTitle"
  (nzOnCancel)="closeContactForm()"
  [nzFooter]="null"
  nzWidth="600px">
  
  <div *nzModalContent>
    <form *ngIf="contactForm" [formGroup]="contactForm">
    <div class="contact-form-content">
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'agent.contactForm.name' | translate }}: *</label>
          <input formControlName="name" [placeholder]="'agent.contactForm.namePlaceholder' | translate">
        </div>
        <div class="form-group">
          <label>{{ 'agent.contactForm.jobTitle' | translate }}: *</label>
          <input formControlName="jobTitle" [placeholder]="'agent.contactForm.jobTitlePlaceholder' | translate">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'agent.contactForm.email' | translate }}: *</label>
          <input formControlName="email" type="email" placeholder="example@company.com">
        </div>
        <div class="form-group">
          <label>{{ 'agent.contactForm.mobile' | translate }}: *</label>
          <input formControlName="mobile" placeholder="+966501234567">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'agent.contactForm.landline' | translate }}:</label>
          <input formControlName="landline" placeholder="+966112345678">
        </div>
        <div class="form-group">
          <label>{{ 'agent.contactForm.preferredLanguage' | translate }}:</label>
          <nz-select formControlName="preferredLanguage">
            <nz-option nzValue="Arabic" [nzLabel]="'Arabic' | translate"></nz-option>
            <nz-option nzValue="English" [nzLabel]="'English' | translate"></nz-option>
          </nz-select>
        </div>
      </div>
    </div>
  
    <!-- ✅ Footer buttons -->
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="closeContactForm()">
      {{ 'Cancel' | translate }}
    </button>
    <button nz-button nzType="primary" (click)="saveContactForm()" [disabled]="!contactForm.valid">
      {{ 'Save' | translate }}
    </button>
    </div>
  </form>
  </div>
</nz-modal>

<!-- Edit Form Modal -->
<nz-modal 
  [(nzVisible)]="showEditForm" 
  nzTitle="{{ 'agent.editForm.title' | translate }}"
  (nzOnCancel)="closeEditForm()"
  [nzFooter]="null"
  nzWidth="700px"
  [nzMaskClosable]="false"
  [nzClosable]="true">
  
  <!-- ✅ تأكد من وجود *ngIf صح -->
  <div *nzModalContent>
    <form *ngIf="editForm && currentExtractedFields.length > 0" [formGroup]="editForm">
      <div class="edit-form-content">
        
        <!-- ✅ Dynamic form fields based on extracted data -->
        <div class="form-section">
          <h4>{{ 'agent.editForm.sectionTitle' | translate }}</h4>
          <p class="section-description">
            {{ 'agent.editForm.description' | translate:{ count: currentExtractedFields.length } }}
          </p>
          
          <!-- Dynamic form fields -->
          <div class="dynamic-fields-grid">
            <div class="form-group" *ngFor="let field of currentExtractedFields; let i = index" 
                 [ngClass]="{'full-width': shouldBeFullWidth(field)}">
              
              <!-- Text inputs -->
              <ng-container *ngIf="isTextInput(field)">
                <label>{{getFieldLabel(field)}}:</label>
                <input [formControlName]="field" [placeholder]="getFieldPlaceholder(field)">
              </ng-container>
              
              <!-- Select inputs -->
              <ng-container *ngIf="isSelectInput(field)">
                <label>{{getFieldLabel(field)}}:</label>
                <nz-select [formControlName]="field">
                  <nz-option *ngFor="let option of getSelectOptions(field)" 
                            [nzValue]="option.value" [nzLabel]="option.label">
                  </nz-option>
                </nz-select>
              </ng-container>
            </div>
          </div>
        </div>
        
  <!-- Hidden file input for direct upload (outside modal) -->
  <input 
    type="file" 
    #directFileInput
    id="directFileInput"
    multiple 
    accept="image/*" 
    (change)="onFileSelected($event)"
    style="display: none;">
      </div>
    </form>
    
    <!-- ✅ Footer buttons -->
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeEditForm()">
        {{ 'agent.editForm.cancel' | translate }}
      </button>
      <button nz-button nzType="primary" (click)="saveEditForm()">
        {{ 'agent.editForm.saveChanges' | translate }}
      </button>
    </div>
  </div>
</nz-modal>

<!-- Missing Fields Form Modal -->
<nz-modal 
  [(nzVisible)]="showMissingFieldsForm" 
  nzTitle="{{ 'agent.missingForm.title' | translate }}"
  (nzOnCancel)="closeMissingFieldsForm()"
  [nzFooter]="null"
  nzWidth="700px"
  [nzMaskClosable]="false"
  [nzClosable]="true">
  
  <div *nzModalContent>
    <!-- ✅ Header with clear instructions -->
    <div class="missing-fields-header">
      <div class="instructions">
        <h3>📝 {{ 'agent.missingForm.headerTitle' | translate }}</h3>
        <p>{{ 'agent.missingForm.prefilledNote' | translate }}</p>
      </div>
      <div class="field-status">
        <div class="status-item completed">
          <span class="icon">✅</span>
          <span class="text">{{ 'agent.missingForm.completed' | translate }}</span>
        </div>
        <div class="status-item missing">
          <span class="icon">❌</span>
          <span class="text">{{ 'agent.missingForm.missing' | translate }}</span>
        </div>
      </div>
    </div>
    
    <form *ngIf="missingFieldsForm" [formGroup]="missingFieldsForm">
      <div class="edit-form-content">
        
        <!-- ✅ MISSING FIELDS ONLY - Priority Section -->
        <div class="form-section missing-fields-section" *ngIf="currentMissingFields.length > 0">
          <h4>🔴 {{ 'agent.missingForm.requiredSectionTitle' | translate }}</h4>
          <p class="section-description">{{ 'agent.missingForm.requiredInstructions' | translate }}</p>
          
          <!-- Missing Company Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['firstName', 'firstNameAR', 'tax', 'CustomerType', 'ownerName'])">
            <h5>{{ 'agent.missingForm.companyInfo' | translate }}</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('firstName')">
                <label>{{ 'agent.fieldLabels.firstName' | translate }}: <span class="required">*</span></label>
                <input formControlName="firstName" placeholder="Company Name">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('firstNameAR')">
                <label>{{ 'agent.fieldLabels.firstNameAR' | translate }}: <span class="required">*</span></label>
                <input formControlName="firstNameAR" placeholder="اسم الشركة">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('tax')">
                <label>{{ 'agent.fieldLabels.tax' | translate }}: <span class="required">*</span></label>
                <input formControlName="tax" placeholder="Tax Number">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('CustomerType')">
                <label>{{ 'agent.fieldLabels.CustomerType' | translate }}: <span class="required">*</span></label>
                <nz-select formControlName="CustomerType">
                  <nz-option nzValue="Corporate" nzLabel="Corporate"></nz-option>
                  <nz-option nzValue="SME" nzLabel="SME"></nz-option>
                  <nz-option nzValue="Individual" nzLabel="Individual"></nz-option>
                </nz-select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('ownerName')">
                <label>{{ 'agent.fieldLabels.ownerName' | translate }}:</label>
                <input formControlName="ownerName" placeholder="Owner Name">
              </div>
            </div>
          </div>

          <!-- Missing Address Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['buildingNumber', 'street', 'country', 'city'])">
            <h5>{{ 'agent.missingForm.addressInfo' | translate }}</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('buildingNumber')">
                <label>{{ 'agent.fieldLabels.buildingNumber' | translate }}:</label>
                <input formControlName="buildingNumber" placeholder="Building Number">
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('street')">
                <label>{{ 'agent.fieldLabels.street' | translate }}:</label>
                <input formControlName="street" placeholder="Street Address">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('country')">
                <label>{{ 'agent.fieldLabels.country' | translate }}: <span class="required">*</span></label>
                <nz-select formControlName="country">
                  <nz-option nzValue="Egypt" nzLabel="Egypt"></nz-option>
                  <nz-option nzValue="Saudi Arabia" nzLabel="Saudi Arabia"></nz-option>
                  <nz-option nzValue="United Arab Emirates" nzLabel="United Arab Emirates"></nz-option>
                  <nz-option nzValue="Yemen" nzLabel="Yemen"></nz-option>
                </nz-select>
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('city')">
                <label>{{ 'agent.fieldLabels.city' | translate }}:</label>
                <input formControlName="city" placeholder="City">
              </div>
            </div>
          </div>

          <!-- Missing Sales Fields -->
          <div class="missing-fields-group" *ngIf="hasMissingField(['salesOrganization', 'distributionChannel', 'division'])">
            <h5>{{ 'agent.missingForm.salesInfo' | translate }}</h5>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('salesOrganization')">
                <label>{{ 'agent.fieldLabels.salesOrganization' | translate }}: <span class="required">*</span></label>
                <nz-select formControlName="salesOrganization">
                  <nz-option nzValue="egypt_cairo_office" nzLabel="Egypt - Cairo Head Office"></nz-option>
                  <nz-option nzValue="egypt_alexandria_branch" nzLabel="Egypt - Alexandria Branch"></nz-option>
                  <nz-option nzValue="egypt_giza_branch" nzLabel="Egypt - Giza Branch"></nz-option>
                  <nz-option nzValue="ksa_riyadh_office" nzLabel="Saudi Arabia - Riyadh Office"></nz-option>
                  <nz-option nzValue="ksa_jeddah_branch" nzLabel="Saudi Arabia - Jeddah Branch"></nz-option>
                </nz-select>
              </div>
              <div class="form-group" *ngIf="currentMissingFields.includes('distributionChannel')">
                <label>{{ 'agent.fieldLabels.distributionChannel' | translate }}: <span class="required">*</span></label>
                <nz-select formControlName="distributionChannel">
                  <nz-option nzValue="direct_sales" nzLabel="Direct Sales"></nz-option>
                  <nz-option nzValue="authorized_distributors" nzLabel="Authorized Distributors"></nz-option>
                  <nz-option nzValue="retail_chains" nzLabel="Retail Chains"></nz-option>
                </nz-select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" *ngIf="currentMissingFields.includes('division')">
                <label>{{ 'agent.fieldLabels.division' | translate }}: <span class="required">*</span></label>
                <nz-select formControlName="division">
                  <nz-option nzValue="food_products" nzLabel="Food Products Division"></nz-option>
                  <nz-option nzValue="beverages" nzLabel="Beverages Division"></nz-option>
                  <nz-option nzValue="household_items" nzLabel="Household Items Division"></nz-option>
                </nz-select>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ COMPLETED FIELDS - Reference Section -->
        <div class="form-section completed-fields-section" *ngIf="getCompletedFields().length > 0">
          <h4>✅ {{ 'agent.sections.completedFields' | translate }}</h4>
          <p class="section-description">{{ 'agent.messages.completedFieldsDescription' | translate }}</p>
          
          <div class="completed-fields-grid">
            <div class="completed-field" *ngFor="let field of getCompletedFields()">
              <div class="field-label">{{ getFieldLabel(field) }}</div>
              <div class="field-value">{{ getFieldValue(field) }}</div>
            </div>
          </div>
        </div>
      </div>
    </form>
    
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeMissingFieldsForm()">
        {{ 'agent.missingForm.cancel' | translate }}
      </button>
      <button nz-button nzType="primary" (click)="saveMissingFieldsForm()">
        {{ 'agent.missingForm.save' | translate }}
      </button>
    </div>
  </div>
</nz-modal>

<!-- Unified Review & Complete Modal -->
<nz-modal 
  [(nzVisible)]="showUnifiedModal" 
  (nzOnCancel)="onUnifiedModalClose()"
  [nzFooter]="null"
  nzWidth="1200px"
  [nzMaskClosable]="false"
  [nzClosable]="true"
  [nzBodyStyle]="{'padding': '0'}"
  [nzClassName]="'unified-modal'"
  nzTitle="📋 Review & Complete Data Entry">

  <div *nzModalContent>
    
    <!-- Progress Bar Section -->
    <div *ngIf="showProgressBar" class="progress-section">
      <div class="progress-container">
        <div class="progress-header">
          <h3>{{ 'agent.progress.processingDocuments' | translate }}</h3>
          <p class="progress-status">{{ progressStatus }}</p>
        </div>
        <nz-progress 
          [nzPercent]="progressValue" 
          [nzStatus]="progressValue === 100 ? 'success' : 'active'"
          [nzShowInfo]="true"
          [nzStrokeWidth]="8">
        </nz-progress>
      </div>
    </div>
    
    <!-- Main Form Content -->
    <form *ngIf="unifiedModalForm && !showProgressBar" [formGroup]="unifiedModalForm">
      
      <!-- Tabs Navigation -->
      <nz-tabset [(nzSelectedIndex)]="selectedTabIndex" nzType="card" nzSize="small">
        
        <!-- Tab 1: Extracted Data -->
        <nz-tab [nzTitle]="extractedDataTabTitle" *ngIf="unifiedModalData.extractedFields.length > 0">
          <div class="modal-section extracted-section">
            <div class="section-header">
              <h3>✅ {{ 'agent.sections.extractedData' | translate }}</h3>
              <button type="button" 
                      nz-button 
                      [nzType]="extractedDataReadOnly ? 'default' : 'primary'"
                      nzSize="small"
                      (click)="toggleExtractedDataEdit(extractedDataReadOnly)">
                <span nz-icon [nzType]="extractedDataReadOnly ? 'edit' : 'save'"></span>
                {{ extractedDataReadOnly ? ('Edit' | translate) : ('agent.buttons.saveChanges' | translate) }}
              </button>
            </div>
            
            <div class="form-grid">
              <!-- Company Information -->
              <div class="form-row" *ngIf="isFieldExtracted('firstName') || isFieldExtracted('firstNameAR')">
                <div class="form-group" *ngIf="isFieldExtracted('firstName')">
                  <label>Company Name (English):</label>
                  <input formControlName="firstName">
                </div>
                <div class="form-group" *ngIf="isFieldExtracted('firstNameAR')">
                  <label>اسم الشركة (عربي):</label>
                  <input formControlName="firstNameAR">
                </div>
              </div>
              
              <div class="form-row" *ngIf="isFieldExtracted('tax') || isFieldExtracted('CustomerType')">
                <div class="form-group" *ngIf="isFieldExtracted('tax')">
                  <label>Tax Number:</label>
                  <input formControlName="tax">
                </div>
                <div class="form-group" *ngIf="isFieldExtracted('CustomerType')">
                  <label>Customer Type:</label>
                  <nz-select formControlName="CustomerType">
                    <nz-option *ngFor="let option of customerTypeOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <div class="form-row" *ngIf="isFieldExtracted('ownerName')">
                <div class="form-group full-width">
                  <label>Owner Name:</label>
                  <input formControlName="ownerName">
                </div>
              </div>
              
              <!-- Address Information -->
              <div class="form-row" *ngIf="isFieldExtracted('buildingNumber') || isFieldExtracted('street')">
                <div class="form-group" *ngIf="isFieldExtracted('buildingNumber')">
                  <label>Building Number:</label>
                  <input formControlName="buildingNumber">
                </div>
                <div class="form-group" *ngIf="isFieldExtracted('street')">
                  <label>Street:</label>
                  <input formControlName="street">
                </div>
              </div>
              
              <div class="form-row" *ngIf="isFieldExtracted('country') || isFieldExtracted('city')">
                <div class="form-group" *ngIf="isFieldExtracted('country')">
                  <label>Country:</label>
                  <nz-select formControlName="country" 
                             nzShowSearch 
                             nzAllowClear
                             [nzPlaceHolder]="'Select or enter country'">
                    <nz-option *ngFor="let option of countryOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
                <div class="form-group" *ngIf="isFieldExtracted('city')">
                  <label>City:</label>
                  <nz-select formControlName="city" 
                             nzShowSearch 
                             nzAllowClear
                             [nzPlaceHolder]="'Select or enter city'">
                    <nz-option *ngFor="let option of cityOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <!-- Sales Information -->
              <div class="form-row" *ngIf="isFieldExtracted('salesOrganization') || isFieldExtracted('distributionChannel')">
                <div class="form-group" *ngIf="isFieldExtracted('salesOrganization')">
                  <label>Sales Organization:</label>
                  <nz-select formControlName="salesOrganization">
                    <nz-option *ngFor="let option of salesOrgOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
                <div class="form-group" *ngIf="isFieldExtracted('distributionChannel')">
                  <label>Distribution Channel:</label>
                  <nz-select formControlName="distributionChannel">
                    <nz-option *ngFor="let option of distributionChannelOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <div class="form-row" *ngIf="isFieldExtracted('division')">
                <div class="form-group">
                  <label>Division:</label>
                  <nz-select formControlName="division">
                    <nz-option *ngFor="let option of divisionOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
            </div>
          </div>
        </nz-tab>
        
        <!-- Tab 2: Missing Data -->
        <nz-tab [nzTitle]="missingDataTabTitle" *ngIf="unifiedModalData.missingFields.length > 0">
          <div class="modal-section missing-section">
            <div class="section-header">
              <h3>❌ {{ 'agent.sections.missingData' | translate }}</h3>
              <span class="missing-count">{{ unifiedModalData.missingFields.length }} {{ 'agent.labels.fields' | translate }}</span>
            </div>
            
            <div class="form-grid">
              <!-- Company Information -->
              <div class="form-row" *ngIf="isFieldMissing('firstName') || isFieldMissing('firstNameAR')">
                <div class="form-group" *ngIf="isFieldMissing('firstName')">
                  <label class="required">Company Name (English):</label>
                  <input formControlName="firstName" placeholder="Enter company name in English">
                </div>
                <div class="form-group" *ngIf="isFieldMissing('firstNameAR')">
                  <label class="required">اسم الشركة (عربي):</label>
                  <input formControlName="firstNameAR" placeholder="أدخل اسم الشركة بالعربية">
                </div>
              </div>
              
              <div class="form-row" *ngIf="isFieldMissing('tax') || isFieldMissing('CustomerType')">
                <div class="form-group" *ngIf="isFieldMissing('tax')">
                  <label class="required">Tax Number:</label>
                  <input formControlName="tax" placeholder="Enter tax registration number">
                </div>
                <div class="form-group" *ngIf="isFieldMissing('CustomerType')">
                  <label class="required">Customer Type:</label>
                  <nz-select formControlName="CustomerType" nzPlaceHolder="Select customer type">
                    <nz-option *ngFor="let option of customerTypeOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <div class="form-row" *ngIf="isFieldMissing('ownerName')">
                <div class="form-group full-width">
                  <label class="required">Owner Name:</label>
                  <input formControlName="ownerName" placeholder="Enter company owner full name">
                </div>
              </div>
              
              <!-- Address Information -->
              <div class="form-row" *ngIf="isFieldMissing('buildingNumber') || isFieldMissing('street')">
                <div class="form-group" *ngIf="isFieldMissing('buildingNumber')">
                  <label class="required">Building Number:</label>
                  <input formControlName="buildingNumber" placeholder="Enter building number">
                </div>
                <div class="form-group" *ngIf="isFieldMissing('street')">
                  <label class="required">Street:</label>
                  <input formControlName="street" placeholder="Enter street name">
                </div>
              </div>
              
              <div class="form-row" *ngIf="isFieldMissing('country') || isFieldMissing('city')">
                <div class="form-group" *ngIf="isFieldMissing('country')">
                  <label class="required">Country:</label>
                  <nz-select formControlName="country" 
                             nzPlaceHolder="Select or enter country"
                             nzShowSearch 
                             nzAllowClear>
                    <nz-option *ngFor="let option of countryOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
                <div class="form-group" *ngIf="isFieldMissing('city')">
                  <label class="required">City:</label>
                  <nz-select formControlName="city" 
                             nzPlaceHolder="Select or enter city"
                             nzShowSearch 
                             nzAllowClear>
                    <nz-option *ngFor="let option of cityOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <!-- Sales Information (Optional) -->
              <div class="form-row">
                <div class="form-group">
                  <label class="optional">Sales Organization (Optional):</label>
                  <nz-select formControlName="salesOrganization" nzPlaceHolder="Select sales organization">
                    <nz-option *ngFor="let option of salesOrgOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
                <div class="form-group">
                  <label class="optional">Distribution Channel (Optional):</label>
                  <nz-select formControlName="distributionChannel" nzPlaceHolder="Select distribution channel">
                    <nz-option *ngFor="let option of distributionChannelOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="optional">Division (Optional):</label>
                  <nz-select formControlName="division" nzPlaceHolder="Select division">
                    <nz-option *ngFor="let option of divisionOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
            </div>
          </div>
        </nz-tab>
        
        <!-- Tab 3: Sales Data -->
        <nz-tab [nzTitle]="salesDataTabTitle">
          <div class="modal-section sales-section">
            <div class="section-header">
              <h3>💼 {{ 'agent.sections.salesData' | translate }} 
                <span class="optional-badge">Optional</span>
              </h3>
              <p class="section-description">Enter sales organization details (optional)</p>
            </div>
            
            <div class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label class="optional">Sales Organization:</label>
                  <nz-select formControlName="salesOrganization" nzPlaceHolder="Select sales organization">
                    <nz-option *ngFor="let option of salesOrgOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
                <div class="form-group">
                  <label class="optional">Distribution Channel:</label>
                  <nz-select formControlName="distributionChannel" nzPlaceHolder="Select distribution channel">
                    <nz-option *ngFor="let option of distributionChannelOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="optional">Division:</label>
                  <nz-select formControlName="division" nzPlaceHolder="Select division">
                    <nz-option *ngFor="let option of divisionOptions" 
                              [nzValue]="option.value" 
                              [nzLabel]="option.label">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
            </div>
          </div>
        </nz-tab>
        
        <!-- Tab 4: Contacts -->
        <nz-tab [nzTitle]="contactsTabTitle">
          <div class="modal-section contacts-section">
            <div class="section-header">
              <h3>👥 {{ 'agent.sections.contacts' | translate }} 
                <span class="contact-count-badge" *ngIf="getValidContactsCount() > 0">{{ getValidContactsCount() }}</span>
              </h3>
              <button type="button" 
                      nz-button 
                      nzType="primary" 
                      nzSize="small" 
                      (click)="openAddContactModal()">
                <span nz-icon nzType="plus"></span> 
                {{ 'agent.buttons.addContact' | translate }}
              </button>
            </div>
            
            <!-- Contacts Table -->
            <div class="contacts-table-container" *ngIf="getValidContactsCount() > 0">
              <table class="contacts-table">
                <thead>
                  <tr>
                    <th class="col-name">Name</th>
                    <th class="col-job">Job Title</th>
                    <th class="col-email">Email</th>
                    <th class="col-mobile">Mobile</th>
                    <th class="col-language">Language</th>
                    <th class="col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let contact of unifiedContactsArray.controls; let i = index" 
                      class="contact-row"
                      [class.hidden-row]="!isValidContact(contact)">
                    <ng-container *ngIf="isValidContact(contact)">
                      <td class="col-name">
                        <span class="contact-name">{{ contact.get('name')?.value }}</span>
                      </td>
                      <td class="col-job">
                        <span class="contact-job">{{ contact.get('jobTitle')?.value }}</span>
                      </td>
                      <td class="col-email">
                        <span class="contact-email">{{ contact.get('email')?.value }}</span>
                      </td>
                      <td class="col-mobile">
                        <span class="contact-mobile">{{ contact.get('mobile')?.value }}</span>
                      </td>
                      <td class="col-language">
                        <span class="contact-language-badge">{{ contact.get('preferredLanguage')?.value }}</span>
                      </td>
                      <td class="col-actions">
                        <div class="action-buttons">
                          <button type="button" 
                                  nz-button 
                                  nzType="text" 
                                  nzSize="small"
                                  class="action-btn edit-btn"
                                  (click)="editContactInModal(i)"
                                  title="Edit">
                            <span nz-icon nzType="edit"></span>
                          </button>
                          <button type="button" 
                                  nz-button 
                                  nzType="text" 
                                  nzDanger
                                  nzSize="small"
                                  class="action-btn delete-btn"
                                  (click)="removeContactFromUnifiedForm(i)"
                                  title="Delete">
                            <span nz-icon nzType="delete"></span>
                          </button>
                        </div>
                      </td>
                    </ng-container>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Empty State -->
            <div class="contacts-empty-state" *ngIf="getValidContactsCount() === 0">
              <nz-empty
                nzNotFoundImage="simple"
                [nzNotFoundContent]="emptyContactsTemplate">
              </nz-empty>
              <ng-template #emptyContactsTemplate>
                <p class="empty-text">{{ 'agent.messages.noContactsAdded' | translate }}</p>
              </ng-template>
            </div>
          </div>
        </nz-tab>
        
        <!-- Tab 5: Documents -->
        <nz-tab [nzTitle]="documentsTabTitle">
          <div class="modal-section documents-section">
            <div class="section-header">
              <h4>📎 {{ 'agent.sections.attachedDocuments' | translate }}</h4>
              <button type="button" 
                      nz-button 
                      nzType="primary" 
                      nzSize="small" 
                      (click)="triggerAddDocument()">
                <span nz-icon nzType="plus"></span> 
                {{ 'agent.buttons.addDocument' | translate }}
              </button>
            </div>
            
            <!-- Hidden file input for adding documents -->
            <input type="file" 
                   #addDocumentInput 
                   id="addDocumentInput" 
                   multiple 
                   accept="image/*,.pdf" 
                   (change)="onAddDocument($event)" 
                   style="display: none;">

            <!-- Documents Table - Professional Design (from new-request.component.html) -->
            <div class="documents-table-container" *ngIf="getDocumentsCount() > 0">
              <table class="documents-table">
                <thead>
                  <tr>
                    <th class="col-icon">Type</th>
                    <th class="col-name">Document Name</th>
                    <th class="col-doc-type">Document Type</th>
                    <th class="col-size">Size</th>
                    <th class="col-date">Upload Date</th>
                    <th class="col-actions">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let doc of (unifiedModalData?.documents || []); let i = index; trackBy: trackByIndex" 
                      class="document-row" 
                      [class.clickable]="canPreview(doc)"
                      (click)="handleDocumentClick(doc); $event.stopPropagation(); $event.preventDefault()">
                    
                    <!-- File Type Icon -->
                    <td class="col-icon">
                      <div class="file-type-icon" [attr.data-type]="isPdf(doc) ? 'pdf' : isImage(doc) ? 'image' : 'other'">
                        <span *ngIf="isPdf(doc)" class="pdf-icon">📄</span>
                        <span *ngIf="isImage(doc)" class="image-icon">🖼️</span>
                        <span *ngIf="!isPdf(doc) && !isImage(doc)" class="other-icon">📁</span>
                      </div>
                    </td>
                    
                    <!-- Document Name -->
                    <td class="col-name">
                      <div class="doc-name-cell">
                        <span class="doc-name" [title]="doc.value?.name">{{ doc.value?.name }}</span>
                      </div>
                    </td>
                    
                    <!-- Document Type (Commercial Registration, Tax Card, etc.) -->
                    <td class="col-doc-type">
                      <span class="doc-type-badge">{{ getDocumentTypeLabel(doc.value) }}</span>
                    </td>
                    
                    <!-- File Size -->
                    <td class="col-size">
                      <span class="doc-size">{{ formatFileSize(doc.value?.size) }}</span>
                    </td>
                    
                    <!-- Upload Date -->
                    <td class="col-date">
                      <span class="doc-date">{{ doc.value?.uploadedAt | date: 'short' }}</span>
                    </td>
                    
                    <!-- Actions -->
                    <td class="col-actions" (click)="$event.stopPropagation(); $event.preventDefault()">
                      <div class="action-buttons">
                        <!-- Preview Button -->
                        <button 
                                type="button"
                                nz-button 
                                nzType="text" 
                                nzSize="small"
                                class="action-btn preview-btn"
                                (click)="previewDocument(doc); $event.stopPropagation(); $event.preventDefault()" 
                                *ngIf="canPreview(doc)"
                                title="Preview">
                          <span nz-icon nzType="eye"></span>
                        </button>
                        
                        <!-- Download Button -->
                        <button 
                                type="button"
                                nz-button 
                                nzType="text" 
                                nzSize="small"
                                class="action-btn download-btn"
                                (click)="downloadDocument(doc); $event.stopPropagation(); $event.preventDefault()"
                                title="Download">
                          <span nz-icon nzType="download"></span>
                        </button>
                        
                        <!-- Delete Button -->
                        <button 
                                type="button"
                                nz-button 
                                nzType="text" 
                                nzDanger
                                nzSize="small"
                                class="action-btn delete-btn"
                                (click)="removeDocument(i); $event.stopPropagation(); $event.preventDefault()"
                                title="Delete">
                          <span nz-icon nzType="delete"></span>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </nz-tab>
        
      </nz-tabset>
      
    </form>
    
    <!-- Modal Footer -->
    <div class="modal-footer unified-footer">
      <div class="footer-info">
        <span class="info-item extracted" *ngIf="unifiedModalData.extractedFields.length > 0">
          ✅ {{ unifiedModalData.extractedFields.length }} extracted
        </span>
        <span class="info-item missing" *ngIf="unifiedModalData.missingFields.length > 0">
          ⚠️ {{ unifiedModalData.missingFields.length }} missing
        </span>
        <span class="info-item contacts">
          👥 {{ unifiedContactsArray.length }} contacts
        </span>
      </div>
      
      <div class="footer-actions">
        <button nz-button nzType="default" (click)="showUnifiedModal = false">
          {{ 'Cancel' | translate }}
        </button>
        <button nz-button 
                nzType="primary" 
                (click)="saveUnifiedModal()"
                [disabled]="unifiedModalForm.invalid">
          <span nz-icon nzType="save"></span>
          {{ 'agent.buttons.saveAndSubmit' | translate }}
        </button>
      </div>
    </div>
  </div>
</nz-modal>

<!-- Document Preview Modal (from new-request.component.html) -->
<nz-modal
  [(nzVisible)]="showDocumentPreviewModal"
  [nzTitle]="'agent.titles.documentPreview' | translate"
  (nzOnCancel)="closeDocumentPreview()"
  [nzFooter]="previewFooterTemplate"
  nzWidth="900px"
  nzClassName="document-preview-modal">
  
  <ng-container *nzModalContent>
    <div class="preview-container">
      <!-- PDF Preview -->
      <div *ngIf="previewDocumentType === 'pdf'" class="pdf-preview">
        <iframe 
          [src]="previewDocumentUrl" 
          frameborder="0" 
          width="100%" 
          height="600px"
          style="border-radius: 8px;">
        </iframe>
      </div>

      <!-- Image Preview -->
      <div *ngIf="previewDocumentType === 'image'" class="image-preview">
        <img 
          [src]="previewDocumentUrl" 
          alt="Document Preview"
          style="max-width: 100%; height: auto; border-radius: 8px; display: block; margin: 0 auto;">
      </div>

      <!-- Unsupported Type -->
      <div *ngIf="previewDocumentType === 'other'" class="unsupported-preview">
        <nz-empty
          nzNotFoundImage="simple"
          [nzNotFoundContent]="'Preview not available for this file type. Please download to view.'">
        </nz-empty>
      </div>
    </div>
  </ng-container>

  <!-- Footer Template -->
  <ng-template #previewFooterTemplate>
    <div class="preview-footer">
      <button nz-button nzType="default" (click)="closeDocumentPreview()">
        <span nz-icon nzType="close"></span>
        {{ 'Close' | translate }}
      </button>
      <button nz-button nzType="primary" (click)="downloadDocument(currentPreviewDocument)">
        <span nz-icon nzType="download"></span>
        {{ 'Download' | translate }}
      </button>
    </div>
  </ng-template>
</nz-modal>

<!-- Add/Edit Contact Modal (Innovative Design) -->
<nz-modal
  [(nzVisible)]="showContactModal"
  [nzTitle]="contactModalTitle"
  (nzOnCancel)="closeContactModal()"
  [nzFooter]="contactModalFooter"
  nzWidth="600px"
  nzClassName="contact-modal">
  
  <ng-container *nzModalContent>
    <form [formGroup]="contactModalForm" class="contact-form">
      <!-- Row 1: Name & Job Title -->
      <div class="modal-form-row">
        <div class="modal-form-group">
          <label class="required">
            <span nz-icon nzType="user"></span>
            {{ 'agent.contactLabels.name' | translate }}
          </label>
          <input nz-input 
                 formControlName="name" 
                 placeholder="Ahmed Mohamed">
        </div>
        <div class="modal-form-group">
          <label class="required">
            <span nz-icon nzType="idcard"></span>
            {{ 'agent.contactLabels.jobTitle' | translate }}
          </label>
          <input nz-input 
                 formControlName="jobTitle" 
                 placeholder="Sales Manager">
        </div>
      </div>

      <!-- Row 2: Email & Mobile -->
      <div class="modal-form-row">
        <div class="modal-form-group">
          <label class="required">
            <span nz-icon nzType="mail"></span>
            {{ 'agent.contactLabels.email' | translate }}
          </label>
          <input nz-input 
                 type="email"
                 formControlName="email" 
                 placeholder="ahmed@company.com">
        </div>
        <div class="modal-form-group">
          <label class="required">
            <span nz-icon nzType="phone"></span>
            {{ 'agent.contactLabels.mobile' | translate }}
          </label>
          <input nz-input 
                 formControlName="mobile" 
                 placeholder="+201234567890">
        </div>
      </div>

      <!-- Row 3: Landline & Language -->
      <div class="modal-form-row">
        <div class="modal-form-group">
          <label>
            <span nz-icon nzType="phone"></span>
            {{ 'agent.contactLabels.landline' | translate }}
            <span class="optional-badge">Optional</span>
          </label>
          <input nz-input 
                 formControlName="landline" 
                 placeholder="02-1234567">
        </div>
        <div class="modal-form-group">
          <label class="required">
            <span nz-icon nzType="global"></span>
            {{ 'agent.contactLabels.language' | translate }}
          </label>
          <nz-select formControlName="preferredLanguage" 
                     nzPlaceHolder="Select language">
            <nz-option nzValue="Arabic" [nzLabel]="'Arabic' | translate"></nz-option>
            <nz-option nzValue="English" [nzLabel]="'English' | translate"></nz-option>
          </nz-select>
        </div>
      </div>
    </form>
  </ng-container>

  <!-- Footer Template -->
  <ng-template #contactModalFooter>
    <div class="contact-modal-footer">
      <button nz-button nzType="default" (click)="closeContactModal()">
        <span nz-icon nzType="close"></span>
        {{ 'Cancel' | translate }}
      </button>
      <button nz-button 
              nzType="primary" 
              (click)="saveContactFromModal()"
              [disabled]="contactModalForm.invalid">
        <span nz-icon nzType="check"></span>
        {{ isEditingContact ? ('Update' | translate) : ('Add' | translate) }}
      </button>
    </div>
  </ng-template>
</nz-modal>

<!-- Document Upload Modal - New Design -->
<nz-modal 
  [(nzVisible)]="showDocumentModal" 
  nzTitle="📄 {{ 'agent.documentModal.title' | translate }}"
  (nzOnCancel)="closeDocumentModal()"
  [nzFooter]="null"
  nzWidth="800px">
  
  <div *nzModalContent class="document-modal-content">
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active">
        <span class="step-number">📄</span>
        <span class="step-title">{{ 'agent.steps.review' | translate }}</span>
      </div>
    </div>

    <!-- Review & Metadata -->
    <div class="review-step">
      <form [formGroup]="documentMetadataForm">
        <div formArrayName="documents">
          <div 
            *ngFor="let docGroup of documentsFA.controls; let i = index" 
            [formGroupName]="i" 
            class="document-form">
            
            <nz-card [nzTitle]="('agent.documentModal.document' | translate) + ' ' + (i + 1)" nzSize="small">
              <div class="form-row">
                <div class="form-group">
                  <label>{{ 'agent.documentModal.fileName' | translate }}:</label>
                  <input formControlName="name" readonly>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>{{ 'agent.documentModal.country' | translate }}:</label>
                  <nz-select formControlName="country">
                    <nz-option 
                      *ngFor="let country of countriesList" 
                      [nzValue]="country" 
                      [nzLabel]="country">
                    </nz-option>
                  </nz-select>
                </div>
                
                <div class="form-group">
                  <label>{{ 'agent.documentModal.type' | translate }}:</label>
                  <nz-select formControlName="type">
                    <nz-option 
                      *ngFor="let type of allDocumentTypes" 
                      [nzValue]="type" 
                      [nzLabel]="type">
                    </nz-option>
                  </nz-select>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group full-width">
                  <label>{{ 'agent.documentModal.description' | translate }}:</label>
                  <textarea formControlName="description" rows="2"></textarea>
                </div>
              </div>
            </nz-card>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Footer Buttons -->
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeDocumentModal()">
        {{ 'agent.buttons.cancel' | translate }}
      </button>
      
      <button 
        nz-button 
        nzType="primary" 
        (click)="saveDocuments()" 
        [disabled]="!documentMetadataForm.valid">
        {{ 'agent.buttons.saveAndSubmit' | translate }}
      </button>
    </div>
  </div>
</nz-modal>

<!-- Hidden file input for direct upload (outside modal) -->
<input 
  type="file" 
  #directFileInput
  id="directFileInput"
  multiple 
  accept="image/*" 
  (change)="onFileSelected($event)"
  style="display: none;">
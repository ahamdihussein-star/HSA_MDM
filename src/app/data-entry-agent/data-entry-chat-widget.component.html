<!-- Floating Chat Widget -->
<div class="chat-widget-container">
  <!-- Toggle Button -->
  <button 
    class="chat-toggle-button" 
    (click)="toggleChat()"
    *ngIf="!isOpen"
    nz-tooltip
    nzTooltipTitle="Data Entry AI Assistant"
    nzTooltipPlacement="left">
    <span aria-hidden="true">ğŸ¤–</span>
  </button>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="isOpen">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <h3>ğŸ¤– Data Entry AI Assistant</h3>
        <p class="user-greeting">{{ getCurrentUserName() }}</p>
      </div>
      <div class="header-actions">
        <button 
          class="minimize-btn" 
          (click)="minimizeChat()"
          nz-tooltip
          nzTooltipTitle="Minimize">
          <span aria-hidden="true">â€“</span>
        </button>
        <button 
          class="close-btn" 
          (click)="closeChat()"
          nz-tooltip
          nzTooltipTitle="Close">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="chat-body">
      <!-- Messages -->
      <div class="messages-container">
        <div 
          *ngFor="let message of messages" 
          class="message"
          [attr.data-message-id]="message.id"
          [attr.data-message-type]="message.type"
          [ngClass]="{'user-message': message.role === 'user', 'assistant-message': message.role === 'assistant'}">
          
          <!-- Text Messages -->
          <div *ngIf="message.type === 'text'" [innerHTML]="formatMessage(message.content)"></div>

          <!-- Actions (Quick Buttons) -->
          <ng-container *ngIf="message.type === 'actions'">
            <div class="action-buttons">
              <div class="action-title" [innerHTML]="formatMessage(message.content)"></div>
              <button 
                *ngFor="let btn of message.data?.buttons" 
                class="action-btn"
                (click)="onButtonClick(btn.action, btn.data)"
                [innerHTML]="btn.text">
              </button>
            </div>
          </ng-container>

          <!-- Confirmation Messages -->
          <div *ngIf="message.type === 'confirmation'" class="confirmation-message">
            <div [innerHTML]="formatMessage(message.content)"></div>
            <div *ngIf="message.data?.buttons" class="confirmation-buttons">
              <button 
                *ngFor="let btn of message.data.buttons" 
                class="confirmation-btn"
                (click)="onButtonClick(btn.action, btn.data)"
                [innerHTML]="btn.text">
              </button>
            </div>
          </div>
          
          <!-- Loading Messages -->
          <div *ngIf="message.type === 'loading'" class="loading-message">
            <i nz-icon nzType="loading" nzTheme="outline"></i>
            {{ message.content }}
          </div>
          
          <!-- Progress Messages -->
          <div *ngIf="message.type === 'progress'" class="progress-message">
            <nz-progress [nzPercent]="extractionProgress" [nzShowInfo]="false"></nz-progress>
            <p>{{ message.content }}</p>
          </div>
          
          <!-- Dropdown Messages -->
          <div *ngIf="message.type === 'dropdown'" class="dropdown-message">
            <p class="dropdown-label">{{ message.content }}</p>
            <nz-select 
              [nzPlaceHolder]="'Ø§Ø®ØªØ± ' + (message.data.fieldLabel || message.data.label || message.data.field)"
              (ngModelChange)="onDropdownSelection(message.data.field, $event)"
              style="width: 100%;">
              <nz-option 
                *ngFor="let option of message.data.options" 
                [nzValue]="option.value || option" 
                [nzLabel]="option.label || option">
              </nz-option>
            </nz-select>
          </div>
          
          <!-- Contact Form Messages -->
          <div *ngIf="message.type === 'contact-form'" class="contact-form-message">
            <p>{{ message.content }}</p>
            <button 
              nz-button 
              nzType="primary" 
              (click)="openContactForm()">
              <i nz-icon nzType="user-add" nzTheme="outline"></i>
              Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
            </button>
          </div>
        </div>
      </div>

      <!-- Accumulated Files Panel -->
      <div class="accumulated-files-panel" *ngIf="showAccumulatedFiles">
        <div class="panel-header">
          <h4>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© / Selected Files</h4>
          <button nz-button nzType="text" nzSize="small" (click)="clearAccumulatedFiles()">
            <i nz-icon nzType="delete" nzTheme="outline"></i>
          </button>
        </div>
        <div class="files-list">
          <div *ngFor="let file of accumulatedFiles; let i = index" class="file-item">
            <span>{{ file.name }}</span>
            <button nz-button nzType="text" nzSize="small" (click)="removeAccumulatedFile(i)">
              <i nz-icon nzType="close" nzTheme="outline"></i>
            </button>
          </div>
        </div>
        <div class="panel-footer">
          <button nz-button nzType="default" (click)="clearAccumulatedFiles()">
            Ø¥Ù„ØºØ§Ø¡ / Cancel
          </button>
          <button nz-button nzType="primary" (click)="proceedWithAccumulatedFiles()">
            Ù…ØªØ§Ø¨Ø¹Ø© / Continue
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Footer -->
    <div class="chat-footer">
      <!-- Inline fallback quick actions if message rendering fails -->
      <div class="inline-quick-actions" *ngIf="showInlineQuickActions">
        <button class="action-btn" (click)="onButtonClick('upload')">ğŸ“„ Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯ / Upload Document</button>
        <button class="action-btn" (click)="onButtonClick('manual')">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ / Manual Entry</button>
        <button class="action-btn" (click)="onButtonClick('help')">â“ Ù…Ø³Ø§Ø¹Ø¯Ø© / Help</button>
      </div>
      
      <!-- Debug info for inline actions -->
      <div *ngIf="showInlineQuickActions" style="font-size: 10px; color: #666; margin-bottom: 5px;">
        Debug: Inline quick actions enabled ({{ showInlineQuickActions }})
      </div>
      <div class="input-container">
        <input 
          type="file" 
          id="file-upload"
          multiple 
          accept="image/*" 
          (change)="onFileSelected($event)"
          style="display: none;">
        
        <button 
          class="attach-btn" 
          (click)="onButtonClick('upload')"
          nz-tooltip
          nzTooltipTitle="Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯Ø§Øª / Upload Documents"
          nzTooltipPlacement="top">
          <span aria-hidden="true">ğŸ“</span>
          <span *ngIf="accumulatedFiles.length > 0" class="file-count">{{ accumulatedFiles.length }}</span>
        </button>
        
        <input 
          id="chat-message-input"
          name="chat-message-input"
          type="text" 
          [(ngModel)]="newMessage" 
          (keydown)="onEnterKey($event)"
          placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§... / Type your message here..."
          [disabled]="loading"
          aria-label="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§ / Type your message here">
        
        <button 
          class="send-btn" 
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || loading"
          nz-tooltip
          nzTooltipTitle="Ø¥Ø±Ø³Ø§Ù„ / Send"
          nzTooltipPlacement="top">
          <span aria-hidden="true">â¤</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Upload Modal Template -->
<ng-template #documentModalTemplate>
  <div class="document-modal-content">
    <!-- Debug info -->
    <div style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; font-size: 12px;">
      Debug: documentsFA.length = {{ documentsFA.length }}, pendingFiles.length = {{ pendingFiles.length }}
    </div>
    
    <form [formGroup]="documentMetadataForm">
      <div formArrayName="documents">
        <!-- Show message if no documents -->
        <div *ngIf="documentsFA.length === 0" style="text-align: center; padding: 20px; color: #666;">
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ / No documents to display</p>
          <p>pendingFiles: {{ pendingFiles.length }}</p>
        </div>
        
        <div 
          *ngFor="let docGroup of documentsFA.controls; let i = index" 
          [formGroupName]="i" 
          class="document-form">
          
          <nz-card [nzTitle]="'Ù…Ø³ØªÙ†Ø¯ ' + (i + 1)" nzSize="small">
            <div class="form-row">
              <div class="form-group">
                <label [for]="'fileName_' + i">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù / File Name:</label>
                <input 
                  [id]="'fileName_' + i"
                  [name]="'fileName_' + i"
                  formControlName="name" 
                  readonly
                  aria-label="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù / File Name">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label [for]="'country_' + i">Ø§Ù„Ø¨Ù„Ø¯ / Country:</label>
                <nz-select 
                  [id]="'country_' + i"
                  formControlName="country" 
                  (ngModelChange)="onCountryChange($event, i)"
                  aria-label="Ø§Ù„Ø¨Ù„Ø¯ / Country">
                  <nz-option 
                    *ngFor="let country of countriesList" 
                    [nzValue]="country" 
                    [nzLabel]="country">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="form-group">
                <label [for]="'documentType_' + i">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ / Document Type:</label>
                <nz-select 
                  [id]="'documentType_' + i"
                  formControlName="type"
                  aria-label="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ / Document Type">
                  <nz-option 
                    *ngFor="let type of getDocumentTypesByCountry(docGroup.get('country')?.value || '')" 
                    [nzValue]="type" 
                    [nzLabel]="type">
                  </nz-option>
                </nz-select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label [for]="'description_' + i">Ø§Ù„ÙˆØµÙ / Description:</label>
                <textarea 
                  [id]="'description_' + i"
                  [name]="'description_' + i"
                  formControlName="description" 
                  rows="2"
                  aria-label="Ø§Ù„ÙˆØµÙ / Description"></textarea>
              </div>
            </div>
          </nz-card>
        </div>
      </div>
    </form>
    
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeDocumentModal()">
        Ø¥Ù„ØºØ§Ø¡ / Cancel
      </button>
      <button nz-button nzType="primary" (click)="saveDocuments()" [disabled]="!isDocumentFormValid">
        Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© / Save & Continue
      </button>
    </div>
  </div>
</ng-template>

<!-- Hidden file input for programmatic uploads (used by quick actions) -->
<input 
  type="file" 
  id="file-upload"
  style="display: none"
  multiple
  accept="image/*"
  (change)="onFileSelected($event)">

<!-- Contact Form Modal -->
<nz-modal 
  [(nzVisible)]="showContactForm" 
  nzTitle="Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ / Add Contact"
  (nzOnCancel)="closeContactForm()"
  [nzFooter]="null"
  nzWidth="600px">
  
  <form [formGroup]="contactForm">
    <div class="contact-form-content">
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ø§Ø³Ù… / Name: *</label>
          <input formControlName="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ / Job Title: *</label>
          <input formControlName="jobTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Email: *</label>
          <input formControlName="email" type="email" placeholder="example@company.com">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø¬ÙˆØ§Ù„ / Mobile: *</label>
          <input formControlName="mobile" placeholder="+966501234567">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£Ø±Ø¶ÙŠ / Landline:</label>
          <input formControlName="landline" placeholder="+966112345678">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙØ¶Ù„Ø© / Preferred Language:</label>
          <nz-select formControlName="preferredLanguage">
            <nz-option nzValue="Arabic" nzLabel="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"></nz-option>
            <nz-option nzValue="English" nzLabel="English"></nz-option>
          </nz-select>
        </div>
      </div>
    </div>
  </form>
  
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="closeContactForm()">
      Ø¥Ù„ØºØ§Ø¡ / Cancel
    </button>
    <button nz-button nzType="primary" (click)="saveContactForm()" [disabled]="!contactForm.valid">
      Ø­ÙØ¸ / Save
    </button>
  </div>
</nz-modal>

<!-- Edit Form Modal -->
<nz-modal 
  [(nzVisible)]="showEditForm" 
  nzTitle="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© / Edit Extracted Data"
  (nzOnCancel)="closeEditForm()"
  [nzFooter]="null"
  nzWidth="700px"
  [nzMaskClosable]="false"
  [nzClosable]="true">
  
  <!-- âœ… ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ *ngIf ØµØ­ -->
  <div *nzModalContent>
    <form *ngIf="editForm" [formGroup]="editForm">
      <div class="edit-form-content">
      <!-- Company Information -->
      <div class="form-section">
        <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© / Company Information</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) / Company Name (English):</label>
            <input formControlName="firstName" placeholder="Company Name">
          </div>
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© (Ø¹Ø±Ø¨ÙŠ) / Company Name (Arabic):</label>
            <input formControlName="firstNameAR" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ / Tax Number:</label>
            <input formControlName="tax" placeholder="Tax Number">
          </div>
          <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ / Customer Type:</label>
            <nz-select formControlName="CustomerType">
              <nz-option nzValue="Corporate" nzLabel="Corporate"></nz-option>
              <nz-option nzValue="SME" nzLabel="SME"></nz-option>
              <nz-option nzValue="Individual" nzLabel="Individual"></nz-option>
            </nz-select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ / Owner Name:</label>
            <input formControlName="ownerName" placeholder="Owner Name">
          </div>
        </div>
      </div>

      <!-- Address Information -->
      <div class="form-section">
        <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Address Information</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰ / Building Number:</label>
            <input formControlName="buildingNumber" placeholder="Building Number">
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø´Ø§Ø±Ø¹ / Street:</label>
            <input formControlName="street" placeholder="Street Address">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„Ø¯ÙˆÙ„Ø© / Country:</label>
            <nz-select formControlName="country">
              <nz-option nzValue="Egypt" nzLabel="Egypt"></nz-option>
              <nz-option nzValue="Saudi Arabia" nzLabel="Saudi Arabia"></nz-option>
              <nz-option nzValue="United Arab Emirates" nzLabel="United Arab Emirates"></nz-option>
              <nz-option nzValue="Yemen" nzLabel="Yemen"></nz-option>
            </nz-select>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / City:</label>
            <input formControlName="city" placeholder="City">
          </div>
        </div>
      </div>

      <!-- Sales Information -->
      <div class="form-section">
        <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª / Sales Information</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Ù…Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª / Sales Organization:</label>
            <nz-select formControlName="salesOrganization">
              <nz-option nzValue="egypt_cairo_office" nzLabel="Egypt - Cairo Head Office"></nz-option>
              <nz-option nzValue="egypt_alexandria_branch" nzLabel="Egypt - Alexandria Branch"></nz-option>
              <nz-option nzValue="egypt_giza_branch" nzLabel="Egypt - Giza Branch"></nz-option>
              <nz-option nzValue="ksa_riyadh_office" nzLabel="Saudi Arabia - Riyadh Office"></nz-option>
              <nz-option nzValue="ksa_jeddah_branch" nzLabel="Saudi Arabia - Jeddah Branch"></nz-option>
            </nz-select>
          </div>
          <div class="form-group">
            <label>Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ / Distribution Channel:</label>
            <nz-select formControlName="distributionChannel">
              <nz-option nzValue="direct_sales" nzLabel="Direct Sales"></nz-option>
              <nz-option nzValue="authorized_distributors" nzLabel="Authorized Distributors"></nz-option>
              <nz-option nzValue="retail_chains" nzLabel="Retail Chains"></nz-option>
            </nz-select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„Ù‚Ø³Ù… / Division:</label>
            <nz-select formControlName="division">
              <nz-option nzValue="food_products" nzLabel="Food Products Division"></nz-option>
              <nz-option nzValue="beverages" nzLabel="Beverages Division"></nz-option>
              <nz-option nzValue="household_items" nzLabel="Household Items Division"></nz-option>
            </nz-select>
          </div>
        </div>
        </div>
      </div>
    </form>
    
    <!-- âœ… Footer buttons -->
    <div class="modal-footer">
      <button nz-button nzType="default" (click)="closeEditForm()">
        Ø¥Ù„ØºØ§Ø¡ / Cancel
      </button>
      <button nz-button nzType="primary" (click)="saveEditForm()">
        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª / Save Changes
      </button>
    </div>
  </div>
</nz-modal>

<!-- Uploaded Documents Display -->
<div *ngIf="getUploadedDocuments().length > 0" class="uploaded-documents">
  <h4>Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© / Uploaded Documents</h4>
  <div class="documents-grid">
    <div *ngFor="let doc of getUploadedDocuments(); let i = index" class="document-card">
      <div class="document-info">
        <h5>{{ doc.name }}</h5>
        <p>{{ doc.type }} - {{ (doc.size / 1024).toFixed(2) }}KB</p>
      </div>
      <button 
        nz-button 
        nzType="text" 
        nzDanger 
        (click)="removeDocument(i)">
        <i nz-icon nzType="delete" nzTheme="outline"></i>
      </button>
    </div>
  </div>
</div>

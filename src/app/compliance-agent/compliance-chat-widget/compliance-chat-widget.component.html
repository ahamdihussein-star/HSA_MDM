<!-- Floating Chat Widget (Same as Data Entry Agent) -->
<div class="chat-widget-container">
  <!-- Toggle Button -->
  <button 
    class="chat-toggle-button" 
    (click)="toggleChat()"
    *ngIf="isMinimized || !isOpen"
    nz-tooltip
    [nzTooltipTitle]="t('وكيل الامتثال', 'Compliance Agent')"
    nzTooltipPlacement="left">
    <img src="assets/img/agent-icon.png" alt="Compliance Agent" class="agent-icon">
  </button>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="isOpen && !isMinimized">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <h3>
          <img src="assets/img/agent-icon.png" alt="Compliance Agent" class="header-agent-icon">
          {{ t('وكيل الامتثال', 'Compliance Agent') }}
        </h3>
      </div>
      <div class="header-actions">
        <button 
          class="minimize-btn" 
          (click)="minimizeChat()"
          nz-tooltip
          [nzTooltipTitle]="t('تصغير', 'Minimize')">
          <span aria-hidden="true">–</span>
        </button>
        <button 
          class="close-btn" 
          (click)="closeChat()"
          nz-tooltip
          [nzTooltipTitle]="t('إغلاق', 'Close')">
          <span aria-hidden="true">×</span>
        </button>
      </div>
    </div>

    <!-- Chat Body (Same as Data Entry Agent) -->
    <div class="chat-body" #messagesContainer>
      <div class="messages-container">
        
        <!-- Message Loop -->
        <div 
          *ngFor="let message of messages" 
          class="message"
          [ngClass]="{'user-message': message.role === 'user', 'assistant-message': message.role === 'assistant'}">
          
          <!-- Thinking Indicator -->
          <div *ngIf="message.isThinking" class="thinking-indicator-message">
            <div class="thinking-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <span class="thinking-text">{{ message.content }}</span>
          </div>
          
          <!-- Text Content -->
          <div *ngIf="!message.isThinking && message.type !== 'search_results'" 
               class="message-content"
               [innerHTML]="message.content">
          </div>
          
          <!-- Search Results Message -->
          <div *ngIf="message.type === 'search_results'">
            <div [innerHTML]="message.content"></div>
            
            <div class="search-results" *ngIf="message.data?.results && message.data.results.length > 0">
              <div 
                class="result-card" 
                *ngFor="let result of message.data.results.slice(0, 3)"
                (click)="viewSanctionDetails(result)"
                style="cursor: pointer;">
                <div class="result-header">
                  <div class="company-info">
                    <strong>{{ result.name || result.first_name }}</strong>
                    <span class="country">{{ result.country || result.countries?.[0] || 'Unknown' }}</span>
                  </div>
                  <div class="result-badges">
                    <span class="risk-badge" [ngClass]="'risk-' + (result.riskLevel || 'medium')?.toLowerCase()">
                      {{ result.riskLevel || 'Medium' }}
                    </span>
                    <span class="confidence-badge">{{ result.confidence || 85 }}%</span>
                  </div>
                </div>
                <div class="result-summary">
                  <span class="sector">{{ result.sector || result.un_list_type || 'General' }}</span>
                  <span class="view-details">{{ t('عرض التفاصيل', 'View Details') }} →</span>
                </div>
                <div class="view-details-hint">
                  <i>{{ t('اضغط لعرض التفاصيل الكاملة', 'Click to view full details') }}</i>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Expandable Details Section -->
          <div *ngIf="message.isExpandable && message.isExpanded && message.data?.requests" class="expandable-section">
            <div class="expand-content">
              <div *ngFor="let req of message.data.requests" class="company-item">
                <span class="check-icon">✓</span>
                <span class="company-name">{{ req.firstName }}</span>
                <span class="company-country">{{ req.country }}</span>
              </div>
            </div>
          </div>
          
          <!-- Smart Action Buttons -->
          <div *ngIf="message.buttons && message.buttons.length > 0" class="smart-action-buttons">
            <!-- Thinking Indicator -->
            <div *ngIf="message.isThinking" class="thinking-indicator">
              <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <span class="thinking-text">{{ message.content }}</span>
            </div>
            
            <!-- Smart Choice Cards -->
            <ng-container *ngIf="!message.isThinking">
              <div class="choice-cards">
                <div 
                  *ngFor="let button of message.buttons"
                  class="choice-card"
                  [ngClass]="'card-' + (button.style || 'primary')"
                  (click)="handleButtonAction(button.action, button.value)">
                  <div class="card-icon">
                    <i nz-icon [nzType]="getButtonIcon(button.action)"></i>
                  </div>
                  <div class="card-content">
                    <div class="card-title">{{ getButtonTitle(button.text) }}</div>
                    <div class="card-subtitle">{{ getButtonSubtitle(button.text) }}</div>
                  </div>
                  <div class="card-arrow">→</div>
                </div>
              </div>
            </ng-container>
          </div>
          
        </div>
        
        <!-- Loading Message -->
        <div class="message assistant-message" *ngIf="loading">
          <div class="loading-message">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Chat Footer (Input Area) -->
    <div class="chat-footer" *ngIf="currentWorkflow === 'manual'">
      <div class="input-container">
        <input 
          type="text" 
          name="chatInput"
          [(ngModel)]="newMessage"
          (keyup.enter)="sendMessage()"
          [placeholder]="t('اكتب اسم الشركة...', 'Type company name...')"
          [disabled]="loading"
        />
        <button 
          class="send-button" 
          (click)="sendMessage()"
          [disabled]="loading || !newMessage.trim()">
          <span>➤</span>
        </button>
      </div>
    </div>
    
  </div>
</div>


<!-- Compliance Agent Component -->
<div class="compliance-agent-container">
  
  <!-- Header Section -->
  <div class="header-section">
    <nz-card>
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">
            <i nz-icon nzType="security-scan" nzTheme="outline"></i>
            Compliance Agent
          </h1>
          <p class="page-description">
            Search for company sanctions and compliance information using multiple databases
          </p>
        </div>
        
        <div class="header-actions">
          <button nz-button nzType="default" nzSize="large" (click)="clearSearch()">
            <i nz-icon nzType="clear"></i>
            Clear
          </button>
        </div>
      </div>
    </nz-card>
  </div>
  
  <!-- Search Form Section -->
  <div class="search-section">
    <nz-card>
      <!-- Search Mode Toggle -->
      <div class="search-mode-toggle">
        <nz-button-group>
          <button 
            nz-button 
            [nzType]="searchMode === 'manual' ? 'primary' : 'default'"
            (click)="switchSearchMode('manual')"
          >
            <i nz-icon nzType="edit"></i>
            Manual Search
          </button>
          <button 
            nz-button 
            [nzType]="searchMode === 'database' ? 'primary' : 'default'"
            (click)="switchSearchMode('database')"
          >
            <i nz-icon nzType="database"></i>
            Select from Database
          </button>
        </nz-button-group>
        
        <!-- Demo Data Button -->
        <button 
          nz-button
          nzType="dashed" 
          nzSize="small"
          (click)="insertDemoData()"
          [nzLoading]="isInsertingDemoData"
          style="margin-left: 16px;">
          <i nz-icon nzType="database"></i>
          Insert Demo Data
        </button>
      </div>

      <!-- Manual Search Form -->
      <form 
        *ngIf="searchMode === 'manual'" 
        nz-form 
        [formGroup]="searchForm" 
        (ngSubmit)="performSearch()"
        [@slideInOut]
      >
        
        <!-- Simplified Search Form (Company Name + Country Only) -->
        <div class="search-form">
          <div nz-row [nzGutter]="24">
            <!-- Company Name -->
            <div nz-col [nzSpan]="12">
              <nz-form-item>
                <nz-form-label [nzSpan]="24" nzRequired>
                  <span style="font-size: 16px; font-weight: 600;">Company Name</span>
                </nz-form-label>
                <nz-form-control [nzSpan]="24" nzErrorTip="Company name is required (minimum 2 characters)">
                  <nz-input-group nzSize="large" [nzPrefix]="prefixIconTpl">
                    <input 
                      nz-input 
                      formControlName="companyName" 
                      placeholder="e.g., Rosneft, ABC Corporation, Adoon"
                      style="font-size: 16px;"
                    />
                  </nz-input-group>
                  <ng-template #prefixIconTpl>
                    <i nz-icon nzType="search" style="font-size: 18px; color: #1890ff;"></i>
                  </ng-template>
                </nz-form-control>
              </nz-form-item>
            </div>
            
            <!-- Country -->
            <div nz-col [nzSpan]="8">
              <nz-form-item>
                <nz-form-label [nzSpan]="24">
                  <span style="font-size: 16px; font-weight: 600;">Country (Optional)</span>
                </nz-form-label>
                <nz-form-control [nzSpan]="24">
                  <nz-select 
                    formControlName="country" 
                    nzSize="large"
                    nzShowSearch
                    nzAllowClear
                    nzPlaceHolder="Select country to filter results ({{ countries.length }} countries available)"
                    style="width: 100%;"
                    [nzDropdownStyle]="{ 'max-height': '300px', 'overflow-y': 'auto' }"
                    (nzOpenChange)="onDropdownOpen($event)"
                  >
                    <!-- Clear Option -->
                    <nz-option 
                      nzValue="" 
                      nzLabel="üåç All Countries (No Filter)"
                      nzCustomContent
                    >
                      <span style="color: #999; font-style: italic;">
                        üåç All Countries (No Filter)
                      </span>
                    </nz-option>
                    
                    <!-- Countries Options -->
                    <nz-option 
                      *ngFor="let country of countries; trackBy: trackByCountry" 
                      [nzValue]="country.value" 
                      [nzLabel]="country.label"
                    >
                    </nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            
            <!-- Legal Form -->
            <div nz-col [nzSpan]="4">
              <nz-form-item>
                <nz-form-label [nzSpan]="24">
                  <span style="font-size: 16px; font-weight: 600;">Company Type (Optional)</span>
                </nz-form-label>
                <nz-form-control [nzSpan]="24">
                  <nz-select 
                    formControlName="legalForm" 
                    nzSize="large"
                    nzShowSearch
                    nzAllowClear
                    nzPlaceHolder="Select company type"
                    style="width: 100%;"
                    [nzDropdownStyle]="{ 'max-height': '300px', 'overflow-y': 'auto' }"
                  >
                    <!-- Clear Option -->
                    <nz-option 
                      nzValue="" 
                      nzLabel="üè¢ All Types (No Filter)"
                      nzCustomContent
                    >
                      <span style="color: #999; font-style: italic;">
                        üè¢ All Types (No Filter)
                      </span>
                    </nz-option>
                    
                    <!-- Company Types Options -->
                    <nz-option 
                      *ngFor="let type of companyTypes; trackBy: trackByType" 
                      [nzValue]="type.value" 
                      [nzLabel]="type.label"
                    >
                    </nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
          
          <!-- Data Sources Selection -->
          <div nz-row [nzGutter]="16" style="margin-top: 24px;">
            <div nz-col [nzSpan]="24">
              <div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
                <div style="margin-bottom: 12px;">
                  <span style="font-size: 16px; font-weight: 600; color: #262626;">
                    <i nz-icon nzType="database" style="margin-right: 8px;"></i>
                    Data Sources
                  </span>
                  <span style="margin-left: 8px; font-size: 12px; color: #999;">
                    (Select at least one source to search)
                  </span>
                </div>
                <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                  <label 
                    *ngFor="let source of dataSources" 
                    nz-checkbox 
                    [(ngModel)]="source.checked"
                    [ngModelOptions]="{standalone: true}"
                    style="font-size: 14px;"
                  >
                    {{ source.label }}
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Search Button -->
          <div class="search-actions" style="margin-top: 24px;">
            <button
              nz-button
              nzType="primary"
              nzSize="large"
              type="submit"
              [nzLoading]="isLoading"
              [disabled]="!searchForm.valid"
              style="height: 50px; padding: 0 40px; font-size: 16px;"
            >
              <i nz-icon nzType="search" style="font-size: 20px;"></i>
              <span style="margin-left: 8px;">Search Compliance</span>
            </button>
            <div style="margin-top: 12px; text-align: center; color: #999; font-size: 14px;">
              <i nz-icon nzType="info-circle"></i>
              Search by company name only, or add country to filter results
            </div>
          </div>
        </div>
        
      </form>
    </nz-card>
  </div>
  
  <!-- Database Companies Modal -->
  <nz-modal
    [(nzVisible)]="isDatabaseModalVisible"
    nzTitle="Select Companies from Database"
    [nzWidth]="1000"
    [nzBodyStyle]="{ 'max-height': '70vh', 'overflow-y': 'auto', 'padding': '20px' }"
    [nzFooter]="modalFooter"
    (nzOnCancel)="closeDatabaseModal()"
  >
    <ng-container *nzModalContent>
      <div class="database-modal-content">
        
        <!-- Debug Info -->
        <nz-alert 
          nzType="info" 
          nzShowIcon
          style="margin-bottom: 16px;"
        >
          <span nz-alert-description>
            <strong>üìä Status:</strong> 
            {{ filteredDatabaseCompanies.length }} companies loaded
            <span *ngIf="selectedCount > 0"> | {{ selectedCount }} selected</span>
          </span>
        </nz-alert>
        
        <!-- Search Filter -->
        <div class="database-filters" style="margin-bottom: 16px;">
          <nz-input-group [nzPrefix]="prefixIconSearch" nzSize="large">
            <input 
              nz-input 
              placeholder="Search companies by name, country, or city..." 
              [(ngModel)]="databaseSearchText"
              (ngModelChange)="filterDatabaseCompanies()"
            />
          </nz-input-group>
          <ng-template #prefixIconSearch>
            <i nz-icon nzType="search"></i>
          </ng-template>
        </div>

        <!-- Select All -->
        <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 4px;">
          <label nz-checkbox 
                 [(ngModel)]="isAllSelected"
                 [nzIndeterminate]="isIndeterminate"
                 (ngModelChange)="toggleSelectAll($event)">
            <strong>Select All ({{ selectedCount }}/{{ filteredDatabaseCompanies.length }})</strong>
          </label>
        </div>

        <!-- Loading -->
        <div *ngIf="isLoading" style="text-align: center; padding: 40px;">
          <nz-spin nzSize="large" nzTip="Loading companies..."></nz-spin>
        </div>

        <!-- Companies Grid -->
        <ng-container *ngIf="!isLoading">
          
          <!-- Empty State -->
          <nz-empty 
            *ngIf="filteredDatabaseCompanies.length === 0"
            nzNotFoundContent="No companies found"
          >
            <button nz-button nzType="primary" (click)="loadDatabaseCompanies()">
              <i nz-icon nzType="reload"></i>
              Reload Companies
            </button>
          </nz-empty>

          <!-- Companies List -->
          <div *ngIf="filteredDatabaseCompanies.length > 0" style="display: grid; gap: 12px;">
            
            <nz-card 
              *ngFor="let company of filteredDatabaseCompanies; trackBy: trackByCompany" 
              [nzBodyStyle]="{ padding: '16px' }"
              style="cursor: pointer; transition: all 0.3s;"
              [style.border-color]="company.selected ? '#1890ff' : '#d9d9d9'"
              [style.background-color]="company.selected ? '#e6f7ff' : '#fff'"
              [style.box-shadow]="company.selected ? '0 2px 8px rgba(24, 144, 255, 0.3)' : 'none'"
              (click)="toggleCompanySelection(company)"
            >
              <!-- Company Header -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #262626;">
                  {{ company.companyName }}
                </h3>
                
                <!-- Checkbox - FIXED BINDING -->
                <label 
                  nz-checkbox
                  [ngModel]="company.selected"
                  (ngModelChange)="onCheckboxChange(company, $event, $event)"
                  [ngModelOptions]="{standalone: true}"
                  (click)="$event.stopPropagation()"
                  style="margin: 0;"
                ></label>
              </div>
              
              <!-- Company Details -->
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 14px; color: #595959;">
                <div>
                  <strong style="color: #262626;">Country:</strong> 
                  {{ company.country || '-' }}
                </div>
                <div>
                  <strong style="color: #262626;">Type:</strong> 
                  {{ company.companyType || '-' }}
                </div>
                <div>
                  <strong style="color: #262626;">City:</strong> 
                  {{ company.city || '-' }}
                </div>
                <div>
                  <strong style="color: #262626;">Source:</strong> 
                  <nz-tag [nzColor]="company.source === 'compliance_task' ? 'orange' : 'green'">
                    {{ company.source === 'compliance_task' ? 'Task' : 'Record' }}
                  </nz-tag>
                </div>
              </div>
            </nz-card>
            
          </div>
        </ng-container>
        
      </div>
    </ng-container>
    
    <!-- Modal Footer -->
    <ng-template #modalFooter>
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div>
          <strong style="color: #1890ff; font-size: 16px;">{{ selectedCount }}</strong> 
          <span style="color: #595959;">companies selected</span>
        </div>
        <div>
          <button 
            nz-button 
            nzType="default" 
            (click)="closeDatabaseModal()"
            style="margin-right: 8px;"
          >
            <i nz-icon nzType="close"></i>
            Cancel
          </button>
          <button 
            nz-button 
            nzType="primary"
            [nzLoading]="isLoading"
            [disabled]="selectedCount === 0"
            (click)="bulkCheckSelectedCompanies()"
          >
            <i nz-icon nzType="security-scan"></i>
            Check Selected ({{ selectedCount }})
          </button>
        </div>
      </div>
    </ng-template>
  </nz-modal>
  
  <!-- Results Section -->
  <div class="results-section" *ngIf="searchPerformed || isLoading">
    <nz-tabset [(nzSelectedIndex)]="selectedTabIndex" [nzAnimated]="false">

      <!-- Search Results Tab -->
      <nz-tab nzTitle="Search Results" [nzDisabled]="isLoading">
        <div class="tab-content" style="min-height: 400px; padding: 20px;">

          <!-- Loading State -->
          <div *ngIf="isLoading" class="loading-container">
            <nz-spin nzSize="large">
              <div class="loading-content">
                <i nz-icon nzType="loading" nzTheme="outline"></i>
                <p>Searching compliance databases...</p>
                <p class="loading-subtitle">Checking OpenSanctions, OFAC, EU/UK sanctions</p>
              </div>
            </nz-spin>
          </div>
          
          <!-- Results Display -->
          <ng-container *ngIf="!isLoading && searchResults && searchResults.length > 0">
            <div class="results-container">
              <div *ngFor="let result of searchResults; let i = index; trackBy: trackByResult" class="result-card">
                <nz-card class="result-card-content">
                  <h2 style="margin: 0 0 16px 0; color: #1890ff; font-size: 20px; font-weight: 600;">{{ result.companyName }}</h2>
                
                <!-- Risk Assessment Header -->
                <div class="risk-header" style="margin-top: 16px;">
                  <div class="risk-indicator">
                    <nz-tag [nzColor]="getRiskLevelColor(result.overallRiskLevel)">
                      {{ result.overallRiskLevel }} Risk
                    </nz-tag>
                    <span class="confidence-score">
                      Confidence: 
                      <nz-tag [nzColor]="getConfidenceColor(result.matchConfidence)">
                        {{ formatConfidence(result.matchConfidence) }}
                      </nz-tag>
                    </span>
                  </div>
                  <div class="search-info">
                    <small>Searched: {{ result.searchTimestamp | date:'medium' }}</small>
                  </div>
                </div>
                
                <!-- Sanctions List -->
                <div class="sanctions-section" *ngIf="result.sanctions && result.sanctions.length > 0" style="margin-top: 20px;">
                  <h4>Sanctions Found: ({{ result.sanctions.length }})</h4>
                  <nz-table 
                    #expandTable
                    [nzData]="result.sanctions" 
                    [nzSize]="'small'" 
                    nzBordered 
                    [nzShowPagination]="false" 
                    [nzScroll]="{ x: '1400px' }"
                  >
                    <thead>
                      <tr>
                        <th nzWidth="60px">Details</th>
                        <th nzWidth="180px">Name</th>
                        <th nzWidth="120px">Entity Type</th>
                        <th nzWidth="150px">Company Type</th>
                        <th nzWidth="130px">Country</th>
                        <th nzWidth="120px">Source</th>
                        <th nzWidth="250px">Reason</th>
                        <th nzWidth="200px">Penalty/Sanction</th>
                        <th nzWidth="120px">Date</th>
                        <th nzWidth="100px">Risk Level</th>
                        <th nzWidth="120px">Confidence</th>
                        <th nzWidth="100px">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let sanction of result.sanctions; let i = index">
                        <!-- View Details Button -->
                        <td style="text-align: center;">
                          <button 
                            nz-button 
                            nzType="link" 
                            nzSize="small"
                            (click)="viewSanctionDetails(sanction)"
                            nz-tooltip 
                            nzTooltipTitle="View all details"
                          >
                            <i nz-icon nzType="eye" style="font-size: 16px; color: #1890ff;"></i>
                          </button>
                        </td>
                        
                        <!-- Name -->
                        <td>
                          <strong style="color: #1890ff;">{{ sanction.name }}</strong>
                          
                          <!-- Match Explanation (Technical) -->
                          <div *ngIf="sanction.matchExplanation" style="margin-top: 8px; padding: 6px 8px; background: #f6ffed; border-left: 3px solid #52c41a; border-radius: 4px;">
                            <div style="display: flex; align-items: flex-start; gap: 6px;">
                              <i nz-icon nzType="search" style="color: #52c41a; font-size: 12px; margin-top: 2px;"></i>
                              <div style="font-size: 11px; color: #595959; line-height: 1.5; font-family: monospace;">
                                {{ sanction.matchExplanation }}
                              </div>
                            </div>
                          </div>
                        </td>
                        
                        <!-- Entity Type (Person/Company/Vessel) -->
                        <td>
                          <nz-tag [nzColor]="getTypeColor(sanction.type)">
                            {{ sanction.type }}
                          </nz-tag>
                        </td>
                        
                        <!-- Company Type (Mapped Legal Form) -->
                        <td>
                          <div *ngIf="sanction.legalForm; else noCompanyType">
                            <nz-tag nzColor="green">
                              {{ getMappedCompanyType(sanction.legalForm) }}
                            </nz-tag>
                            <div style="font-size: 10px; color: #999; margin-top: 4px;">
                              {{ sanction.legalForm }}
                            </div>
                          </div>
                          <ng-template #noCompanyType>
                            <span style="color: #999;">N/A</span>
                          </ng-template>
                        </td>
                        
                        <!-- Country -->
                        <td>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">{{ getCountryFlag(sanction.country) }}</span>
                            <div>
                              <strong style="color: #1890ff;">{{ sanction.country }}</strong>
                              <div *ngIf="sanction.countryCode" style="font-size: 11px; color: #999;">
                                {{ sanction.countryCode }}
                              </div>
                            </div>
                          </div>
                        </td>
                        <td>
                          <nz-tag [nzColor]="getSourceColor(sanction.source)">
                            {{ sanction.source }}
                          </nz-tag>
                        </td>
                        <td>
                          <div style="max-width: 250px; word-wrap: break-word; white-space: normal;">
                            {{ sanction.reason || 'Not specified' }}
                          </div>
                        </td>
                        <td>
                          <div style="max-width: 200px; word-wrap: break-word; white-space: normal;">
                            {{ sanction.penalty || sanction.sanctionType || 'Asset freeze, Travel ban' }}
                          </div>
                        </td>
                        <td>
                          <div style="font-size: 12px;">
                            <ng-container *ngIf="sanction.date || sanction.sanctionDate; else noDate">
                              {{ (sanction.date || sanction.sanctionDate) | date:'mediumDate' }}
                            </ng-container>
                            <ng-template #noDate>
                              <span style="color: #999;">N/A</span>
                            </ng-template>
                          </div>
                        </td>
                        <td>
                          <nz-tag [nzColor]="getRiskLevelColor(sanction.riskLevel)">
                            {{ sanction.riskLevel || 'Unknown' }}
                          </nz-tag>
                        </td>
                        <td>
                          <nz-progress 
                            [nzPercent]="sanction.confidence" 
                            [nzStrokeColor]="getConfidenceColor(sanction.confidence)"
                            [nzSize]="'small'"
                          ></nz-progress>
                        </td>
                        <td>
                          <button 
                            nz-button 
                            nzType="link" 
                            nzSize="small"
                            (click)="viewSanctionDetails(sanction)"
                            style="padding: 0; color: #1890ff;"
                          >
                            <span nz-icon nzType="eye" nzTheme="outline"></span> View Details
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </nz-table>
                </div>
                
                <!-- No Sanctions Found -->
                <div class="no-sanctions" *ngIf="!result.sanctions || result.sanctions.length === 0" style="margin-top: 20px;">
                  <nz-empty nzNotFoundContent="No sanctions found for this company">
                    <button nz-button nzType="primary" (click)="clearSearch()">Search Again</button>
                  </nz-empty>
                </div>
                
                <!-- Sources -->
                <div class="sources-section" *ngIf="result.sources && result.sources.length > 0" style="margin-top: 20px;">
                  <h4>Data Sources: ({{ result.sources.length }})</h4>
                  <nz-tag *ngFor="let source of result.sources" nzColor="blue">{{ source }}</nz-tag>
                </div>
                
              </nz-card>
            </div>
          </div>
          </ng-container>
          
          <!-- No Results -->
          <div *ngIf="!isLoading && (!searchResults || searchResults.length === 0)" class="no-results">
            <nz-empty nzNotFoundContent="No compliance data found">
              <button nz-button nzType="primary" (click)="clearSearch()">Try Different Search</button>
            </nz-empty>
          </div>
          
        </div>
      </nz-tab>
      
      <!-- Database Companies Tab -->
      <nz-tab nzTitle="Database Companies" [nzDisabled]="isLoading">
        <div class="tab-content" style="padding: 20px;">
          
          <!-- Bulk Actions -->
          <div class="bulk-actions" *ngIf="filteredDatabaseCompanies.length > 0">
            <nz-card>
              <div class="bulk-header">
                <div class="selection-info">
                  <nz-checkbox 
                    [(ngModel)]="isAllSelected" 
                    (ngModelChange)="toggleSelectAll($event)"
                    [ngModelOptions]="{standalone: true}"
                  >
                    Select All ({{ selectedCount }}/{{ filteredDatabaseCompanies.length }})
                  </nz-checkbox>
                </div>
                
                <div class="bulk-buttons">
                  <button 
                    nz-button 
                    nzType="primary" 
                    [nzLoading]="isLoading"
                    [disabled]="selectedCount === 0"
                    (click)="performBulkCheck()"
                  >
                    <i nz-icon nzType="security-scan"></i>
                    Check Selected ({{ selectedCount }})
                  </button>
                </div>
              </div>
            </nz-card>
          </div>
          
          <!-- Companies Table -->
          <div class="companies-table">
            <nz-table [nzData]="filteredDatabaseCompanies" [nzSize]="'small'" nzBordered>
              <thead>
                <tr>
                  <th nzWidth="50px">
                    <nz-checkbox 
                      [(ngModel)]="isAllSelected" 
                      (ngModelChange)="toggleSelectAll($event)"
                      [ngModelOptions]="{standalone: true}"
                    ></nz-checkbox>
                  </th>
                  <th>Company Name</th>
                  <th>Country</th>
                  <th>Type</th>
                  <th>City</th>
                  <th>Street</th>
                  <th>Building</th>
                  <th>Source</th>
                  <th>Status</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let company of filteredDatabaseCompanies">
                  <td>
                    <nz-checkbox 
                      [(ngModel)]="company.selected"
                      [ngModelOptions]="{standalone: true}"
                    ></nz-checkbox>
                  </td>
                  <td>{{ company.companyName }}</td>
                  <td>{{ company.country || '-' }}</td>
                  <td>{{ company.companyType || '-' }}</td>
                  <td>{{ company.city || '-' }}</td>
                  <td>{{ company.street || '-' }}</td>
                  <td>{{ company.buildingNumber || '-' }}</td>
                  <td>
                    <nz-tag [nzColor]="company.source === 'compliance_task' ? 'orange' : 'green'">
                      {{ company.source === 'compliance_task' ? 'Compliance Task' : 'Golden Record' }}
                    </nz-tag>
                  </td>
                  <td>{{ company.status || '-' }}</td>
                  <td>{{ company.lastUpdated | date:'short' }}</td>
                  <td>
                    <nz-button-group nzSize="small">
                      <button 
                        nz-button 
                        nzType="primary" 
                        nzSize="small" 
                        (click)="searchSpecificCompany(company)"
                        nzTooltipTitle="Search this company"
                      >
                        <i nz-icon nzType="search"></i>
                      </button>
                    </nz-button-group>
                  </td>
                </tr>
              </tbody>
            </nz-table>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="filteredDatabaseCompanies.length === 0" class="no-companies">
            <nz-empty nzNotFoundContent="No companies found in database">
              <button nz-button nzType="primary" (click)="loadDatabaseCompanies()">Refresh</button>
            </nz-empty>
          </div>
          
        </div>
      </nz-tab>
      
    </nz-tabset>
  </div>
  
  <!-- Sanction Details Modal -->
  <nz-modal
    [(nzVisible)]="isDetailsModalVisible"
    nzTitle="Complete Sanction Details"
    [nzFooter]="null"
    nzWidth="900px"
    (nzOnCancel)="closeDetailsModal()"
  >
    <ng-container *nzModalContent>
      <div *ngIf="selectedSanction" style="max-height: 70vh; overflow-y: auto;">
        
        <!-- Basic Information -->
        <nz-card nzTitle="Basic Information" [nzSize]="'small'" style="margin-bottom: 16px;">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div>
              <strong>Name:</strong> {{ selectedSanction.name }}
            </div>
            <div>
              <strong>Type:</strong> {{ selectedSanction.type || 'Company' }}
            </div>
            <div>
              <strong>Country:</strong> 
              {{ getCountryFlag(selectedSanction.country) }} {{ selectedSanction.country }}
            </div>
            <div>
              <strong>City:</strong> {{ selectedSanction.city || 'N/A' }}
            </div>
            <div>
              <strong>Sector:</strong> {{ selectedSanction.sector || 'N/A' }}
            </div>
            <div>
              <strong>Risk Level:</strong>
              <nz-tag [nzColor]="getRiskLevelColor(selectedSanction.riskLevel)">
                {{ selectedSanction.riskLevel || 'Unknown' }}
              </nz-tag>
            </div>
            <div>
              <strong>Source:</strong> 
              <nz-tag [nzColor]="'red'">
                {{ selectedSanction.sourceList || 'Local Database' }}
              </nz-tag>
            </div>
            <div *ngIf="selectedSanction.confidence">
              <strong>Match Confidence:</strong>
              <nz-tag [nzColor]="getConfidenceColor(selectedSanction.confidence)">
                {{ selectedSanction.confidence }}%
              </nz-tag>
            </div>
          </div>
        </nz-card>

        <!-- Address Information -->
        <nz-card *ngIf="selectedSanction.address" nzTitle="Address Information" [nzSize]="'small'" style="margin-bottom: 16px;">
          <div style="padding: 12px; background: #f5f5f5; border-radius: 6px;">
            <strong>Full Address:</strong>
            <div style="margin-top: 8px; color: #262626;">
              {{ selectedSanction.address }}
            </div>
          </div>
        </nz-card>

        <!-- Sanctions Information -->
        <nz-card nzTitle="üö´ Sanctions Information" [nzSize]="'small'" style="margin-bottom: 16px; background: linear-gradient(135deg, #fff1f0 0%, #ffccc7 100%); border: 2px solid #ff4d4f;">
          <div style="display: grid; gap: 16px;">
            
            <!-- Entry Information -->
            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #ffa39e;">
              <h4 style="margin: 0 0 12px 0; color: #cf1322; font-size: 14px; font-weight: 600;">
                üìã Sanctions Details
              </h4>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <div>
                  <strong style="color: #595959;">üìÖ Sanction Start Date:</strong>
                  <div style="margin-top: 4px; color: #262626; font-weight: 500;">
                    {{ selectedSanction.sanctionStartDate || 'N/A' }}
                  </div>
                </div>
                <div>
                  <strong style="color: #595959;">üìã Sanction Program:</strong>
                  <div style="margin-top: 4px; color: #262626;">
                    <nz-tag nzColor="red" style="font-size: 12px;">
                      {{ selectedSanction.sanctionProgram || 'N/A' }}
                    </nz-tag>
                  </div>
                </div>
                <div style="grid-column: 1 / -1;">
                  <strong style="color: #595959;">‚öñÔ∏è Sanction Reason:</strong>
                  <div style="margin-top: 4px; padding: 8px; background: #fff2e8; border-radius: 4px; color: #262626; font-weight: 500;">
                    {{ selectedSanction.sanctionReason || 'N/A' }}
                  </div>
                </div>
                <div>
                  <strong style="color: #595959;">üè≠ Main Activity:</strong>
                  <div style="margin-top: 4px; color: #262626;">
                    {{ selectedSanction.mainActivity || 'N/A' }}
                  </div>
                </div>
                <div>
                  <strong style="color: #595959;">üìä Dataset Version:</strong>
                  <div style="margin-top: 4px; color: #262626; font-size: 12px;">
                    {{ selectedSanction.datasetVersion || 'N/A' }}
                  </div>
                </div>
                <div>
                  <strong style="color: #595959;">‚úÖ Last Verified:</strong>
                  <div style="margin-top: 4px; color: #262626; font-size: 12px;">
                    {{ selectedSanction.lastVerified || 'N/A' }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Source Information -->
            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #ffa39e;">
              <h4 style="margin: 0 0 12px 0; color: #cf1322; font-size: 14px; font-weight: 600;">
                üîó Source Information
              </h4>
              <div style="display: grid; gap: 12px;">
                <div>
                  <strong style="color: #595959;">üìã Source List:</strong>
                  <div style="margin-top: 4px;">
                    <nz-tag nzColor="red" style="font-size: 12px;">
                      {{ selectedSanction.sourceList || 'Local Database' }}
                    </nz-tag>
                  </div>
                </div>
                <div *ngIf="selectedSanction.sourceUrl">
                  <strong style="color: #595959;">üîó Open Sanctions Link:</strong>
                  <div style="margin-top: 4px;">
                    <a [href]="selectedSanction.sourceUrl" target="_blank" style="color: #1890ff; text-decoration: none; font-size: 12px;">
                      {{ selectedSanction.sourceUrl }}
                    </a>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </nz-card>


        <!-- OpenAI Analysis Story -->
        <nz-card *ngIf="selectedSanction.matchReason || selectedSanction.analysis" [nzSize]="'small'" style="margin-bottom: 16px; background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border: 2px solid #1890ff;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <i nz-icon nzType="robot" nzTheme="outline" style="font-size: 24px; color: #1890ff; margin-top: 4px;"></i>
            <div style="flex: 1;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="margin: 0; color: #096dd9; font-size: 16px; font-weight: 600;">
                  ü§ñ AI Analysis Story
                </h4>
                <button 
                  nz-button 
                  nzType="primary" 
                  nzSize="small"
                  style="background: #1890ff; border-color: #1890ff; font-size: 12px; height: 28px;"
                  (click)="translateAnalysis()"
                  [nzLoading]="isTranslating"
                  nz-tooltip 
                  nzTooltipTitle="Translate to Arabic">
                  <i nz-icon nzType="translation"></i> Translate
                </button>
              </div>
              
              <!-- English Analysis -->
              <div *ngIf="!showArabicTranslation">
                <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #91d5ff; margin-bottom: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i nz-icon nzType="global" style="color: #1890ff;"></i>
                    <strong style="color: #096dd9; font-size: 13px;">English Analysis:</strong>
                  </div>
                  <p style="margin: 0; color: #262626; line-height: 1.6; font-size: 14px; text-align: justify;">
                    {{ selectedSanction.matchReason || selectedSanction.analysis || 'AI analysis not available' }}
                  </p>
                </div>
              </div>
              
              <!-- Arabic Translation -->
              <div *ngIf="showArabicTranslation">
                <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #91d5ff;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i nz-icon nzType="global" style="color: #fa8c16;"></i>
                    <strong style="color: #fa8c16; font-size: 13px;">ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©:</strong>
                  </div>
                  <p style="margin: 0; color: #262626; line-height: 1.8; font-size: 14px; text-align: justify;" dir="rtl">
                    {{ arabicTranslation || 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©...' }}
                  </p>
                </div>
              </div>
              
              <!-- Confidence & Match Quality -->
              <div style="display: flex; gap: 16px; margin-top: 12px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                    <i nz-icon nzType="thunderbolt" style="color: #52c41a; font-size: 14px;"></i>
                    <span style="font-size: 12px; color: #595959; font-weight: 500;">Match Confidence:</span>
                  </div>
                  <nz-progress 
                    [nzPercent]="selectedSanction.confidence || 0" 
                    [nzStrokeColor]="getConfidenceColor(selectedSanction.confidence || 0)"
                    [nzSize]="'small'"
                    [nzFormat]="formatProgress"
                  ></nz-progress>
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                    <i nz-icon nzType="safety-certificate" style="color: #fa8c16; font-size: 14px;"></i>
                    <span style="font-size: 12px; color: #595959; font-weight: 500;">Match Quality:</span>
                  </div>
                  <div style="display: flex; gap: 4px;">
                    <nz-tag [nzColor]="getMatchQualityColor(selectedSanction.confidence || 0)" style="margin: 0;">
                      {{ getMatchQualityText(selectedSanction.confidence || 0) }}
                    </nz-tag>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </nz-card>




      </div>
    </ng-container>
  </nz-modal>
  
</div>

<!-- Compliance Chat Widget (New Modal-Based Interface) -->
<app-compliance-chat-widget 
  (viewDetailsRequested)="viewSanctionDetails($event)">
</app-compliance-chat-widget>

<h3 class="welcomeMessage">
  {{ "WelcomeBack" | translate }}, {{ currentUser?.fullName || ("Essam" | translate) }}!
  <img src="assets/img/waving.svg" alt="Welcome Icon" class="welcomeIcon" />
</h3>
<p class="subMessage">{{ "HereIsYourTasksForToday" | translate }}</p>

<div class="titleActionHolder">
  <h1 class="pageTitle">{{ "MyTaskList" | translate }}</h1>

  <div class="actionHolderTitle">
    <div class="seachInputHolder">
      <img src="./assets/img/search.svg" alt="" />
      <input
        type="text"
        [placeholder]="'Search by name, tax, email...' | translate"
        [ngModel]="search"
        (ngModelChange)="onSearchChange($event)"
      />
    </div>
    <select 
      [(ngModel)]="filterByStatus" 
      (change)="onFilterChange($event)"
      class="filter-select">
      <option value="">{{ 'All Status' | translate }}</option>
      <option *ngFor="let status of uniqueStatuses" [value]="status.value">{{ status.label }}</option>
    </select>
    <button (click)="clearFilters()" class="btn btn-primary">{{ 'Clear Filters' | translate }}</button>
  </div>
</div>


<nz-table #tbl [nzPageSize]="7" [nzData]="rows" [nzLoading]="loading" class="smart-table">
  <thead>
    <tr>
      <th class="company-name-header">{{ "Company Name" | translate }}</th>
      <th class="origin-header">{{ "Origin" | translate }}</th>
      <th class="company-type-header">{{ "Company Type" | translate }}</th>
      <th class="issue-header">{{ "Issue Description" | translate }}</th>
      <th class="action-header">{{ "Action" | translate }}</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngIf="!loading && rows?.length === 0">
      <td [attr.colspan]="5">
        <nz-empty [nzNotFoundContent]="'No tasks to fix' | translate"></nz-empty>
      </td>
    </tr>

    <tr *ngFor="let row of tbl.data" class="table-row">
      <td class="company-name-cell">
        <div class="company-info">
          <div class="company-name">
            <strong>{{ row.name || row.firstName || 'غير محدد' }}</strong>
            <small *ngIf="row.firstNameAr" class="company-name-ar">{{ row.firstNameAr }}</small>
          </div>
          <div class="company-details">
            <span class="request-id">#{{ row.requestId || row.id }}</span>
            <span *ngIf="row.tax" class="tax-number">
              <i nz-icon nzType="number"></i>
              Tax: {{ row.tax }}
            </span>
          </div>
        </div>
      </td>

      <td class="origin-cell">
        <div class="origin-info">
          <nz-tag [nzColor]="getOriginColor(row)" class="origin-tag">
            {{ getOriginBadge(row) }}
          </nz-tag>
          <small class="origin-detail">
            {{ getRecordOrigin(row) }}
          </small>
        </div>
      </td>

      <td class="company-type-cell">
        <span class="company-type">{{ getCustomerTypeLabel(row.CustomerType || '') }}</span>
      </td>

      <td class="issue-cell">
        <div class="issue-info">
          <div class="issue-main">
            <span *ngIf="row.rejectReason || row.IssueDescription; else noIssue" class="issue-description">
              {{ row.rejectReason || row.IssueDescription }}
            </span>
            <ng-template #noIssue>
              <span *ngIf="row.status === 'Quarantine'" class="quarantine-issue">
                Missing required data
              </span>
              <span *ngIf="row.status !== 'Quarantine'" class="no-issue">—</span>
            </ng-template>
          </div>
          <div class="issue-details">
            <small *ngIf="row.requestType === 'duplicate' && row.status === 'Rejected'" class="warning-text">
              <i nz-icon nzType="warning"></i>
              Master record rejected by reviewer
            </small>
            <small *ngIf="row.originalRequestType === 'quarantine' && row.status === 'Rejected'" class="warning-text orange">
              <i nz-icon nzType="warning"></i>
              Originally from quarantine
            </small>
            <small *ngIf="row.linkedRecords > 0" class="linked-records">
              <i nz-icon nzType="link"></i>
              {{ row.linkedRecords }} linked records
            </small>
          </div>
        </div>
      </td>

      <td class="action-cell">
        <button 
          nz-button 
          nzType="primary"
          class="action-button"
          [nzDanger]="row.requestType === 'duplicate' && row.status === 'Rejected'"
          [nzGhost]="(row.requestType !== 'duplicate' || row.status !== 'Rejected') && row.status !== 'Quarantine'"
          [style.background-color]="row.status === 'Quarantine' ? '#ff7a45' : ''"
          [style.border-color]="row.status === 'Quarantine' ? '#ff7a45' : ''"
          [style.color]="row.status === 'Quarantine' ? 'white' : ''"
          (click)="handleRecordAction(row)">
          <i nz-icon [nzType]="getActionIcon(row)"></i>
          {{ getActionLabel(row) }}
        </button>
      </td>
    </tr>
  </tbody>
</nz-table>
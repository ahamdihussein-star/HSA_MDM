<h3 class="welcomeMessage">
  {{ "WelcomeBack" | translate }}, {{ "Essam" | translate }}!
  <img src="assets/img/waving.svg" alt="Welcome Icon" class="welcomeIcon" />
</h3>
<p class="subMessage">{{ "HereIsYourTasksForToday" | translate }}</p>

<div class="titleActionHolder">
  <h1 class="pageTitle">{{ "MyTaskList" | translate }}</h1>

  <div class="actionHolderTitle">
    <div class="seachInputHolder">
      <img src="./assets/img/search.svg" alt="" />
      <input
        type="text"
        [placeholder]="'Search by name, tax, email...' | translate"
        [ngModel]="search"
        (ngModelChange)="onSearchChange($event)"
      />
    </div>
    <select 
      [(ngModel)]="filterByStatus" 
      (change)="onFilterChange($event)"
      class="filter-select">
      <option value="">{{ 'All Status' | translate }}</option>
      <option *ngFor="let status of uniqueStatuses" [value]="status.value">{{ status.label }}</option>
    </select>
    <button (click)="clearFilters()" class="btn btn-primary">{{ 'Clear Filters' | translate }}</button>
  </div>
</div>


<nz-table #tbl [nzPageSize]="7" [nzData]="rows" [nzScroll]="{ x: '1400px' }" [nzLoading]="loading">
  <thead>
    <tr>
      <th style="min-width:240px">{{ "Company Name" | translate }}</th>
      <th style="min-width:120px">{{ "Origin" | translate }}</th>
      <th style="min-width:160px">{{ "Company Type" | translate }}</th>
      <th style="min-width:240px">{{ "Issue Description" | translate }}</th>
      <th style="min-width:220px" class="text-right">{{ "Action" | translate }}</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngIf="!loading && rows?.length === 0">
      <td [attr.colspan]="5">
        <nz-empty [nzNotFoundContent]="'No tasks to fix' | translate"></nz-empty>
      </td>
    </tr>

    <tr *ngFor="let row of tbl.data">
      <td>
        <div style="display:flex; flex-direction:column;">
          <strong>{{ row.name || row.firstName || 'غير محدد' }}</strong>
          <small *ngIf="row.firstNameAr" style="opacity:.7">{{ row.firstNameAr }}</small>
          <small style="opacity:.7">#{{ row.requestId || row.id }}</small>
          <small *ngIf="row.tax" style="opacity:.7">
            <i nz-icon nzType="number" nzTheme="outline" style="margin-right:2px"></i>
            Tax: {{ row.tax }}
          </small>
        </div>
      </td>

      <td>
        <div style="display:flex; flex-direction:column; gap:4px;">
          <nz-tag [nzColor]="getOriginColor(row)">
            {{ getOriginBadge(row) }}
          </nz-tag>
          <small style="opacity:.7; font-size:11px">
            {{ getRecordOrigin(row) }}
          </small>
        </div>
      </td>

      <td>{{ getCustomerTypeLabel(row.CustomerType || '') }}</td>

      <td>
        <div style="display:flex; flex-direction:column;">
          <span *ngIf="row.rejectReason || row.IssueDescription; else noIssue">
            {{ row.rejectReason || row.IssueDescription }}
          </span>
          <ng-template #noIssue>
            <span *ngIf="row.status === 'Quarantine'">
              Missing required data
            </span>
            <span *ngIf="row.status !== 'Quarantine'">—</span>
          </ng-template>
          <small *ngIf="row.requestType === 'duplicate' && row.status === 'Rejected'" 
                 style="color:#ef4444; margin-top:4px; font-weight:500">
            <i nz-icon nzType="warning" style="margin-right:4px"></i>
            Master record rejected by reviewer
          </small>
          <small *ngIf="row.originalRequestType === 'quarantine' && row.status === 'Rejected'" 
                 style="color:#ff7a45; margin-top:4px; font-weight:500">
            <i nz-icon nzType="warning" style="margin-right:4px"></i>
            Originally from quarantine
          </small>
          <small *ngIf="row.linkedRecords > 0" 
                 style="opacity:.7; margin-top:4px">
            <i nz-icon nzType="link" style="margin-right:4px"></i>
            {{ row.linkedRecords }} linked records
          </small>
        </div>
      </td>

      <td class="text-right">
        <button 
          nz-button 
          nzType="primary"
          [nzDanger]="row.requestType === 'duplicate' && row.status === 'Rejected'"
          [nzGhost]="(row.requestType !== 'duplicate' || row.status !== 'Rejected') && row.status !== 'Quarantine'"
          [style.background-color]="row.status === 'Quarantine' ? '#ff7a45' : ''"
          [style.border-color]="row.status === 'Quarantine' ? '#ff7a45' : ''"
          [style.color]="row.status === 'Quarantine' ? 'white' : ''"
          (click)="handleRecordAction(row)">
          <i nz-icon [nzType]="getActionIcon(row)" style="margin-right:4px"></i>
          {{ getActionLabel(row) }}
        </button>
      </td>
    </tr>
  </tbody>
</nz-table>
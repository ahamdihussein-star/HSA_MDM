<div class="user-management-container">
  <div class="page-header">
    <h1>{{ "User Management" | translate }}</h1>
    <button nz-button nzType="primary" (click)="openAddModal()">
      <i nz-icon nzType="plus-circle"></i>
      {{ "Add New User" | translate }}
    </button>
  </div>

  <div class="users-table-container">
    <nz-table 
      [nzData]="users" 
      [nzLoading]="loading"
      [nzPageSize]="10"
      [nzShowPagination]="true"
      class="smart-table">
      
      <thead>
        <tr>
          <th class="username-header">{{ "Username" | translate }}</th>
          <th class="fullname-header">{{ "Full Name" | translate }}</th>
          <th class="email-header">{{ "Email" | translate }}</th>
          <th class="role-header">{{ "Role" | translate }}</th>
          <th class="status-header">{{ "Status" | translate }}</th>
          <th class="created-header">{{ "Created" | translate }}</th>
          <th class="actions-header">{{ "Actions" | translate }}</th>
        </tr>
      </thead>
      
      <tbody>
        <tr *ngFor="let user of users" class="user-row">
          <td class="username-cell">
            <div class="user-info">
              <div class="username">{{ user.username }}</div>
            </div>
          </td>
          
          <td class="fullname-cell">
            <div class="user-details">
              <div class="fullname">{{ user.fullName || 'N/A' }}</div>
            </div>
          </td>
          
          <td class="email-cell">
            <div class="email-info">
              <div class="email">{{ user.email || 'N/A' }}</div>
            </div>
          </td>
          
          <td class="role-cell">
            <div class="role-info">
              <nz-tag [nzColor]="getRoleColor(user.role)">
                {{ getRoleLabel(user.role) }}
              </nz-tag>
            </div>
          </td>
          
          <td class="status-cell">
            <div class="status-info">
              <nz-tag [nzColor]="user.isActive ? 'green' : 'red'">
                {{ user.isActive ? 'Active' : 'Inactive' }}
              </nz-tag>
            </div>
          </td>
          
          <td class="created-cell">
            <div class="date-info">
              <div class="created-date">{{ user.createdAt | date:'short' }}</div>
            </div>
          </td>
          
          <td class="actions-cell">
            <button nz-button nzSize="small" nz-dropdown [nzDropdownMenu]="menu" nzTrigger="click">
              {{ 'Actions' | translate }}
              <i nz-icon nzType="down"></i>
            </button>
            <nz-dropdown-menu #menu="nzDropdownMenu">
              <ul nz-menu>
                <li nz-menu-item (click)="openEditModal(user)">
                  <i nz-icon nzType="edit"></i>
                  {{ 'Edit' | translate }}
                </li>
                <li nz-menu-item (click)="toggleUserStatus(user)">
                  <i nz-icon [nzType]="user.isActive ? 'stop' : 'play-circle'"></i>
                  {{ user.isActive ? 'Deactivate' : 'Activate' }}
                </li>
                <li nz-menu-item (click)="deleteUser(user)">
                  <i nz-icon nzType="delete"></i>
                  {{ 'Delete' | translate }}
                </li>
              </ul>
            </nz-dropdown-menu>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </div>

  <!-- User Modal -->
  <nz-modal
    [(nzVisible)]="isModalVisible"
    [nzTitle]="isEditMode ? 'Edit User' : 'Add New User'"
    [nzWidth]="720"
    [nzMaskClosable]="false"
    [nzKeyboard]="true"
    [nzBodyStyle]="{ 'max-height': '70vh', 'overflow': 'auto' }"
    (nzOnCancel)="isModalVisible = false"
    [nzFooter]="modalFooter">
    
    <ng-container *nzModalContent>
    <div class="user-form">
      <div class="form-row">
        <div class="form-group">
          <label>{{ "Username" | translate }} *</label>
          <input 
            nz-input 
            name="username"
            [ngModelOptions]="{standalone: true}"
            [(ngModel)]="userForm.username"
            [disabled]="isEditMode"
            placeholder="Enter username">
        </div>
        
        <div class="form-group">
          <label>{{ "Password" | translate }} {{ isEditMode ? '(Leave blank to keep current)' : '*' }}</label>
          <input 
            nz-input 
            type="password"
            name="password"
            [ngModelOptions]="{standalone: true}"
            [(ngModel)]="userForm.password"
            placeholder="Enter password">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>{{ "Full Name" | translate }} *</label>
          <input 
            nz-input 
            name="fullName"
            [ngModelOptions]="{standalone: true}"
            [(ngModel)]="userForm.fullName"
            placeholder="Enter full name">
        </div>
        
        <div class="form-group">
          <label>{{ "Email" | translate }} *</label>
          <input 
            nz-input 
            type="email"
            name="email"
            [ngModelOptions]="{standalone: true}"
            [(ngModel)]="userForm.email"
            placeholder="Enter email address">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>{{ "Role" | translate }} *</label>
          <nz-select 
            name="role"
            [ngModelOptions]="{standalone: true}"
            [(ngModel)]="userForm.role" 
            nzPlaceHolder="Select role"
            style="width: 100%">
            <nz-option 
              *ngFor="let role of roleOptions" 
              [nzValue]="role.value" 
              [nzLabel]="role.label">
            </nz-option>
          </nz-select>
        </div>
        
        <div class="form-group">
          <label>{{ 'Profile Photo' | translate }}</label>
          <div class="avatar-upload">
            <div class="avatar-preview" *ngIf="avatarPreview || userForm.avatarUrl">
              <img [src]="avatarPreview || ('http://localhost:3001' + userForm.avatarUrl)" alt="avatar" />
            </div>
            <input type="file" accept="image/png,image/jpeg" (change)="onAvatarSelected($event)" />
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>{{ "Status" | translate }}</label>
          <nz-switch 
            name="isActive"
            [ngModelOptions]="{standalone: true}"
            [(ngModel)]="userForm.isActive"
            [nzCheckedChildren]="'Active'"
            [nzUnCheckedChildren]="'Inactive'">
          </nz-switch>
        </div>
      </div>
    </div>
    </ng-container>
  </nz-modal>

  <ng-template #modalFooter>
    <button nz-button (click)="isModalVisible = false">{{ 'Cancel' | translate }}</button>
    <button nz-button nzType="primary" (click)="handleSave()">{{ isEditMode ? ('Edit' | translate) : ('Add New User' | translate) }}</button>
  </ng-template>
</div>
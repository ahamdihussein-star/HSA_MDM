<h3 class="welcomeMessage">
  {{ "WelcomeBack" | translate }}, {{ currentUser?.fullName || "Compliance" }}!
  <img src="assets/img/waving.svg" alt="Welcome Icon" class="welcomeIcon" />
</h3>
<p class="subMessage">{{ "HereIsYourTasksForToday" | translate }}</p>

<!-- Main Content -->
<div>
  <div class="titleActionHolder">
    <!-- ✅ Removed page title for cleaner look -->

    <div class="actionHolderTitle">
      <!-- Clean header - only search and filter -->
      <div class="seachInputHolder">
        <img src="./assets/img/search.svg" alt="" />
        <input 
          type="text" 
          [placeholder]="'Search by name, tax, email...' | translate"
          [ngModel]="searchTerm"
          (ngModelChange)="onSearchChange($event)" />
      </div>
      <select
        [(ngModel)]="filterByRecordType"
        (change)="onFilterChange($event)"
        class="filter-select">
        <option value="">{{ 'All Record Types' | translate }}</option>
        <option *ngFor="let type of uniqueRecordTypes" [value]="type">{{ type }}</option>
      </select>
      <button (click)="clearFilters()" class="btn btn-primary">{{ 'Clear Filters' | translate }}</button>
    </div>
  </div>

  <!-- Statistics Summary - Always visible -->
  <div class="statistics-summary">
    <nz-statistic 
      [nzValue]="filterCounts.new"
      [nzTitle]="'New Requests' | translate"
      [nzValueStyle]="{ color: '#faad14' }">
      <span nz-icon nzType="plus" slot="prefix"></span>
    </nz-statistic>
    
    <nz-statistic 
      [nzValue]="filterCounts.quarantine"
      [nzTitle]="'Quarantine' | translate"
      [nzValueStyle]="{ color: '#fa8c16' }">
      <span nz-icon nzType="alert" slot="prefix"></span>
    </nz-statistic>
    
    <nz-statistic 
      [nzValue]="filterCounts.duplicate"
      [nzTitle]="'Duplicates' | translate"
      [nzValueStyle]="{ color: '#1890ff' }">
      <span nz-icon nzType="copy" slot="prefix"></span>
    </nz-statistic>
    
    <nz-statistic 
      [nzValue]="filterCounts.all"
      [nzTitle]="'Total Tasks' | translate"
      [nzValueStyle]="{ color: '#52c41a' }">
    </nz-statistic>
  </div>

  <!-- Table -->
  <nz-table #basicTable [nzPageSize]="7" [nzData]="taskList" class="smart-table">
    <thead>
      <tr>
        <th class="record-type-header">{{ 'Record Type' | translate }}</th>
        <th class="company-name-header">{{ 'Company Name' | translate }}</th>
        <th class="company-type-header">{{ 'Company Type' | translate }}</th>
        <th class="date-header">{{ 'Date' | translate }}</th>
        <th class="action-header">{{ 'Action' | translate }}</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let data of basicTable.data; let i = index" class="table-row">
        <!-- Record Type Column -->
        <td class="record-type-cell">
          <div class="record-type-info">
            <nz-tag [nzColor]="getOriginColor(data)" class="record-type-tag">
              {{ getOriginBadge(data) }}
            </nz-tag>
            <small class="record-type-detail">
              {{ getRequestTypeLabel(data) }}
            </small>
          </div>
        </td>

        <!-- Company Name -->
        <td class="company-name-cell">
          <div class="company-info">
            <div class="company-name">
              <strong>{{ data.firstName || data['name'] || '-' }}</strong>
              <div *ngIf="data.firstNameAr" class="company-name-ar">{{ data.firstNameAr }}</div>
            </div>
            <div *ngIf="data.tax" class="company-details">
              <span class="tax-number">
                <i nz-icon nzType="number"></i>
                Tax: {{ data.tax }}
              </span>
            </div>
          </div>
        </td>

        <!-- Company Type Column -->
        <td class="company-type-cell">
          <div class="company-type-info">
            <span class="company-type">{{ data['CustomerType'] || 'Customer Request' }}</span>
          </div>
        </td>

        <!-- Date -->
        <td class="date-cell">
          <span class="date-value">{{ data.createdAt | date:'MMM d, y' }}</span>
        </td>

        <!-- Actions - Unified "View Details" only -->
        <td class="action-cell">
          <button nz-button nzType="primary" nzGhost nzSize="small"
                  (click)="viewDetails(data)"
                  class="action-button">
            <span nz-icon nzType="eye"></span>
            {{ "View Details" | translate }}
          </button>
        </td>
      </tr>
    </tbody>
  </nz-table>

</div>

<!-- Approve Modal -->
<nz-modal
  [(nzVisible)]="isApproveModalVisible"
  [nzTitle]="'Process as Golden Record' | translate"
  [nzFooter]="approveFooter"
  [nzWidth]="520"
  (nzOnCancel)="cancelApprove()">
  
  <ng-container *nzModalContent>
    <div style="padding: 12px; background: #d1ecf1; border-left: 4px solid #0c5460; margin-bottom: 16px;">
      <strong style="color: #0c5460;">Golden Record Creation</strong>
      <p style="margin: 8px 0 0; color: #0c5460;">This record will become a Golden Record. Please choose the company status:</p>
    </div>
    
    <div *ngIf="currentRow" style="margin-bottom: 16px; padding: 12px; background: #f0f2f5; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <small><strong>Company:</strong> {{ currentRow.firstName }}</small>
        <nz-tag [nzColor]="getOriginColor(currentRow)">{{ getOriginBadge(currentRow) }}</nz-tag>
      </div>
      <small style="display:block">
        <strong>Type:</strong> {{ getRequestTypeLabel(currentRow) }}
      </small>
      <small *ngIf="currentRow.tax" style="display:block; margin-top:4px">
        <strong>Tax #:</strong> {{ currentRow.tax }}
      </small>
    </div>
    
    <div style="margin-top: 16px;">
      <label>{{ "Note (Optional):" | translate }}</label>
      <textarea
        nz-input
        [(ngModel)]="approveNote"
        [placeholder]="'Enter approval note...' | translate"
        rows="3"
        style="width: 100%; margin-top: 8px;">
      </textarea>
    </div>
  </ng-container>
  
  <ng-template #approveFooter>
    <button nz-button nzType="default" (click)="cancelApprove()">
      {{ 'Cancel' | translate }}
    </button>
    <button nz-button nzType="primary" (click)="processAsActive(currentRow ? [currentRow] : getSelectedRows())">
      <i nz-icon nzType="check-circle"></i>
      {{ 'Set as Active' | translate }}
    </button>
    <button nz-button nzDanger (click)="switchToBlockModal()">
      <i nz-icon nzType="stop"></i>
      {{ 'Set as Blocked' | translate }}
    </button>
  </ng-template>
</nz-modal>

<!-- Block Modal -->
<nz-modal
  [(nzVisible)]="isBlockModalVisible"
  [nzTitle]="'Block Golden Record' | translate"
  [nzOkText]="'Confirm Block' | translate"
  [nzCancelText]="'Cancel' | translate"
  [nzOkDanger]="true"
  [nzOkLoading]="loading"
  (nzOnOk)="confirmBlock()"
  (nzOnCancel)="cancelBlock()">
  
  <ng-container *nzModalContent>
    <div style="padding: 12px; background: #f8d7da; border-left: 4px solid #721c24; margin-bottom: 16px;">
      <strong style="color: #721c24;">Block Golden Record</strong>
      <p style="margin: 8px 0 0; color: #721c24;">This will create a blocked Golden Record. The company will not be able to transact.</p>
    </div>
    
    
    <div *ngIf="!currentRow && setOfCheckedId.size > 0" style="margin-bottom: 16px;">
      <div style="padding: 12px; background: #fff2e8; border-left: 4px solid #fa8c16;">
        <strong style="color: #fa8c16;">Bulk Block: {{ setOfCheckedId.size }} records selected</strong>
      </div>
    </div>
    
    <div style="margin-top: 16px;">
      <label style="color: #ff4d4f;">
        <span style="color: red;">*</span> {{ "Block Reason (Required):" | translate }}
      </label>
      <textarea
        nz-input
        [(ngModel)]="blockReason"
        [placeholder]="'Enter detailed reason for blocking this company...' | translate"
        rows="4"
        style="width: 100%; margin-top: 8px; border-color: #ff4d4f;"
        required>
      </textarea>
      <small style="color: #8c8c8c; display: block; margin-top: 4px;">
        This reason will be recorded in the audit trail and visible in reports.
      </small>
    </div>
  </ng-container>
</nz-modal>

<!-- Sanction Details Modal -->
<nz-modal
  [(nzVisible)]="isSanctionModalVisible"
  [nzTitle]="''"
  [nzWidth]="900"
  [nzFooter]="sanctionModalFooter"
  [nzBodyStyle]="{ padding: '0' }"
  (nzOnCancel)="closeSanctionModal()">
  <ng-container *nzModalContent>
    <div *ngIf="selectedSanction" class="sanction-modal-content">
      
      <!-- Header with Alert -->
      <div class="modal-header-alert">
        <div class="alert-icon">⚠️</div>
        <div class="alert-content">
          <h2 class="alert-title">Sanctioned Entity Detected</h2>
          <p class="alert-subtitle">This company is on international sanctions lists</p>
        </div>
      </div>

      <div class="modal-body-content">
        <!-- Company Header -->
        <div class="company-header">
          <div class="company-name-section">
            <h3 class="company-name">{{ selectedSanction.name }}</h3>
            <div class="company-meta">
              <span class="meta-item">
                <i nz-icon nzType="environment" nzTheme="outline"></i>
                {{ selectedSanction.country }}
              </span>
              <span class="meta-item" *ngIf="selectedSanction.city">
                <i nz-icon nzType="home" nzTheme="outline"></i>
                {{ selectedSanction.city }}
              </span>
            </div>
          </div>
          <div class="risk-badge-container">
            <nz-tag class="risk-badge-large" [nzColor]="selectedSanction.riskLevel === 'High' || selectedSanction.riskLevel === 'Critical' ? 'red' : 'orange'">
              <i nz-icon nzType="warning" nzTheme="fill"></i>
              {{ selectedSanction.riskLevel }} Risk
            </nz-tag>
          </div>
        </div>

        <!-- Info Cards Grid -->
        <div class="info-cards-grid">
          
          <!-- Basic Info Card -->
          <div class="info-card info-card-blue">
            <div class="info-card-header">
              <i nz-icon nzType="info-circle" nzTheme="fill"></i>
              <span>Basic Information</span>
            </div>
            <div class="info-card-body">
              <div class="info-row">
                <span class="info-label">Type:</span>
                <span class="info-value">{{ selectedSanction.type || 'N/A' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Sector:</span>
                <span class="info-value">{{ selectedSanction.sector }}</span>
              </div>
            </div>
          </div>

          <!-- Sanctions Info Card -->
          <div class="info-card info-card-red">
            <div class="info-card-header">
              <i nz-icon nzType="stop" nzTheme="fill"></i>
              <span>Sanctions Details</span>
            </div>
            <div class="info-card-body">
              <div class="info-row">
                <span class="info-label">Program:</span>
                <span class="info-value">{{ selectedSanction.sanctionProgram }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Start Date:</span>
                <span class="info-value">{{ selectedSanction.sanctionStartDate }}</span>
              </div>
            </div>
          </div>

        </div>

        <!-- Sanction Reason Box -->
        <div class="reason-box">
          <div class="reason-header">
            <i nz-icon nzType="file-text" nzTheme="outline"></i>
            <span>Sanction Reason</span>
          </div>
          <p class="reason-text">{{ selectedSanction.sanctionReason }}</p>
        </div>

        <!-- AI Analysis (if available) -->
        <div class="ai-analysis-box" *ngIf="selectedSanction.matchReason && selectedSanction.matchReason !== 'Exact match found in sanctions database'">
          <div class="ai-analysis-header">
            <i nz-icon nzType="bulb" nzTheme="fill"></i>
            <span>AI Analysis</span>
          </div>
          <p class="ai-analysis-text">{{ selectedSanction.matchReason }}</p>
          <div class="confidence-section">
            <span class="confidence-label">Match Confidence:</span>
            <nz-progress 
              [nzPercent]="selectedSanction.confidence || 95" 
              [nzStrokeColor]="'#52c41a'"
              [nzSize]="'default'"
              [nzShowInfo]="true">
            </nz-progress>
          </div>
        </div>

        <!-- Source Reference Link -->
        <div class="reference-box" *ngIf="selectedSanction.openSanctionsLink || selectedSanction.sourceUrl">
          <div class="reference-header">
            <i nz-icon nzType="link" nzTheme="outline"></i>
            <span>Official Source Reference</span>
          </div>
          <a 
            [href]="selectedSanction.openSanctionsLink || selectedSanction.sourceUrl" 
            target="_blank" 
            class="reference-link">
            <i nz-icon nzType="global" nzTheme="outline"></i>
            View on OpenSanctions
            <i nz-icon nzType="export" nzTheme="outline"></i>
          </a>
        </div>

      </div>

    </div>
  </ng-container>
  
  <ng-template #sanctionModalFooter>
    <button nz-button nzType="default" (click)="closeSanctionModal()">
      <i nz-icon nzType="close"></i>
      Close
    </button>
    <button nz-button nzType="primary" nzDanger (click)="blockCompanyFromModal()" *ngIf="selectedSanction && selectedSanction.requestId">
      <i nz-icon nzType="stop"></i>
      Block Company
    </button>
  </ng-template>
</nz-modal>

<!-- Compliance AI Agent Chat Widget -->
<app-compliance-chat-widget 
  (viewDetailsRequested)="openSanctionModal($event)"
  (taskListRefreshRequested)="refreshData()">
</app-compliance-chat-widget>
<h3 class="welcomeMessage">
  {{ "WelcomeBack" | translate }}, {{ "Compliance" | translate }}!
  <img src="assets/img/waving.svg" alt="Welcome Icon" class="welcomeIcon" />
</h3>
<p class="subMessage">{{ "HereIsYourTasksForToday" | translate }}</p>

<div class="titleActionHolder">
  <h1 class="pageTitle">{{ "Compliance Task List" | translate }}</h1>

  <div class="actionHolderTitle">
    <div class="seachInputHolder">
      <img src="./assets/img/search.svg" alt="" />
      <input
        type="text"
        [placeholder]="'Search by name, tax, email...' | translate"
        [ngModel]="searchTerm"
        (ngModelChange)="onSearchChange($event)"
      />
    </div>
    <select
      [(ngModel)]="filterByRecordType"
      (change)="onFilterChange($event)"
      class="filter-select">
      <option value="">{{ 'All Record Types' | translate }}</option>
      <option *ngFor="let type of uniqueRecordTypes" [value]="type">{{ type }}</option>
    </select>
    <button (click)="clearFilters()" class="btn btn-primary">{{ 'Clear Filters' | translate }}</button>
  </div>
</div>

<!-- Statistics Summary - Moved to top -->
<div *ngIf="taskList.length > 0" class="statistics-summary">
  <nz-statistic 
    [nzValue]="filterCounts.new"
    [nzTitle]="'New Requests' | translate"
    [nzValueStyle]="{ color: '#faad14' }">
    <span nz-icon nzType="plus" slot="prefix"></span>
  </nz-statistic>
  
  <nz-statistic 
    [nzValue]="filterCounts.quarantine"
    [nzTitle]="'Quarantine' | translate"
    [nzValueStyle]="{ color: '#fa8c16' }">
    <span nz-icon nzType="alert" slot="prefix"></span>
  </nz-statistic>
  
  <nz-statistic 
    [nzValue]="filterCounts.duplicate"
    [nzTitle]="'Duplicates' | translate"
    [nzValueStyle]="{ color: '#1890ff' }">
    <span nz-icon nzType="copy" slot="prefix"></span>
  </nz-statistic>
  
  <nz-statistic 
    [nzValue]="filterCounts.all"
    [nzTitle]="'Total Tasks' | translate"
    [nzValueStyle]="{ color: '#52c41a' }">
  </nz-statistic>
</div>

<!-- Table -->
<nz-table 
  #basicTable 
  [nzPageSize]="7" 
  [nzData]="filteredTaskList || []" 
  [nzLoading]="loading" 
  [nzScroll]="{ x: '1400px' }">
  
  <thead>
    <tr>
      <th style="min-width:120px">{{ 'Record Type' | translate }}</th>
      <th style="min-width:200px">{{ 'Company Name' | translate }}</th>
      <th style="min-width:140px">{{ 'Company Type' | translate }}</th>
      <th style="min-width:100px">{{ 'Date' | translate }}</th>
      <th style="min-width:120px">{{ 'Action' | translate }}</th>
    </tr>
  </thead>

  <tbody>
    <!-- Empty state row -->
    <tr *ngIf="!loading && (!filteredTaskList || filteredTaskList.length === 0)">
      <td colspan="5" style="text-align: center; padding: 40px;">
        <nz-empty [nzNotFoundContent]="'No tasks pending compliance review' | translate"></nz-empty>
      </td>
    </tr>
    
    <!-- Data rows -->
    <tr *ngFor="let row of basicTable.data">
      <!-- Record Type Column -->
      <td>
        <div style="display:flex; flex-direction:column; gap:4px;">
          <nz-tag [nzColor]="getOriginColor(row)">
            {{ getOriginBadge(row) }}
          </nz-tag>
          <small style="opacity:.7; font-size:11px">
            {{ getRequestTypeLabel(row) }}
          </small>
        </div>
      </td>
      
      <!-- Company Name -->
      <td>
        <div style="display:flex; flex-direction:column;">
          <strong>{{ row.firstName || 'غير محدد' }}</strong>
          <small *ngIf="row.firstNameAr" style="opacity:.7">{{ row.firstNameAr }}</small>
          <small *ngIf="row.tax" style="opacity:.7; margin-top:2px">
            <i nz-icon nzType="number" style="margin-right:2px"></i>
            Tax: {{ row.tax }}
          </small>
        </div>
      </td>
      
      <!-- Company Type Column -->
      <td>
        <nz-tag [nzColor]="'default'">
          {{ getCustomerTypeLabel(row.customerType || '') }}
        </nz-tag>
      </td>
      
      <!-- Date -->
      <td>{{ formatDate(row.submittedAt) }}</td>
      
      <!-- Actions - Only Review button -->
      <td>
        <div style="display: flex; gap: 8px;">
          <button nz-button nzType="primary" nzSize="small" (click)="viewDetails(row)">
            <i nz-icon nzType="eye"></i>
            {{ "View Details" | translate }}
          </button>
        </div>
      </td>
    </tr>
  </tbody>
</nz-table>

<!-- Approve Modal -->
<nz-modal
  [(nzVisible)]="isApproveModalVisible"
  [nzTitle]="'Process as Golden Record' | translate"
  [nzFooter]="approveFooter"
  [nzWidth]="520"
  (nzOnCancel)="cancelApprove()">
  
  <ng-container *nzModalContent>
    <div style="padding: 12px; background: #d1ecf1; border-left: 4px solid #0c5460; margin-bottom: 16px;">
      <strong style="color: #0c5460;">Golden Record Creation</strong>
      <p style="margin: 8px 0 0; color: #0c5460;">This record will become a Golden Record. Please choose the company status:</p>
    </div>
    
    <div *ngIf="currentRow" style="margin-bottom: 16px; padding: 12px; background: #f0f2f5; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <small><strong>Company:</strong> {{ currentRow.firstName }}</small>
        <nz-tag [nzColor]="getOriginColor(currentRow)">{{ getOriginBadge(currentRow) }}</nz-tag>
      </div>
      <small style="display:block">
        <strong>Type:</strong> {{ getRequestTypeLabel(currentRow) }}
      </small>
      <small *ngIf="currentRow.tax" style="display:block; margin-top:4px">
        <strong>Tax #:</strong> {{ currentRow.tax }}
      </small>
    </div>
    
    <div style="margin-top: 16px;">
      <label>{{ "Note (Optional):" | translate }}</label>
      <textarea
        nz-input
        [(ngModel)]="approveNote"
        [placeholder]="'Enter approval note...' | translate"
        rows="3"
        style="width: 100%; margin-top: 8px;">
      </textarea>
    </div>
  </ng-container>
  
  <ng-template #approveFooter>
    <button nz-button nzType="default" (click)="cancelApprove()">
      {{ 'Cancel' | translate }}
    </button>
    <button nz-button nzType="primary" (click)="processAsActive(currentRow ? [currentRow] : getSelectedRows())">
      <i nz-icon nzType="check-circle"></i>
      {{ 'Set as Active' | translate }}
    </button>
    <button nz-button nzDanger (click)="switchToBlockModal()">
      <i nz-icon nzType="stop"></i>
      {{ 'Set as Blocked' | translate }}
    </button>
  </ng-template>
</nz-modal>

<!-- Block Modal -->
<nz-modal
  [(nzVisible)]="isBlockModalVisible"
  [nzTitle]="'Block Golden Record' | translate"
  [nzOkText]="'Confirm Block' | translate"
  [nzCancelText]="'Cancel' | translate"
  [nzOkDanger]="true"
  [nzOkLoading]="loading"
  (nzOnOk)="confirmBlock()"
  (nzOnCancel)="cancelBlock()">
  
  <ng-container *nzModalContent>
    <div style="padding: 12px; background: #f8d7da; border-left: 4px solid #721c24; margin-bottom: 16px;">
      <strong style="color: #721c24;">Block Golden Record</strong>
      <p style="margin: 8px 0 0; color: #721c24;">This will create a blocked Golden Record. The company will not be able to transact.</p>
    </div>
    
    
    <div *ngIf="!currentRow && setOfCheckedId.size > 0" style="margin-bottom: 16px;">
      <div style="padding: 12px; background: #fff2e8; border-left: 4px solid #fa8c16;">
        <strong style="color: #fa8c16;">Bulk Block: {{ setOfCheckedId.size }} records selected</strong>
      </div>
    </div>
    
    <div style="margin-top: 16px;">
      <label style="color: #ff4d4f;">
        <span style="color: red;">*</span> {{ "Block Reason (Required):" | translate }}
      </label>
      <textarea
        nz-input
        [(ngModel)]="blockReason"
        [placeholder]="'Enter detailed reason for blocking this company...' | translate"
        rows="4"
        style="width: 100%; margin-top: 8px; border-color: #ff4d4f;"
        required>
      </textarea>
      <small style="color: #8c8c8c; display: block; margin-top: 4px;">
        This reason will be recorded in the audit trail and visible in reports.
      </small>
    </div>
  </ng-container>
</nz-modal>
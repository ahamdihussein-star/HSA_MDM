# üìö Session Management API Documentation

## üóÑÔ∏è **Database Schema**

### **1Ô∏è‚É£ `session_staging` Table**
ÿ¨ÿØŸàŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ŸÑŸÑÿ¥ÿ±ŸÉÿ© ŸÅŸä ÿßŸÑŸÄ Session

```sql
CREATE TABLE IF NOT EXISTS session_staging (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  company_id TEXT NOT NULL,
  company_name TEXT NOT NULL,
  
  -- Company Basic Info
  first_name TEXT,
  first_name_ar TEXT,
  tax_number TEXT,
  customer_type TEXT,
  company_owner TEXT,
  
  -- Address Info
  building_number TEXT,
  street TEXT,
  country TEXT,
  city TEXT,
  
  -- Document Content for parsing
  document_content TEXT,
  
  -- Sales Info
  sales_org TEXT,
  distribution_channel TEXT,
  division TEXT,
  
  -- Additional Info
  registration_number TEXT,
  legal_form TEXT,
  
  -- Metadata
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(session_id, company_id)
);
```

**ŸÖŸÑÿßÿ≠ÿ∏ÿ©:** `UNIQUE(session_id, company_id)` Ÿäÿ∂ŸÖŸÜ ÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ¥ÿ±ŸÉÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÄ Session

---

### **2Ô∏è‚É£ `session_documents` Table**
ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ©

```sql
CREATE TABLE IF NOT EXISTS session_documents (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  company_id TEXT NOT NULL,
  document_name TEXT NOT NULL,
  document_content TEXT NOT NULL,  -- Base64 encoded
  document_type TEXT NOT NULL,     -- MIME type (e.g., image/png)
  document_size INTEGER NOT NULL,  -- File size in bytes
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(session_id, company_id, document_name)
);
```

**ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:**
- `document_content`: Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑŸÖŸÑŸÅ ÿ®ÿµŸäÿ∫ÿ© Base64 (ÿ®ÿØŸàŸÜ ÿßŸÑŸÄ `data:` prefix)
- `UNIQUE(session_id, company_id, document_name)`: ŸäŸÖŸÜÿπ ÿ™ŸÉÿ±ÿßÿ± ŸÜŸÅÿ≥ ÿßŸÑŸÖŸÑŸÅ

---

### **3Ô∏è‚É£ `session_contacts` Table**
ÿ¨ÿØŸàŸÑ ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ

```sql
CREATE TABLE IF NOT EXISTS session_contacts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  company_id TEXT NOT NULL,
  contact_name TEXT NOT NULL,
  contact_email TEXT,
  contact_phone TEXT,
  contact_position TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## üîå **API Endpoints**

### **1Ô∏è‚É£ POST `/api/session/save-company`**

**ÿßŸÑŸàÿµŸÅ:** ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ© ŸàÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ŸÅŸä ÿßŸÑŸÄ Session

**Request Body:**
```json
{
  "sessionId": "session_1760119266083_2upiyx818",
  "companyId": "americana_foods",
  "companyName": "Americana Foods",
  "firstName": "Americana Foods",
  "firstNameAr": "",
  "taxNumber": "3787409068",
  "customerType": "joint_stock",
  "companyOwner": "Dina Taha",
  "buildingNumber": "1075",
  "street": "Al-Qasr Street",
  "country": "Egypt",
  "city": "Luxor",
  "documentContent": "",
  "salesOrg": "",
  "distributionChannel": "",
  "division": "",
  "registrationNumber": "EG-6492342",
  "legalForm": "",
  "documents": [
    {
      "name": "Commercial_Registration.png",
      "content": "iVBORw0KGgoAAAANSUhEUgAA...",  // Base64 ÿ®ÿØŸàŸÜ prefix
      "type": "image/png",
      "size": 145236
    }
  ],
  "contacts": [
    {
      "name": "Ahmed Ali",
      "email": "ahmed@example.com",
      "phone": "+20123456789",
      "position": "Manager"
    }
  ]
}
```

**Backend Code:**
```javascript
app.post('/api/session/save-company', (req, res) => {
  const { 
    sessionId, companyId, companyName,
    firstName, firstNameAr, taxNumber, customerType, companyOwner,
    buildingNumber, street, country, city, documentContent,
    salesOrg, distributionChannel, division,
    registrationNumber, legalForm,
    documents, contacts
  } = req.body;
  
  try {
    // 1Ô∏è‚É£ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ© ŸÅŸä session_staging
    const stmt = db.prepare(`
      INSERT OR REPLACE INTO session_staging 
      (session_id, company_id, company_name, first_name, first_name_ar, 
       tax_number, customer_type, company_owner, building_number, street, 
       country, city, document_content, sales_org, distribution_channel, division, 
       registration_number, legal_form, updated_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `);
    
    stmt.run(sessionId, companyId, companyName, firstName, firstNameAr, 
        taxNumber, customerType, companyOwner, buildingNumber, street, 
        country, city, documentContent, salesOrg, distributionChannel, division,
        registrationNumber, legalForm);
    
    // 2Ô∏è‚É£ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ŸÅŸä session_documents
    if (documents && documents.length > 0) {
      // ‚úÖ CRITICAL FIX: ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ£ŸàŸÑÿßŸã
      const deleteStmt = db.prepare(`
        DELETE FROM session_documents 
        WHERE session_id = ? AND company_id = ?
      `);
      deleteStmt.run(sessionId, companyId);
      
      // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
      const docStmt = db.prepare(`
        INSERT INTO session_documents 
        (session_id, company_id, document_name, document_content, document_type, document_size)
        VALUES (?, ?, ?, ?, ?, ?)
      `);
      
      for (const doc of documents) {
        if (!doc.content || doc.content.trim() === '') {
          console.warn(`‚ö†Ô∏è Skipping document with empty content: ${doc.name}`);
          continue;
        }
        docStmt.run(sessionId, companyId, doc.name, doc.content, doc.type, doc.size);
      }
    }
    
    // 3Ô∏è‚É£ ÿ≠ŸÅÿ∏ ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÅŸä session_contacts
    if (contacts && contacts.length > 0) {
      const deleteStmt = db.prepare(`DELETE FROM session_contacts WHERE session_id = ? AND company_id = ?`);
      deleteStmt.run(sessionId, companyId);
      
      const contactStmt = db.prepare(`
        INSERT INTO session_contacts 
        (session_id, company_id, contact_name, contact_email, contact_phone, contact_position)
        VALUES (?, ?, ?, ?, ?, ?)
      `);
      
      for (const contact of contacts) {
        contactStmt.run(sessionId, companyId, contact.name, contact.email, contact.phone, contact.position);
      }
    }
    
    res.json({ success: true });
  } catch (error) {
    console.error('‚ùå Error saving company data:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**Response:**
```json
{
  "success": true
}
```

**Console Logs (ÿπŸÜÿØ ÿßŸÑŸÜÿ¨ÿßÿ≠):**
```
üèõÔ∏è [SESSION] Saving company data: {sessionId, companyId, companyName, documentsCount: 1}
üìÑ [SESSION] Saving documents: 1
üìÑ [SESSION] Document names: ["Commercial_Registration.png"]
üóëÔ∏è [SESSION] Cleared 1 existing documents
üìÑ [SESSION] Saving document "Commercial_Registration.png" (145236 bytes, content starts with: iVBORw0KGgoAAAAN...)
‚úÖ [SESSION] Document saved: Commercial_Registration.png
‚úÖ [SESSION] Total documents saved: 1/1
‚úÖ [SESSION] Contacts saved: 1
‚úÖ [SESSION] All data saved successfully
```

---

### **2Ô∏è‚É£ GET `/api/session/company/:sessionId/:companyId`**

**ÿßŸÑŸàÿµŸÅ:** ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ© ŸàÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ŸÖŸÜ ÿßŸÑŸÄ Session

**URL Parameters:**
- `sessionId`: Session ID (e.g., `session_1760119266083_2upiyx818`)
- `companyId`: Company ID (e.g., `americana_foods`)

**Example Request:**
```
GET /api/session/company/session_1760119266083_2upiyx818/americana_foods
```

**Backend Code:**
```javascript
app.get('/api/session/company/:sessionId/:companyId', (req, res) => {
  try {
    // 1Ô∏è‚É£ Get company data from session_staging
    const company = db.prepare(`
      SELECT * FROM session_staging 
      WHERE session_id = ? AND company_id = ?
    `).get(req.params.sessionId, req.params.companyId);
    
    if (!company) {
      return res.status(404).json({ error: 'Company not found' });
    }
    
    // 2Ô∏è‚É£ Get documents from session_documents
    const documents = db.prepare(`
      SELECT document_name, document_content, document_type, document_size, created_at
      FROM session_documents 
      WHERE session_id = ? AND company_id = ?
    `).all(req.params.sessionId, req.params.companyId);
    
    // 3Ô∏è‚É£ Get contacts from session_contacts
    const contacts = db.prepare(`
      SELECT contact_name, contact_email, contact_phone, contact_position
      FROM session_contacts 
      WHERE session_id = ? AND company_id = ?
    `).all(req.params.sessionId, req.params.companyId);
    
    // 4Ô∏è‚É£ Combine all data
    const response = {
      ...company,
      documents,
      contacts
    };
    
    res.json(response);
  } catch (error) {
    console.error('‚ùå Error getting company data:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**Response:**
```json
{
  "id": 1,
  "session_id": "session_1760119266083_2upiyx818",
  "company_id": "americana_foods",
  "company_name": "Americana Foods",
  "first_name": "Americana Foods",
  "first_name_ar": "",
  "tax_number": "3787409068",
  "customer_type": "joint_stock",
  "company_owner": "Dina Taha",
  "building_number": "1075",
  "street": "Al-Qasr Street",
  "country": "Egypt",
  "city": "Luxor",
  "document_content": "",
  "sales_org": "",
  "distribution_channel": "",
  "division": "",
  "registration_number": "EG-6492342",
  "legal_form": "",
  "created_at": "2025-01-10 12:34:56",
  "updated_at": "2025-01-10 12:34:56",
  "documents": [
    {
      "document_name": "Commercial_Registration.png",
      "document_content": "iVBORw0KGgoAAAANSUhEUgAA...",
      "document_type": "image/png",
      "document_size": 145236,
      "created_at": "2025-01-10 12:34:56"
    }
  ],
  "contacts": [
    {
      "contact_name": "Ahmed Ali",
      "contact_email": "ahmed@example.com",
      "contact_phone": "+20123456789",
      "contact_position": "Manager"
    }
  ]
}
```

**Console Logs (ÿπŸÜÿØ ÿßŸÑŸÜÿ¨ÿßÿ≠):**
```
üìã [GET SESSION] Request params: {sessionId: "session_xxx", companyId: "americana_foods"}
‚úÖ [GET SESSION] Company data found: Americana Foods
üìÑ [GET SESSION] Documents found: 1
üìÑ [GET SESSION] Document 1: Commercial_Registration.png (193648 chars, starts with: iVBORw0KGgoAAAAN...)
üë• [GET SESSION] Contacts found: 1
‚úÖ [GET SESSION] Sending response with 1 documents and 1 contacts
```

---

### **3Ô∏è‚É£ DELETE `/api/session/:sessionId`**

**ÿßŸÑŸàÿµŸÅ:** ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÄ Session

**URL Parameters:**
- `sessionId`: Session ID to delete

**Example Request:**
```
DELETE /api/session/session_1760119266083_2upiyx818
```

**Backend Code:**
```javascript
app.delete('/api/session/:sessionId', (req, res) => {
  try {
    db.prepare(`DELETE FROM session_staging WHERE session_id = ?`).run(req.params.sessionId);
    db.prepare(`DELETE FROM session_documents WHERE session_id = ?`).run(req.params.sessionId);
    db.prepare(`DELETE FROM session_contacts WHERE session_id = ?`).run(req.params.sessionId);
    
    res.json({ success: true });
  } catch (error) {
    console.error('Error clearing session:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**Response:**
```json
{
  "success": true
}
```

---

## üîÑ **Data Flow**

### **ÿπŸÜÿØ Upload ŸÖÿ≥ÿ™ŸÜÿØ ÿ¨ÿØŸäÿØ:**

```
1Ô∏è‚É£ User uploads file
    ‚Üì
2Ô∏è‚É£ Frontend converts to Base64
    ‚Üì
3Ô∏è‚É£ Frontend sends to OpenAI for extraction
    ‚Üì
4Ô∏è‚É£ OpenAI returns extracted data (8 fields only)
    ‚Üì
5Ô∏è‚É£ Frontend maps data to system format
    ‚Üì
6Ô∏è‚É£ Frontend calls POST /api/session/save-company
    ‚Üì
7Ô∏è‚É£ Backend deletes old documents (if any)
    ‚Üì
8Ô∏è‚É£ Backend saves new document in session_documents
    ‚Üì
9Ô∏è‚É£ Backend saves company data in session_staging
    ‚Üì
üîü Backend saves contacts in session_contacts
```

### **ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÄ Modal:**

```
1Ô∏è‚É£ User opens modal
    ‚Üì
2Ô∏è‚É£ Frontend calls GET /api/session/company/:sessionId/:companyId
    ‚Üì
3Ô∏è‚É£ Backend retrieves data from session_staging
    ‚Üì
4Ô∏è‚É£ Backend retrieves documents from session_documents
    ‚Üì
5Ô∏è‚É£ Backend retrieves contacts from session_contacts
    ‚Üì
6Ô∏è‚É£ Backend combines all data and returns
    ‚Üì
7Ô∏è‚É£ Frontend displays in modal
    ‚Üì
8Ô∏è‚É£ Frontend converts Base64 back to File for preview
```

---

## üîç **Key Points**

### **1Ô∏è‚É£ Document Storage:**
- **Format:** Base64 (ÿ®ÿØŸàŸÜ `data:` prefix)
- **Location:** `session_documents.document_content`
- **Storage Logic:** **ŸäŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÇÿ®ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ÿØŸäÿØÿ©**

### **2Ô∏è‚É£ Session Management:**
- **Session ID:** Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØŸá ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ¨ŸÑÿ≥ÿ©
- **Company ID:** Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØŸá ŸÖŸÜ ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ© (e.g., `americana_foods`)
- **Uniqueness:** `UNIQUE(session_id, company_id)` ŸÅŸä ŸÉŸÑ ÿßŸÑÿ¨ÿØÿßŸàŸÑ

### **3Ô∏è‚É£ Critical Fix:**
```javascript
// ‚úÖ BEFORE SAVING: ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
const deleteStmt = db.prepare(`
  DELETE FROM session_documents 
  WHERE session_id = ? AND company_id = ?
`);
deleteStmt.run(sessionId, companyId);

// ‚úÖ THEN: ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
docStmt.run(sessionId, companyId, doc.name, doc.content, doc.type, doc.size);
```

Ÿáÿ∞ÿß Ÿäÿ∂ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ ŸáŸà **ÿØÿßÿ¶ŸÖÿßŸã ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑÿ£ÿÆŸäÿ± ÿßŸÑŸÖÿ±ŸÅŸàÿπ**.

---

## üìä **Example Data Flow**

### **Scenario: User uploads Commercial_Registration.png**

**1Ô∏è‚É£ Frontend ‚Üí Backend (POST):**
```json
{
  "sessionId": "session_xxx",
  "companyId": "americana_foods",
  "documents": [
    {
      "name": "Commercial_Registration.png",
      "content": "iVBORw0KGgoAAAA...", // 193648 chars
      "type": "image/png",
      "size": 145236
    }
  ]
}
```

**2Ô∏è‚É£ Backend ‚Üí Database:**
```sql
-- ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
DELETE FROM session_documents WHERE session_id = 'session_xxx' AND company_id = 'americana_foods';

-- ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑÿ¨ÿØŸäÿØ
INSERT INTO session_documents 
(session_id, company_id, document_name, document_content, document_type, document_size)
VALUES ('session_xxx', 'americana_foods', 'Commercial_Registration.png', 'iVBORw0KGgoAAAA...', 'image/png', 145236);
```

**3Ô∏è‚É£ Backend ‚Üí Frontend (GET):**
```json
{
  "documents": [
    {
      "document_name": "Commercial_Registration.png",
      "document_content": "iVBORw0KGgoAAAA...", // ŸÜŸÅÿ≥ ÿßŸÑŸÄ Base64 ÿßŸÑÿ£ÿµŸÑŸä
      "document_type": "image/png",
      "document_size": 145236
    }
  ]
}
```

**4Ô∏è‚É£ Frontend Display:**
```typescript
// ÿ™ÿ≠ŸàŸäŸÑ Base64 ÿ•ŸÑŸâ Data URL ŸÑŸÑÿπÿ±ÿ∂
const dataUrl = `data:${doc.document_type};base64,${doc.document_content}`;

// ÿπÿ±ÿ∂ ŸÅŸä Modal
<img [src]="dataUrl" />
```

---

## ‚úÖ **ÿßŸÑÿÆŸÑÿßÿµÿ©**

- **Backend Ÿäÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ŸÉŸÖÿß ŸáŸà** (Base64 ÿ®ÿØŸàŸÜ `data:` prefix)
- **ŸäŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÇÿ®ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ÿØŸäÿØÿ©** (Fix ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä)
- **GET endpoint Ÿäÿ±ÿ¨ÿπ ŸÜŸÅÿ≥ ÿßŸÑŸÄ Base64 ÿßŸÑÿ£ÿµŸÑŸä**
- **Frontend Ÿäÿ≠ŸàŸÑ Base64 ÿ•ŸÑŸâ Data URL ŸÑŸÑÿπÿ±ÿ∂**

Ÿáÿ∞ÿß Ÿäÿ∂ŸÖŸÜ ÿ£ŸÜ **ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ = ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑŸÖÿ±ŸÅŸàÿπ** ÿØÿßÿ¶ŸÖÿßŸã! ‚úÖ

